<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>HPC/AI Project Planner — single‑file, offline (Light · v8 UI/UX)</title>
<style>
  :root{
    color-scheme: light;
    --bg:#ffffff; --panel:#f8fafc; --ink:#0b1220; --muted:#64748b; --line:#e5e7eb;
    --accent:#0ea5e9; --warn:#b45309; --error:#b91c1c; --ok:#047857; --crit:#dc2626; --info:#0369a1;
    --pwr:#ef4444; --pcie:#f59e0b; --bmc:#06b6d4; --bios:#8b5cf6; --fw:#3b82f6; --mech:#10b981; --thermal:#22c55e; --sys:#a855f7;
    --shadow: 0 6px 18px rgba(2,6,23,.08);
  }
  html,body{height:100%}
  body{margin:0; font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, Noto Sans; background:var(--bg); color:var(--ink)}
  header{display:flex; align-items:center; gap:.5rem; padding:.65rem 1rem; background:#fff; position:sticky; top:0; z-index:3; box-shadow:var(--shadow); border-bottom:1px solid var(--line)}
  header h1{font-size:1.05rem; margin:0; letter-spacing:.3px}
  header .badges{display:flex; gap:.5rem; opacity:.9}
  header .right{margin-left:auto; display:flex; gap:.5rem; align-items:center}
  .btn{background:#fff; color:var(--ink); border:1px solid #cbd5e1; padding:.4rem .65rem; border-radius:.6rem; cursor:pointer; box-shadow:var(--shadow)}
  .btn:hover{background:#f1f5f9}
  .btn.ghost{background:#f8fafc; border-color:#dde6ee}
  .btn.warn{border-color:var(--warn); color:var(--warn)}
  .btn.accent{border-color:var(--accent); color:var(--accent)}
  .btn.error{border-color:var(--error); color:var(--error)}
  .btn.small{padding:.28rem .5rem; font-size:.9rem}
  .pill{border:1px solid var(--line); border-radius:999px; padding:.2rem .55rem}
  .layout{display:grid; grid-template-columns: 380px 1fr; gap:1rem; padding:1rem}
  aside{background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:1rem; position:sticky; top:70px; height: calc(100vh - 90px); overflow:auto}
  aside h2{font-size:.9rem; color:var(--muted); text-transform:uppercase; letter-spacing:.1em; margin:1rem 0 .35rem}
  aside label, aside .row{display:flex; align-items:center; justify-content:space-between; gap:.5rem; padding:.25rem 0}
  input[type="date"], select, input[type="number"], input[type="text"], textarea{background:#fff; color:var(--ink); border:1px solid #cbd5e1; border-radius:.5rem; padding:.35rem .5rem}
  textarea{width:100%; min-height:58px; font:inherit}
  input[type="checkbox"]{transform:scale(1.1)}
  .subsys{display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:.35rem .5rem}
  .tag{display:inline-flex; align-items:center; gap:.4rem; padding:.2rem .45rem; border-radius:.6rem; border:1px solid var(--line); font-size:.8rem; background:#fff; cursor:pointer}
  .tag input{margin-right:.25rem}
  .dot{width:.7rem; height:.7rem; border-radius:999px; display:inline-block}
  .dot.pwr{background:var(--pwr)} .dot.pcie{background:var(--pcie)} .dot.bmc{background:var(--bmc)} .dot.bios{background:var(--bios)} .dot.fw{background:var(--fw)} .dot.mech{background:var(--mech)} .dot.thermal{background:var(--thermal)} .dot.sys{background:var(--sys)}
  main{background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:0; min-height:60vh; overflow:hidden; position:relative}
  .tabs{display:flex; gap:.5rem; border-bottom:1px solid var(--line); background:#f8fafc; position:sticky; top:0; z-index:2}
  .tab{padding:.6rem .8rem; cursor:pointer; user-select:none}
  .tab.active{border-bottom:2px solid var(--accent); color:var(--accent)}
  .view{display:none; padding:0}
  .view.active{display:block}
  #graph svg, #timeline svg{width:100%; height:72vh; display:block; background:radial-gradient(1200px 800px at 60% -20%, rgba(14,165,233,.08), transparent 60%)}
  .legend{display:flex; gap:.5rem; padding:.5rem .75rem; border-bottom:1px solid var(--line); align-items:center; color:var(--muted); flex-wrap:wrap}
  .legend .group{display:flex; gap:.35rem; align-items:center}
  .node{cursor:pointer}
  .node rect{fill:#fff; stroke:#cbd5e1; rx:8}
  .node.critical rect{stroke:var(--crit); stroke-width:2; fill:#fee2e2}
  .node.selected rect{stroke:#0ea5e9; stroke-width:2}
  .node .title{font-weight:600}
  .edge{stroke:#cbd5e1; stroke-width:1.5}
  .edge.critical{stroke:var(--crit); stroke-width:2}
  .edge.arrow{marker-end:url(#arrow)}
  .gantt .bar{stroke:#cbd5e1; fill:#e2e8f0}
  .gantt .bar.critical rect{stroke:var(--crit); stroke-width:2; fill:#fee2e2}
  .gantt .bar.selected rect{stroke:#0ea5e9; stroke-width:2}
  .gantt .bar .label{font-size:11px; fill:#334155}
  .gantt .handle{fill:#94a3b8; cursor:ew-resize}
  .gantt .bar.moved{filter:drop-shadow(0 0 10px rgba(14,165,233,.35))}
  .gantt .bar.invalid rect{stroke:var(--error) !important; fill:#fee2e2}
  .gantt .bar.valid rect{outline:2px solid #86efac}
  .gantt .milestone{stroke-width:2; fill:#fff}
  .gantt .milestone.critical{fill:#fee2e2; stroke:var(--crit)}
  .gantt .bar .progress{opacity:.5}
  .axis{stroke:#e5e7eb}
  .axis text{fill:#475569; font-size:11px}
  .issues{display:flex; flex-direction:column; gap:.45rem}
  .issue{display:grid; grid-template-columns: 1fr auto; align-items:center; gap:.5rem; background:#fff; border:1px solid var(--line); border-left-width:4px; border-radius:.6rem; padding:.5rem .55rem}
  .sev-info{border-left-color:var(--info)}
  .sev-warn{border-left-color:var(--warn)}
  .sev-error{border-left-color:var(--error)}
  .sev-critical{border-left-color:var(--crit)}
  .issue .meta{font-size:.85rem; color:#64748b}
  .issue .msg{font-weight:600}
  .issue .actions{display:flex; gap:.35rem}
  .focus{padding:1rem}
  .focus h3{margin:.2rem 0 .5rem; color:#2563eb}
  .focus .cards{display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:.7rem}
  .card{background:#fff; border:1px solid var(--line); border-radius:12px; padding:.7rem}
  .metric{font-size:1.3rem; font-weight:700}
  .list{display:grid; gap:.35rem; max-height:45vh; overflow:auto}
  .list .row{display:flex; gap:.5rem; align-items:center; justify-content:space-between; padding:.35rem .5rem; border-bottom:1px dashed var(--line)}
  .row .slack{font-variant-numeric:tabular-nums}
  .kbd{padding:.12rem .35rem; border:1px solid #cbd5e1; border-bottom-width:2px; background:#f8fafc; border-radius:.35rem; font-size:.8rem; color:#334155}
  .hint{position:fixed; z-index:10; background:#fff; border:1px solid #fde68a; box-shadow:var(--shadow); border-radius:.5rem; padding:.25rem .4rem; font-size:.85rem; color:#7a5d00; display:none}
  .toast{position:fixed; right:14px; bottom:14px; background:#fff; border:1px solid #cbd5e1; box-shadow:var(--shadow); padding:.5rem .7rem; border-radius:.6rem; color:#0b1220; display:none}
  #timeline{position:relative}
  .mini-map{position:absolute; right:10px; bottom:10px; width:200px; height:60px; border:1px solid #cbd5e1; background:#fff; opacity:.9}
  .ctx-menu{position:fixed; display:none; background:#fff; border:1px solid #cbd5e1; box-shadow:var(--shadow); border-radius:.5rem; z-index:1000}
  .ctx-menu div{padding:.35rem .7rem; cursor:pointer}
  .ctx-menu div:hover{background:#f1f5f9}

  .toolbar{display:flex; gap:.35rem; align-items:center}
  .groupHeader{fill:#f1f5f9; stroke:#e2e8f0}
  .groupLabel{font-size:12px; fill:#475569}

  .bulk{display:grid; gap:.5rem}
  .bulk .row{display:grid; grid-template-columns: 1fr 1fr; gap:.5rem}
  .bulk .row-3{grid-template-columns: 1fr 1fr 1fr}

  .inline-edit{display:grid; gap:.35rem}
  .inline-edit .row{display:grid; grid-template-columns:1fr 60px 1fr 1fr 60px; gap:.35rem; align-items:center}

  /* Modal */
  .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(2,6,23,0.45)}
  .modal .panel{background:#fff; border:1px solid var(--line); border-radius:12px; box-shadow:var(--shadow); width:min(880px, 94vw); max-height:85vh; overflow:auto}
  .modal header{position:sticky; top:0; box-shadow:none}
  .wizard-step{padding:1rem}
  .wizard-controls{display:flex; justify-content:flex-end; gap:.5rem; padding:0 1rem 1rem}

  /* Print */
  @media print{
    header, aside, .tabs, #timeline, #graph, #compare, .badges{display:none !important}
    main{border:none}
    .view#focus{display:block !important}
    body{background:white; color:black}
    .card, .list .row{border-color:#e5e7eb}
  }
</style>
</head>
<body>
  <header>
    <h1>HPC/AI Project Planner <small style="color:var(--muted); font-weight:400">— offline • single file</small></h1>
    <button class="btn" id="btnNew">New</button>
    <button class="btn" id="btnLoad">Open…</button>
    <button class="btn" id="btnSave">Save</button>
    <button class="btn ghost" id="btnExportJSON">Export JSON</button>
    <button class="btn ghost" id="btnExportCSV">Export CSV</button>
    <button class="btn small" id="btnUndo" title="Ctrl+Z">Undo</button>
    <button class="btn small" id="btnRedo" title="Ctrl+Y">Redo</button>
    <button class="btn accent" id="btnPrint">Print / PDF</button>
    <button class="btn" id="btnGuide">Guide</button>
    <div class="right">
      <span class="pill" id="selBadge">0 selected</span>
      <span class="pill" id="scenarioBadge">Scenario: Working</span>
      <div class="badges">
        <span class="pill">Light</span>
        <span class="pill">Enhanced CPM</span>
        <span class="pill">Scenarios + Undo</span>
        <span class="pill">Validation & Fixes</span>
        <span class="pill">UI/UX</span>
      </div>
    </div>
  </header>
  <div id="boot">Loading app… If this persists, press F12 → Console and share any red error message.</div>
  <div id="fatal"></div>
  <div class="layout" style="display:none" id="appRoot">
    <aside>
      <h2>Project</h2>
      <div class="row"><label>Start date <input type="date" id="startDate"></label></div>
      <div class="row"><label>Calendar
        <select id="calendarMode">
          <option value="workdays">Working days (Mon–Fri + holidays)</option>
          <option value="calendar">Calendar days</option>
        </select></label>
      </div>
      <div class="row" style="align-items:flex-start">
        <label style="flex-direction:column; align-items:flex-start; gap:.4rem; width:100%">Holidays (YYYY‑MM‑DD)
          <textarea id="holidayInput" placeholder="2025-01-01, 2025-05-01, 2025-12-25"></textarea>
        </label>
      </div>
      <div class="row"><label>Slack threshold <input type="number" id="slackThreshold" min="0" value="2"> days</label></div>

      <h2>Filter & Group</h2>
      <div class="row"><input type="text" id="filterText" placeholder="Filter by name or phase…" style="width:100%"></div>
      <div class="row"><label>Group by
        <select id="groupBy">
          <option value="none">None</option>
          <option value="phase">Phase</option>
          <option value="subsystem">Subsystem</option>
        </select></label>
      </div>
      <div class="row" style="gap:.4rem; flex-wrap:wrap">
        <button class="btn small" id="btnFilterClear">Clear filters</button>
        <button class="btn small" id="btnSelectFiltered">Select filtered</button>
        <button class="btn small" id="btnClearSel">Clear selection</button>
      </div>

      <h2>Subsystem legend</h2>
      <div class="row" style="gap:.35rem; flex-wrap:wrap">
        <button class="btn small" id="btnSubAll">All</button>
        <button class="btn small" id="btnSubNone">None</button>
      </div>
      <div class="subsys" id="subsysFilters"></div>

      <h2>Edit Selected (<span id="inlineCount">0</span>)</h2>
      <div class="inline-edit" id="inlineEdit"></div>

      <h2>Bulk Edit (<span id="bulkCount">0</span>)</h2>
      <div class="bulk">
        <div class="row-3 row">
          <label>Phase <input type="text" id="bulkPhase" placeholder="leave blank = skip"></label>
          <label>Subsystem
            <select id="bulkSub">
              <option value="">—</option>
              <option>System</option><option>power/VRM</option><option>PCIe</option><option>BMC</option><option>BIOS</option><option>FW</option><option>Mech</option><option>Thermal</option>
            </select>
          </label>
          <label>Active <select id="bulkActive"><option value="">—</option><option value="true">true</option><option value="false">false</option></select></label>
        </div>
        <div class="row-3 row">
          <label>Duration <input type="number" id="bulkDur" min="0" placeholder="e.g. 5"></label>
          <label>Mode
            <select id="bulkDurMode"><option value="set">set</option><option value="add">+/-</option></select>
          </label>
          <label>Name prefix <input type="text" id="bulkPrefix" placeholder="e.g. [R1]"></label>
        </div>
        <div class="row">
          <label>Progress (%) <input type="number" id="bulkPct" min="0" max="100" placeholder="0"></label>
        </div>
        <div class="row">
          <label>Add dependency token <input type="text" id="bulkAddDep" placeholder="e.g. FS:mobo_assembly+2d"></label>
          <label><input type="checkbox" id="bulkClearDeps"> clear all deps</label>
        </div>
        <div class="row">
          <label>Shift with SNET (+/‑ days) <input type="number" id="bulkShift" placeholder="0"></label>
          <div style="display:flex; gap:.35rem"><button class="btn small" id="btnApplyBulk">Apply</button><button class="btn small" id="btnBulkReset">Reset fields</button></div>
        </div>
      </div>

      <h2>Templates</h2>
      <div class="row">
        <label>Library
          <select id="tplSelect">
            <option value="hpc">HPC Bring‑up (sample)</option>
            <option value="sw">Software Sprint (2‑week)</option>
            <option value="hw">Board Spin Cycle</option>
          </select>
        </label>
      </div>
      <div class="row" style="gap:.4rem; flex-wrap:wrap">
        <button class="btn" id="btnInsertTpl">Insert library</button>
      </div>

      <h2>Validation & Warnings</h2>
      <div class="row" style="justify-content:flex-start; gap:.5rem">
        <button class="btn small" id="btnAutoFix">Auto‑fix common</button>
        <select id="severityFilter">
          <option value="all">Show: All</option>
          <option value="critical">Critical only</option>
          <option value="error">Errors & up</option>
          <option value="warn">Warnings & up</option>
          <option value="info">Info only</option>
        </select>
      </div>
      <div class="issues" id="issues"></div>
    </aside>

    <main>
      <div class="tabs">
        <div class="tab active" data-tab="timeline">Timeline</div>
        <div class="tab" data-tab="graph">Dependency Graph</div>
        <div class="tab" data-tab="focus">Where to focus</div>
        <div class="tab" data-tab="compare">Compare</div>
      </div>
      <div class="legend">
        <div class="group">
          <span class="pill">Links: FS/SS/FF/SF + \+/- lag (d or w)</span>
          <span class="pill">Constraints: MSO / SNET</span>
          <span class="pill">Severities: info / warn / error / critical</span>
        </div>
        <div class="group" style="margin-left:auto">
          <span>Timeline</span>
          <button class="btn small" id="zoomOutTL">−</button>
          <button class="btn small" id="zoomInTL">+</button>
          <button class="btn small" id="zoomResetTL">Fit</button>
          <span style="margin-left:.5rem">Graph</span>
          <button class="btn small" id="zoomOutGR">−</button>
          <button class="btn small" id="zoomInGR">+</button>
          <button class="btn small" id="zoomResetGR">Fit</button>
        </div>
      </div>
      <section id="timeline" class="view active">
        <svg id="gantt" class="gantt"></svg>
        <svg id="miniMap" class="mini-map"></svg>
      </section>
      <section id="graph" class="view">
        <svg id="graphSvg"></svg>
      </section>
      <section id="focus" class="view">
        <div class="focus">
          <div class="cards">
            <div class="card"><div>Planned finish</div><div class="metric" id="finishMetric">—</div></div>
            <div class="card"><div>Critical tasks</div><div class="metric" id="critMetric">—</div></div>
            <div class="card"><div>Total tasks</div><div class="metric" id="countMetric">—</div></div>
            <div class="card"><div>Last change impact</div><div class="metric" id="impactMetric">—</div></div>
          </div>
          <h3>Near‑critical (slack ≤ threshold)</h3>
          <div class="list" id="nearList"></div>
          <h3>Open warnings</h3>
          <div class="issues" id="focusWarnings"></div>
        </div>
      </section>
      <section id="compare" class="view">
        <div class="focus">
          <div class="row" style="gap:.5rem; align-items:center">
            <label>Baselines <select id="baselineSelect" multiple size="3"></select></label>
            <button class="btn small" id="btnSetBaseline">Use Selected</button>
          </div>
          <div class="cards" style="margin-top:.5rem">
            <div class="card"><div>Finish (baseline)</div><div class="metric" id="cmpFinishA">—</div></div>
            <div class="card"><div>Finish (current)</div><div class="metric" id="cmpFinishB">—</div></div>
            <div class="card"><div>Δ days</div><div class="metric" id="cmpFinishDelta">—</div></div>
            <div class="card"><div>Critical Δ (count)</div><div class="metric" id="cmpCritDelta">—</div></div>
          </div>
          <h3>Task deltas (start / finish / slack)</h3>
          <div class="list" id="cmpList"></div>
        </div>
      </section>
    </main>
  </div>

  <div class="hint" id="hint"></div>
  <div class="toast" id="toast"></div>
  <div class="ctx-menu" id="ctxMenu">
    <div data-action="edit">Edit</div>
    <div data-action="duplicate">Duplicate</div>
    <div data-action="delete">Delete</div>
    <div data-action="adddep">Add dependency</div>
  </div>

  <div class="modal" id="guideModal" aria-hidden="true">
    <div class="panel">
      <header>
        <h1 style="font-size:1rem">Guided Workflow</h1>
      </header>
      <div class="wizard-step" id="wz1">
        <h3>1) Choose dates & calendar</h3>
        <p>Pick a start date and whether to use working days with holidays or calendar days.</p>
      </div>
      <div class="wizard-step" id="wz2" style="display:none">
        <h3>2) Import or insert a template</h3>
        <p>Use <b>Open…</b> to load JSON/CSV or pick a library from the sidebar and click <b>Insert library</b>.</p>
      </div>
      <div class="wizard-step" id="wz3" style="display:none">
        <h3>3) Wire dependencies</h3>
        <p>Use tokens like <code>FS:pred+2d</code>, <code>SS:pred</code> in the task editor (bulk add works too).</p>
      </div>
      <div class="wizard-step" id="wz4" style="display:none">
        <h3>4) Validate & iterate</h3>
        <p>Open <b>Validation & Warnings</b> to fix issues. Drag bars to adjust, or use bulk edit.</p>
      </div>
      <div class="wizard-step" id="wz5" style="display:none">
        <h3>5) Compare scenarios</h3>
        <p>Create scenarios and set a baseline. Use <b>Compare</b> to see deltas.</p>
      </div>
      <div class="wizard-controls">
        <button class="btn ghost" id="wzClose">Close</button>
        <button class="btn" id="wzPrev" disabled>Back</button>
        <button class="btn accent" id="wzNext">Next</button>
      </div>
    </div>
  </div>

<script>
(function(){
'use strict';
let ZTL;
let MM_TASKS=[], MM_FINISH=0, MM_W=0, MM_SCALE=null;
// ---------------------------- tiny utils ----------------------------
const $ = (q,el=document)=>el.querySelector(q); const $$=(q,el=document)=>Array.from(el.querySelectorAll(q));
const todayStr = ()=> new Date().toISOString().slice(0,10);
function parseDate(s){ return new Date(s+'T00:00:00'); }
function fmtDate(d){ return d.toISOString().slice(0,10); }
function addDays(date, n){ const d=new Date(date); d.setDate(d.getDate()+n); return d; }
function isWeekend(d){ const x=d.getDay(); return x===0||x===6; }
function daysBetween(a,b){ return Math.round((b-a)/86400000); }
function esc(s){ return String(s??'').replace(/[&<>]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }
function uid(prefix='t'){ return prefix+'_'+Math.random().toString(36).slice(2,8); }
function slug(s){ return String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_|_$/g,''); }
function clone(o){ return JSON.parse(JSON.stringify(o)); }
function deepFreeze(o){ if(o&&typeof o==='object'&&!Object.isFrozen(o)){ Object.freeze(o); for(const k of Object.keys(o)){ deepFreeze(o[k]); } } return o; }
function showToast(msg){ const t=$('#toast'); t.textContent=msg; t.style.display='block'; clearTimeout(showToast._h); showToast._h=setTimeout(()=>{ t.style.display='none'; }, 2600); }
function showHint(x,y,msg){ const h=$('#hint'); h.textContent=msg; h.style.left=(x+12)+'px'; h.style.top=(y+12)+'px'; h.style.display='block'; }
function hideHint(){ $('#hint').style.display='none'; }
function showContextMenu(x,y,id){ const m=$('#ctxMenu'); m.dataset.id=id; m.style.display='block'; m.style.left=x+'px'; m.style.top=y+'px'; }
function hideContextMenu(){ $('#ctxMenu').style.display='none'; }
document.addEventListener('click', hideContextMenu);

// ---------------------------- duration parsing & validation ----------------------------
function parseDurationStrict(v){
  if(typeof v==='number'){
    if(!Number.isInteger(v) || v<0) return {error:'Duration must be a non‑negative integer (days).'};
    return {days:v};
  }
  const s=String(v||'').trim();
  if(s==='') return {error:'Duration is required.'};
  const m=s.match(/^(\d+)\s*([dw])?$/i);
  if(!m) return {error:'Use number of days or Nd/Nw (e.g., 10 or 3w).'};
  const n=parseInt(m[1],10); const u=(m[2]||'d').toLowerCase();
  if(n<0) return {error:'Duration cannot be negative.'};
  const days = u==='w'? n*5 : n;
  return {days};
}

// ---------------------------- calendar (standardized) ----------------------------
function makeCalendar(mode, holidaysSet){
  const isHoliday = d=> holidaysSet.has(fmtDate(d));
  function isWorkday(d){ return mode==='calendar'? true : (!isWeekend(d) && !isHoliday(d)); }
  function addBusinessDays(start, n){ let d=new Date(start); let step=n>=0?1:-1; let count=0; while(count!==n){ d.setDate(d.getDate()+step); if(isWorkday(d)) count+=step; } return d; }
  function diffBusinessDays(start, end){ let d=new Date(start); let n=0; const step=start<end?1:-1; while((step>0? d<end : d>end)){ d.setDate(d.getDate()+step); if(isWorkday(d)) n+=step; } return n; }
  return {
    mode,
    isWorkday,
    add:(start,n)=> mode==='calendar'? addDays(start,n): addBusinessDays(start,n),
    diff:(start,end)=> mode==='calendar'? daysBetween(start,end): diffBusinessDays(start,end)
  };
}

// ---------------------------- dependency parser ----------------------------
function parseDepToken(token){
  const s=String(token||'').trim(); if(!s) return null;
  let type='FS'; let rest=s; const colon=s.indexOf(':');
  if(colon>0){ const t=s.slice(0,colon).toUpperCase(); if(['FS','SS','FF','SF'].includes(t)){ type=t; rest=s.slice(colon+1); } }
  let pred=rest; let lag=0;
  const m = rest.match(/^(.*?)([+-])(\d+)([dw])?$/i);
  if(m){ pred=m[1]; const sign=m[2]==='-'?-1:1; const n=parseInt(m[3],10); const u=(m[4]||'d').toLowerCase(); lag = sign * (u==='w'? n*5 : n); }
  pred=pred.trim();
  return {type, pred, lag};
}
function stringifyDep(e){ const lagStr = e.lag? ((e.lag>0?'+':'')+Math.round(e.lag)+'d') : ''; return (e.type==='FS' && !lagStr? e.pred : `${e.type}:${e.pred}${lagStr}`); }
function normalizeDeps(task){ const raw=task.deps||[]; const arr=[]; for(const tok of raw){ const p=parseDepToken(tok); if(!p) continue; arr.push(p); } return arr; }
function adjustIncomingLags(task, delta){ const out=[]; for(const tok of (task.deps||[])){ const e=parseDepToken(tok); if(!e){ out.push(tok); continue; } if(e.type==='FS'||e.type==='SS'){ e.lag=(e.lag|0)+delta; out.push(stringifyDep(e)); } else { out.push(tok); } } return out; }

// ---------------------------- basic graph helpers ----------------------------
function findCycles(tasks){
  const id2=Object.fromEntries(tasks.map(t=>[t.id,t]));
  const deps=Object.fromEntries(tasks.map(t=>[t.id, normalizeDeps(t).map(x=>x.pred).filter(x=>id2[x]) ]));
  const color={}; const stack=[]; const cycles=[];
  function dfs(u){ color[u]=1; stack.push(u); for(const v of (deps[u]||[])){ if(color[v]==null){ dfs(v); } else if(color[v]===1){ const idx=stack.indexOf(v); cycles.push(stack.slice(idx).concat(v)); } } stack.pop(); color[u]=2; }
  for(const t of tasks){ if(color[t.id]==null) dfs(t.id); }
  return cycles;
}

// ---------------------------- centralized state manager ----------------------------
const SM=(function(){
  let state=deepFreeze({ startDate: todayStr(), calendar:'workdays', holidays:[], tasks:[] });
  let listeners=[]; let lastCPMWarns=[];
  const undo=[]; const redo=[]; const MAX=100;
  function get(){ return clone(state); }
  function _apply(next){ state=deepFreeze(clone(next)); for(const fn of listeners){ try{ fn(get()); }catch(e){ console.warn(e); } } }
  function set(next, opts={}){ const prev=get(); _apply(next); if(opts.record!==false){ undo.push(prev); if(undo.length>MAX) undo.shift(); redo.length=0; }
    window.dispatchEvent(new CustomEvent('state:changed', {detail:{sourceIds:opts.sourceIds||[]}}));
  }
  function setProjectProps(props){ const cur=get(); Object.assign(cur, props); set(cur); }
  function addTasks(list){ const cur=get(); const ids=new Set(cur.tasks.map(t=>t.id)); const add=list.map(t=>{ let id=t.id||uid('t'); while(ids.has(id)) id=uid('t'); ids.add(id); return {...t, id}; }); cur.tasks=cur.tasks.concat(add); set(cur); }
  function replaceTasks(tasks, opts={}){ const cur=get(); cur.tasks=tasks; set(cur, opts); }
  function updateTask(id, patch, opts={}){ const cur=get(); const i=cur.tasks.findIndex(t=>t.id===id); if(i<0) return; cur.tasks=cur.tasks.slice(); cur.tasks[i]={...cur.tasks[i], ...patch}; set(cur,{sourceIds:[id], ...opts}); }
  function onChange(fn){ listeners.push(fn); }
  function setCPMWarnings(list){ lastCPMWarns = list||[]; }
  function canUndo(){ return undo.length>0; } function canRedo(){ return redo.length>0; }
  function undoOp(){ if(!canUndo()) return; const prev=undo.pop(); const cur=get(); redo.push(cur); _apply(prev); }
  function redoOp(){ if(!canRedo()) return; const next=redo.pop(); const cur=get(); undo.push(cur); _apply(next); }
  return {get,set,setProjectProps,addTasks,replaceTasks,updateTask,onChange,setCPMWarnings,undo:undoOp,redo:redoOp,canUndo,canRedo};
})();

// ---------------------------- CPM (FS/SS/FF/SF + lags + constraints) ----------------------------
function computeCPM(project){
  const cal = makeCalendar(project.calendar, new Set(project.holidays||[]));
  const active = project.tasks.filter(t=>t.active!==false);
  const id2 = Object.fromEntries(active.map(t=>[t.id,t]));
  const predMap = new Map(active.map(t=>[t.id, normalizeDeps(t).filter(e=>id2[e.pred]) ]));
  const succMap = new Map(active.map(t=>[t.id, []]));
  for(const [sid,edges] of predMap){ for(const e of edges){ if(!succMap.has(e.pred)) succMap.set(e.pred,[]); succMap.get(e.pred).push({to:sid, type:e.type, lag:e.lag}); } }
  const indeg = new Map(active.map(t=>[t.id,0]));
  for(const [sid,edges] of predMap){ for(const e of edges){ indeg.set(sid, (indeg.get(sid)||0)+1); } }
  const q=[]; for(const t of active){ if((indeg.get(t.id)||0)===0) q.push(t.id); }
  const order=[]; while(q.length){ const u=q.shift(); order.push(u); for(const arc of (succMap.get(u)||[])){ const v=arc.to; indeg.set(v, (indeg.get(v)||0)-1); if(indeg.get(v)===0) q.push(v); } }
  const usable=active.filter(t=>order.includes(t.id));
  // Forward
  const ES={}, EF={}; const warnings=[];
  for(const id of order){ const t=id2[id]; if(!t) continue; const dur = parseDurationStrict(t.duration).days||0; let baseES=0; for(const e of (predMap.get(id)||[])){
      const p=e.pred; const type=e.type; const lag=e.lag|0; const esP = ES[p]||0; const efP = EF[p]||0;
      if(type==='FS') baseES=Math.max(baseES, efP + lag);
      else if(type==='SS') baseES=Math.max(baseES, esP + lag);
      else if(type==='FF') baseES=Math.max(baseES, efP + lag - dur);
      else if(type==='SF') baseES=Math.max(baseES, esP + lag - dur);
  }
  const sc = t.startConstraint || (t.fixedStart!=null ? {type:'SNET', day:t.fixedStart|0} : null);
  if(sc){ if(sc.type==='SNET') baseES = Math.max(baseES, sc.day|0); else if(sc.type==='MSO'){ if(baseES > (sc.day|0)) warnings.push({sev:'error', msg:`MSO violated for ${t.name}: deps force start ${baseES} > ${sc.day}`, taskId:t.id}); baseES = Math.max(baseES, sc.day|0); } }
  ES[id]=baseES; EF[id]=baseES + dur; }
  const projectFinish = Math.max(0, ...order.map(id=>EF[id]||0));
  // Backward
  const LF={}, LS={};
  const orderRev = order.slice().reverse();
  for(const id of orderRev){ const t=id2[id]; if(!t) continue; const dur=parseDurationStrict(t.duration).days||0; let baseLF = projectFinish; const succs = succMap.get(id)||[]; if(succs.length===0){ baseLF = projectFinish; }
    for(const arc of succs){ const s=arc.to; const type=arc.type; const lag=arc.lag|0; const lsS = LS[s]; const lfS = LF[s]; if(lsS==null || lfS==null) continue;
      if(type==='FS') baseLF = Math.min(baseLF, lsS - lag);
      else if(type==='SS') baseLF = Math.min(baseLF, (LS[id]==null? (lsS - lag) + dur : Math.min(LF[id]||Infinity, (lsS - lag) + dur) ));
      else if(type==='FF') baseLF = Math.min(baseLF, lfS - lag);
      else if(type==='SF') baseLF = Math.min(baseLF, (lfS - lag));
    }
    LF[id] = baseLF; LS[id] = baseLF - dur; }
  const out = usable.map(t=>({ ...t,
    es:ES[t.id]||0, ef:EF[t.id]||parseDurationStrict(t.duration).days||0,
    ls:LS[t.id]||0, lf:LF[t.id]||parseDurationStrict(t.duration).days||0,
    slack: (LS[t.id]??0)-(ES[t.id]??0),
    start: cal.add(parseDate(project.startDate), ES[t.id]||0),
    finish: cal.add(parseDate(project.startDate), EF[t.id]||0),
    critical: (LS[t.id]??0)===(ES[t.id]??0)
  }));
  SM.setCPMWarnings(warnings);
  return {order, tasks: out, finishDays: projectFinish};
}

// ---------------------------- Issue engine (rule‑based) ----------------------------
function collectIssues(project, cpm){
  const issues=[]; let seq=0; const FIX={};
  const id2=Object.fromEntries(project.tasks.map(t=>[t.id,t]));
  const seenIds=new Set(); const dupIds=new Set(); for(const t of project.tasks){ if(seenIds.has(t.id)) dupIds.add(t.id); seenIds.add(t.id); }
  function push(sev, msg, opts={}){ const id='i_'+(++seq); const it={id, sev, msg, ...opts}; if(opts.fix){ FIX[id]=opts.fix; it.hasFix=true; } issues.push(it); }
  if(!project.startDate) push('error','Project start date is missing.',{fix:()=> SM.setProjectProps({startDate: todayStr()})});
  if(dupIds.size){ push('critical',`Duplicate task ids: ${Array.from(dupIds).join(', ')}`,{fix:()=>{ const s=SM.get(); const used=new Set(); for(const t of s.tasks){ if(used.has(t.id)){ t.id = t.id+"_"+Math.random().toString(36).slice(2,5); } used.add(t.id); } SM.replaceTasks(s.tasks); }}); }
  for(const t of project.tasks){
    if(!t.id||String(t.id).trim()==='') push('error',`Task with empty id: "${t.name||'(no name)'}"`,{fix:()=>{ const s=SM.get(); const T=s.tasks.find(x=>x===t); T.id = uid('t'); SM.replaceTasks(s.tasks);} });
    if(!t.name||String(t.name).trim()==='') push('error',`Task ${t.id}: name is required.`,{fix:()=>{ const s=SM.get(); const T=s.tasks.find(x=>x.id===t.id); T.name = T.name && T.name.trim()? T.name : t.id; SM.replaceTasks(s.tasks);} });
    const pd=parseDurationStrict(t.duration); if(pd.error) push('error',`Task ${t.name||t.id}: ${pd.error}`,{taskId:t.id, fix:()=>{ const s=SM.get(); const T=s.tasks.find(x=>x.id===t.id); T.duration=1; SM.replaceTasks(s.tasks);} });
    if(t.fixedStart!=null && (!Number.isInteger(t.fixedStart) || t.fixedStart<0)) push('error',`Task ${t.name}: fixedStart must be a non‑negative integer (days offset).`,{taskId:t.id, fix:()=>{ const s=SM.get(); const T=s.tasks.find(x=>x.id===t.id); delete T.fixedStart; SM.replaceTasks(s.tasks);} });
    if(t.startConstraint){ const sc=t.startConstraint; if(!sc || !['MSO','SNET'].includes(sc.type)) push('error',`Task ${t.name}: startConstraint.type must be MSO or SNET.`,{fix:()=>{ const s=SM.get(); const T=s.tasks.find(x=>x.id===t.id); delete T.startConstraint; SM.replaceTasks(s.tasks);} }); if(sc && (sc.day==null || !Number.isInteger(sc.day) || sc.day<0)) push('error',`Task ${t.name}: startConstraint.day must be a non‑negative integer (days).`,{fix:()=>{ const s=SM.get(); const T=s.tasks.find(x=>x.id===t.id); if(T.startConstraint) T.startConstraint.day=0; SM.replaceTasks(s.tasks);} }); }
    const depStrings=t.deps||[];
    const seen=new Set();
    for(const tok of depStrings){ const d=parseDepToken(tok); if(!d) continue; if(d.pred===t.id) push('critical',`Task ${t.name}: self‑dependency not allowed (${tok}).`,{taskId:t.id, fix:()=>{ const s=SM.get(); const T=s.tasks.find(x=>x.id===t.id); T.deps=(T.deps||[]).filter(x=>x!==tok); SM.replaceTasks(s.tasks);} });
      if(!id2[d.pred]) push('error',`Task ${t.name}: missing dependency "${d.pred}".`,{taskId:t.id, fix:()=>{ const s=SM.get(); const pred={id:d.pred||uid('t'), name:`Placeholder: ${d.pred||'pred'}`, duration:1, deps:[]}; s.tasks.push(pred); SM.replaceTasks(s.tasks);} });
      if(seen.has(d.pred)) push('warn',`Task ${t.name}: duplicate dependency on ${d.pred}.`,{taskId:t.id, fix:()=>{ const s=SM.get(); const T=s.tasks.find(x=>x.id===t.id); const seen2=new Set(); T.deps=(T.deps||[]).filter(x=>{ const p=parseDepToken(x); if(!p) return false; if(seen2.has(p.pred)) return false; seen2.add(p.pred); return true; }); SM.replaceTasks(s.tasks);} });
      seen.add(d.pred);
      if(id2[d.pred] && id2[d.pred].active===false) push('warn',`Task ${t.name}: predecessor ${d.pred} is inactive.`,{taskId:t.id, fix:()=>{ const s=SM.get(); const P=s.tasks.find(x=>x.id===d.pred); if(P){ P.active=true; SM.replaceTasks(s.tasks);} }});
    }
  }
  const cycles=findCycles(project.tasks);
  for(const c of cycles){ const chain=c.join(' → '); push('critical',`Cycle detected: ${chain}`,{fix:()=>{ const s=SM.get(); const last=c[c.length-2]; const first=c[0]; const T=s.tasks.find(x=>x.id===last); if(T&&T.deps){ T.deps=T.deps.filter(tok=>{ const p=parseDepToken(tok); return !(p && p.pred===first); }); SM.replaceTasks(s.tasks);} }}); }
  if(cpm && cpm.tasks){ const map=Object.fromEntries(cpm.tasks.map(t=>[t.id,t]));
    for(const t of cpm.tasks){ const cur=id2[t.id]; if(!cur) continue;
      if(cur.startConstraint && cur.startConstraint.type==='MSO'){
        let esReq=0; for(const dep of normalizeDeps(cur)){ const p=map[dep.pred]; if(!p) continue; const dur=parseDurationStrict(cur.duration).days||0; if(dep.type==='FS') esReq=Math.max(esReq, p.ef + dep.lag); else if(dep.type==='SS') esReq=Math.max(esReq, p.es + dep.lag); else if(dep.type==='FF') esReq=Math.max(esReq, p.ef + dep.lag - dur); else if(dep.type==='SF') esReq=Math.max(esReq, p.es + dep.lag - dur); }
        if(esReq > (cur.startConstraint.day|0)){
          push('error',`MSO earlier than dependency bound for ${t.name} (MSO ${cur.startConstraint.day}d < required ${esReq}d).`,{taskId:t.id, fix:()=>{ const s=SM.get(); const T=s.tasks.find(x=>x.id===t.id); if(T.startConstraint){ T.startConstraint.day=esReq; } SM.replaceTasks(s.tasks);} });
        }
      }
      const dur=parseDurationStrict(cur.duration).days||0; if(dur===0 && !(String(cur.name||'').toLowerCase().includes('gate') || String(cur.phase||'').toLowerCase().includes('gate'))){ push('info',`Zero‑duration task: ${cur.name}. Consider a milestone (ok) or set to 1d.`,{taskId:t.id, fix:()=>{ const s=SM.get(); const T=s.tasks.find(x=>x.id===t.id); T.duration=1; SM.replaceTasks(s.tasks);} }); }
    }
  }
  return {issues, FIX};
}

// ---------------------------- Zoom/Pan helpers ----------------------------
function makeZoomPan(svg){
  const Z={};
  let vb=[0,0, svg.clientWidth||800, svg.clientHeight||500];
  const listeners=[];
  function setVB(x,y,w,h){ vb=[x,y,w,h]; svg.setAttribute('viewBox', vb.join(' ')); listeners.forEach(fn=>fn(vb)); }
  function fit(){ const w=svg.clientWidth||800, h=svg.clientHeight||500; setVB(0,0,w,h); }
  fit();
  let dragging=false; let p0=null;
  svg.addEventListener('wheel', (e)=>{ e.preventDefault(); const scale = e.deltaY>0? 1.1 : 0.9; const mx=e.offsetX, my=e.offsetY; const nx = vb[0] + (mx/vb[2])*vb[2]*(1-scale); const ny = vb[1] + (my/vb[3])*vb[3]*(1-scale); const nw = vb[2]*scale; const nh = vb[3]*scale; setVB(nx, ny, nw, nh); });
  svg.addEventListener('pointerdown', (e)=>{ if(e.button!==0) return; dragging=true; p0={x:e.clientX, y:e.clientY, vb0:[...vb]}; svg.setPointerCapture(e.pointerId); });
  svg.addEventListener('pointermove', (e)=>{ if(!dragging) return; const dx=e.clientX-p0.x, dy=e.clientY-p0.y; setVB(p0.vb0[0]-dx, p0.vb0[1]-dy, p0.vb0[2], p0.vb0[3]); });
  svg.addEventListener('pointerup', (e)=>{ dragging=false; svg.releasePointerCapture(e.pointerId); });
  Z.zoomIn=()=> setVB(vb[0]+vb[2]*0.05, vb[1]+vb[3]*0.05, vb[2]*0.9, vb[3]*0.9);
  Z.zoomOut=()=> setVB(vb[0]-vb[2]*0.055, vb[1]-vb[3]*0.055, vb[2]*1.1, vb[3]*1.1);
  Z.fit=fit;
  Z.getViewBox=()=>vb.slice();
  Z.setViewBox=(x,y,w,h)=>setVB(x,y,w,h);
  Z.onChange=(fn)=>{ listeners.push(fn); };
  return Z;
}

function renderMiniMap(){
  const mm=$('#miniMap'); if(!mm||!MM_SCALE) return;
  const mmW=mm.clientWidth||200, mmH=mm.clientHeight||60;
  mm.setAttribute('viewBox',`0 0 ${mmW} ${mmH}`);
  mm.innerHTML='';
  for(const t of MM_TASKS){
    const x=MM_SCALE(Math.max(0,t.es||0))/MM_W*mmW;
    const w=(MM_SCALE(Math.max(0,t.ef||t.es||0))-MM_SCALE(Math.max(0,t.es||0)))/MM_W*mmW;
    const rect=document.createElementNS('http://www.w3.org/2000/svg','rect');
    rect.setAttribute('x',x); rect.setAttribute('y',10); rect.setAttribute('width',w); rect.setAttribute('height',8); rect.setAttribute('fill','#94a3b8');
    mm.appendChild(rect);
  }
  if(ZTL && ZTL.getViewBox){
    const vb=ZTL.getViewBox();
    const rx=vb[0]/MM_W*mmW;
    const rw=vb[2]/MM_W*mmW;
    const view=document.createElementNS('http://www.w3.org/2000/svg','rect');
    view.setAttribute('x',rx); view.setAttribute('y',5); view.setAttribute('width',rw); view.setAttribute('height',18); view.setAttribute('fill','none'); view.setAttribute('stroke','#0ea5e9');
    mm.appendChild(view);
    mm.onclick=(e)=>{ const frac=e.offsetX/mmW; const newX=frac*MM_W - vb[2]/2; const nx=Math.max(0, Math.min(MM_W-vb[2], newX)); ZTL.setViewBox(nx, vb[1], vb[2], vb[3]); };
  }
}

// ---------------------------- Filtering & grouping ----------------------------
const SUBS=['power/VRM','PCIe','BMC','BIOS','FW','Mech','Thermal','System'];
function getActiveSubsystems(){ return $$('#subsysFilters input[type="checkbox"]').filter(x=>x.checked).map(x=>x.value); }
function matchesFilters(t){ const txt=($('#filterText').value||'').toLowerCase(); if(txt){ const inName=(t.name||'').toLowerCase().includes(txt); const inPhase=(t.phase||'').toLowerCase().includes(txt); if(!inName && !inPhase) return false; }
  const act=getActiveSubsystems(); if(act.length && !act.includes(t.subsystem||'System')) return false; return true; }
function groupKey(t){ const g=$('#groupBy').value||'none'; if(g==='phase') return t.phase||'(no phase)'; if(g==='subsystem') return t.subsystem||'System'; return null; }

// ---------------------------- Rendering: Graph ----------------------------
function layoutDAG(tasks){ const byLevel=new Map(); const K=100; for(const t of tasks){ const lvl=t.es; const y=Math.round(lvl/5); if(!byLevel.has(y)) byLevel.set(y,[]); byLevel.get(y).push(t);} const pos=new Map(); for(const [lvl,arr] of byLevel){ arr.sort((a,b)=> (a.phase||'').localeCompare(b.phase||'')); let x=40; for(const t of arr){ pos.set(t.id,{x, y: 40+lvl*K}); x+=Math.max(160, 8*(t.name||'').length); } } return pos; }
function renderGraph(project, cpm){ const svg = $('#graphSvg'); svg.innerHTML=''; const defs=document.createElementNS('http://www.w3.org/2000/svg','defs'); defs.innerHTML=`<marker id="arrow" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="8" markerHeight="8" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#94a3b8"/></marker>`; svg.appendChild(defs); const g=document.createElementNS('http://www.w3.org/2000/svg','g'); svg.appendChild(g); const tasks=cpm.tasks.filter(matchesFilters); const id2=Object.fromEntries(cpm.tasks.map(t=>[t.id,t])); const pos=layoutDAG(tasks); for(const t of tasks){ const edges = normalizeDeps(t); for(const e of edges){ const d=e.pred; if(!id2[d] || !matchesFilters(id2[d])) continue; const p1=pos.get(d), p2=pos.get(t.id); if(!p1||!p2) continue; const line=document.createElementNS('http://www.w3.org/2000/svg','path'); line.setAttribute('d',`M ${p1.x+120} ${p1.y+20} L ${p2.x-12} ${p2.y+20}`); line.setAttribute('class','edge arrow'+(t.critical&&id2[d].critical?' critical':'')); g.appendChild(line);} } for(const t of tasks){ const p=pos.get(t.id); if(!p) continue; const node=document.createElementNS('http://www.w3.org/2000/svg','g'); node.setAttribute('class','node'+(t.critical?' critical':'')); node.setAttribute('data-id',t.id); if(SEL.has(t.id)) node.classList.add('selected'); const color=colorFor(t.subsystem); node.innerHTML = `<rect x="${p.x}" y="${p.y}" width="240" height="44" style="stroke:${color}" rx="8" fill="#fff"/> <text x="${p.x+10}" y="${p.y+18}" class="title">${esc(t.name)}</text> <text x="${p.x+10}" y="${p.y+34}" fill="#64748b">${esc(t.phase||'')} • ${esc(String(t.duration))}d • slack ${esc(String(t.slack))}</text>`; node.addEventListener('click', ()=>{ toggleSelect(t.id); renderGraph(project,cpm); }); g.appendChild(node);} }

// ---------------------------- Rendering: Timeline ----------------------------
function colorFor(subsys){ const M={'power/VRM':'--pwr','PCIe':'--pcie','BMC':'--bmc','BIOS':'--bios','FW':'--fw','Mech':'--mech','Thermal':'--thermal','System':'--sys'}; const v=M[subsys]||'--ok'; return getComputedStyle(document.documentElement).getPropertyValue(v).trim()||'#16a34a'; }
function renderGantt(project, cpm){ const svg=$('#gantt'); svg.innerHTML=''; const W=(svg.getBoundingClientRect().width||800); const H=(svg.getBoundingClientRect().height||500); const P=120; const tasksAll=cpm.tasks.slice(); const tasks=tasksAll.filter(matchesFilters);
  // grouping
  const groups={}; const order=[]; for(const t of tasks){ const k=groupKey(t); if(k==null){ order.push(['', [t]]); continue; } if(!groups[k]) groups[k]=[]; groups[k].push(t); }
  if(Object.keys(groups).length){ for(const k of Object.keys(groups).sort()){ order.push([k, groups[k].sort((a,b)=> (a.es-b.es)|| (a.name||'').localeCompare(b.name||''))]); } }
  if(!order.length) order.push(['', tasks.sort((a,b)=> (a.es-b.es)|| (a.name||'').localeCompare(b.name||''))]);
  const rows=[]; order.forEach(([k,arr])=>{ if(k){ rows.push({type:'group', label:k}); } arr.forEach(t=> rows.push({type:'task', t})); });
  const rowH=28; const chartH=Math.max(H, rows.length*rowH+60); svg.setAttribute('viewBox',`0 0 ${W} ${chartH}`);
  const finish=Math.max(10,cpm.finishDays||10); const scale = (x)=> P + (x*(W-P-20))/finish; const scaleInv=(px)=> Math.round((px-P)*finish/(W-P-20));
  const gAxis=document.createElementNS('http://www.w3.org/2000/svg','g'); gAxis.setAttribute('class','axis'); const ticks=10; for(let i=0;i<=ticks;i++){ const x=scale(i*(finish/ticks)); const l=document.createElementNS('http://www.w3.org/2000/svg','line'); l.setAttribute('x1',x); l.setAttribute('y1',20); l.setAttribute('x2',x); l.setAttribute('y2',chartH-20); l.setAttribute('stroke','#e5e7eb'); gAxis.appendChild(l); const t=document.createElementNS('http://www.w3.org/2000/svg','text'); t.setAttribute('x',x+2); t.setAttribute('y',14); t.textContent = Math.round(i*(finish/ticks))+'d'; gAxis.appendChild(t); } svg.appendChild(gAxis);
  const g=document.createElementNS('http://www.w3.org/2000/svg','g'); svg.appendChild(g);
  let y=30; rows.forEach((r)=>{ if(r.type==='group'){ const rect=document.createElementNS('http://www.w3.org/2000/svg','rect'); rect.setAttribute('x',0); rect.setAttribute('y',y-6); rect.setAttribute('width',W); rect.setAttribute('height',22); rect.setAttribute('class','groupHeader'); g.appendChild(rect); const tx=document.createElementNS('http://www.w3.org/2000/svg','text'); tx.setAttribute('x',8); tx.setAttribute('y',y+8); tx.setAttribute('class','groupLabel'); tx.textContent=r.label; g.appendChild(tx); y+=22; return; }
    const t=r.t; const x=scale(Math.max(0,t.es||0)), w=Math.max(4, scale(Math.max(0,t.ef||1))-scale(Math.max(0,t.es||0)) );
    const bar=document.createElementNS('http://www.w3.org/2000/svg','g');
    bar.setAttribute('class','bar'+(t.critical?' critical':'')); bar.setAttribute('data-id',t.id);
    if(SEL.has(t.id)) bar.classList.add('selected');
    const col=colorFor(t.subsystem);
    const isMilestone=(parseDurationStrict(t.duration).days||0)===0;
    if(isMilestone){
      bar.setAttribute('data-ms','1');
      const diamond=document.createElementNS("http://www.w3.org/2000/svg","rect");
      diamond.setAttribute("x",x-6); diamond.setAttribute("y",y+2); diamond.setAttribute("width",12); diamond.setAttribute("height",12);
      diamond.setAttribute("transform",`rotate(45 ${x} ${y+8})`);
      diamond.setAttribute("class","milestone"+(t.critical?' critical':''));
      diamond.setAttribute("style",`stroke:${col}`);
      bar.appendChild(diamond);
    }else{
      const rect=document.createElementNS("http://www.w3.org/2000/svg","rect");
      rect.setAttribute("x",x); rect.setAttribute("y",y); rect.setAttribute("width",w); rect.setAttribute("height",16); rect.setAttribute("fill","#e2e8f0"); rect.setAttribute("style",`stroke:${col}`);
      bar.appendChild(rect);
      const progW=Math.max(0, Math.min(w, w*(t.pct||0)/100));
      if(progW>0){ const prog=document.createElementNS("http://www.w3.org/2000/svg","rect"); prog.setAttribute("x",x); prog.setAttribute("y",y); prog.setAttribute("width",progW); prog.setAttribute("height",16); prog.setAttribute("class","progress"); prog.setAttribute("fill",col); bar.appendChild(prog); }
      const left=document.createElementNS("http://www.w3.org/2000/svg","rect"); left.setAttribute("x",x-3); left.setAttribute("y",y); left.setAttribute("width",3); left.setAttribute("height",16); left.setAttribute("class","handle"); left.setAttribute("data-side","left"); bar.appendChild(left);
      const right=document.createElementNS("http://www.w3.org/2000/svg","rect"); right.setAttribute("x",x+w); right.setAttribute("y",y); right.setAttribute("width",3); right.setAttribute("height",16); right.setAttribute("class","handle"); right.setAttribute("data-side","right"); bar.appendChild(right);
    }
    const label=document.createElementNS("http://www.w3.org/2000/svg","text"); label.setAttribute("class","label"); label.setAttribute("x",P-6); label.setAttribute("y",y+12); label.setAttribute("text-anchor","end"); label.textContent=t.name; bar.appendChild(label);
    const dur=document.createElementNS("http://www.w3.org/2000/svg","text"); dur.setAttribute("class","label"); dur.setAttribute("x",isMilestone? x+6 : x+w+6); dur.setAttribute("y",y+12); dur.textContent=String(t.duration)+"d"; bar.appendChild(dur);
    if(!isMilestone){ const pct=document.createElementNS("http://www.w3.org/2000/svg","text"); pct.setAttribute("class","label"); pct.setAttribute("x",x+4); pct.setAttribute("y",y+12); pct.textContent=(t.pct||0)+"%"; bar.appendChild(pct); }
    bar.addEventListener('click', (ev)=>{ if(ev.shiftKey||ev.metaKey||ev.ctrlKey){ toggleSelect(t.id); renderGantt(project,cpm); } });
    bar.addEventListener('contextmenu',(ev)=>{ ev.preventDefault(); selectOnly(t.id); showContextMenu(ev.clientX, ev.clientY, t.id); });
    g.appendChild(bar); y+=rowH; });

  MM_TASKS=tasksAll; MM_FINISH=finish; MM_W=W; MM_SCALE=scale; renderMiniMap();

  // drag
  let drag=null; svg.onpointerdown=(ev)=>{ const tgt=ev.target; const gg=tgt.closest('.bar'); if(!gg || gg.dataset.ms) return; const id=gg.getAttribute('data-id'); const rect=gg.querySelector('rect'); const x0=+rect.getAttribute('x'); const w0=+rect.getAttribute('width'); const side = tgt.classList.contains('handle')? tgt.getAttribute('data-side') : 'move'; drag={id, side, x0, w0, px0:ev.clientX, py0:ev.clientY}; gg.classList.add('moved'); svg.setPointerCapture(ev.pointerId); };
  svg.onpointermove=(ev)=>{ if(!drag) return; const dx=ev.clientX-drag.px0; const gg=$(`.bar[data-id="${drag.id}"]`, svg); const rect=gg.querySelector('rect'); const labelNext=gg.querySelectorAll('text')[1]; if(drag.side==='right'){ const newW=Math.max(4, drag.w0+dx); rect.setAttribute('width', newW); const dur = scaleInv(+rect.getAttribute('x')+newW) - (cpm.tasks.find(t=>t.id===drag.id).es||0); labelNext.textContent = Math.max(1,dur)+'d'; hideHint(); gg.classList.remove('invalid','valid'); } else { const newX=Math.max(P, drag.x0+dx); rect.setAttribute('x', newX); const esCand = scaleInv(newX); const cur=cpm.tasks.find(t=>t.id===drag.id); const dur=cur.ef - cur.es; const allowed = $('#toggleConAware')? ($('#toggleConAware').checked? calcEarliestESFor(SM.get(), drag.id, dur) : 0) : 0; const ok = (esCand>=allowed) || ev.shiftKey; labelNext.textContent = (cur.duration)+'d'; if(ok){ gg.classList.add('valid'); gg.classList.remove('invalid'); hideHint(); } else { gg.classList.add('invalid'); gg.classList.remove('valid'); showHint(ev.clientX, ev.clientY, `Blocked: earliest ${allowed}d`); } }
  };
  svg.onpointerup=(ev)=>{ if(!drag) return; svg.releasePointerCapture(ev.pointerId); hideHint(); const gg=$(`.bar[data-id="${drag.id}"]`, svg); const rect=gg.querySelector('rect'); const x=+rect.getAttribute('x'); const w=+rect.getAttribute('width'); const scaleInv=(px)=> Math.round((px-P)*finish/(W-P-20)); const esNew = scaleInv(x); const efNew = scaleInv(x+w); const durNew = Math.max(1, efNew-esNew); const cur=cpm.tasks.find(t=>t.id===drag.id);
    if(drag.side==='right'){ SM.updateTask(drag.id,{duration:durNew}); showToast('Duration updated'); }
    else if(drag.side==='left' || (drag.side==='move' && ev.shiftKey)){
      const sc={type:'SNET', day:esNew}; SM.updateTask(drag.id,{startConstraint:sc, duration:durNew}); showToast('Set SNET constraint');
    } else {
      const allowed=$('#toggleConAware')? ($('#toggleConAware').checked? calcEarliestESFor(SM.get(), drag.id, cur.ef-cur.es) : 0) : 0; const autoLag=$('#toggleAutoLag')? $('#toggleAutoLag').checked : false;
      if(esNew<allowed && !autoLag){ const sc={type:'SNET', day:allowed}; SM.updateTask(drag.id,{startConstraint:sc}, {record:true}); showToast(`Snapped to earliest ${allowed}d`);
      } else if(esNew!== (cur.es||0)){
        const delta = esNew - (cur.es||0);
        if(autoLag){ const s=SM.get(); const t=s.tasks.find(x=>x.id===drag.id); t.deps=adjustIncomingLags(t, delta); SM.replaceTasks(s.tasks,{record:true}); showToast(`Adjusted predecessor lags by ${delta}d`); }
        else { const sc={type:'SNET', day:Math.max(0, esNew)}; SM.updateTask(drag.id,{startConstraint:sc}, {record:true}); showToast('Added SNET to honor move'); }
      }
    }
    gg.classList.remove('invalid','valid'); drag=null; setTimeout(()=>{ refresh(); }, 0);
  };
}

function calcEarliestESFor(project, id, dur){
  const id2=Object.fromEntries(project.tasks.map(t=>[t.id,t]));
  const cur=id2[id]; if(!cur) return 0; let es=0;
  for(const e of normalizeDeps(cur)){ const p=id2[e.pred]; if(!p) continue; const pd=parseDurationStrict(p.duration).days||0; if(e.type==='FS') es=Math.max(es, (p.ef!=null?p.ef:pd)+e.lag); else if(e.type==='SS') es=Math.max(es, (p.es!=null?p.es:0)+e.lag); else if(e.type==='FF') es=Math.max(es, (p.ef!=null?p.ef:pd)+e.lag - dur); else if(e.type==='SF') es=Math.max(es, (p.es!=null?p.es:0)+e.lag - dur); }
  if(cur.startConstraint){ const sc=cur.startConstraint; if(sc.type==='SNET' || sc.type==='MSO') es=Math.max(es, sc.day|0); }
  if(cur.fixedStart!=null) es=Math.max(es, cur.fixedStart|0);
  return Math.max(0, Math.round(es));
}

// ---------------------------- Focus & Issues rendering ----------------------------
function renderFocus(project, cpm){
  $('#countMetric').textContent = String(cpm.tasks.length);
  const cal=makeCalendar(project.calendar, new Set(project.holidays||[]));
  const finishDate = cal.add(parseDate(project.startDate), cpm.finishDays||0);
  $('#finishMetric').textContent = fmtDate(finishDate);
  $('#critMetric').textContent = String(cpm.tasks.filter(t=>t.critical).length);
  const th = +($('#slackThreshold').value||0);
  const near = cpm.tasks.filter(t=>t.slack<=th && !t.critical).sort((a,b)=>a.slack-b.slack);
  const L=$('#nearList'); L.innerHTML=''; for(const t of near){ const row=document.createElement('div'); row.className='row'; row.innerHTML=`<span>${esc(t.name)}</span><span class="slack">slack ${t.slack}d</span>`; L.appendChild(row); }
  // focus warnings = same as issues filter
  renderIssues(project, cpm, '#focusWarnings');
}

function renderIssues(project, cpm, targetSel){
  const {issues, FIX} = collectIssues(project, cpm);
  const filter=$('#severityFilter').value||'all';
  const box=$(targetSel||'#issues'); box.innerHTML='';
  if(!issues.length){ const ok=document.createElement('div'); ok.className='issue sev-info'; ok.innerHTML='<span class="msg">No validation issues.</span><span class="meta">Real‑time checks clean</span>'; box.appendChild(ok); return; }
  for(const it of issues){ if(filter!=='all'){
      const rank={info:1,warn:2,error:3,critical:4}; if(rank[it.sev] < (filter==='info'?1: filter==='warn'?2: filter==='error'?3:4)) continue;
    }
    const div=document.createElement('div'); div.className='issue sev-'+it.sev; const sub = it.taskId? `<span class="meta">Task: ${esc(it.taskId)}</span>`:''; const btn = it.hasFix && !targetSel? `<div class="actions"><button class="btn small fix-btn" data-i="${it.id}">Fix</button></div>`:''; div.innerHTML = `<div><div class="msg">${esc(it.msg)}</div>${sub}</div>${btn}`; box.appendChild(div);
  }
  if(!targetSel){ box.onclick=(e)=>{ const b=e.target.closest('.fix-btn'); if(!b) return; const id=b.getAttribute('data-i'); const fn=FIX[id]; if(typeof fn==='function'){ fn(); showToast('Applied fix'); refresh(); } }; $('#btnAutoFix').onclick=()=>{ const rank={info:1,warn:2,error:3,critical:4}; for(const it of issues){ if(it.hasFix && rank[it.sev]>=3){ const fn=FIX[it.id]; if(typeof fn==='function') fn(); } } showToast('Auto‑fix pass finished'); refresh(); }; }
}

// ---------------------------- Scenarios (same as v7 + bugfix) ----------------------------
const SC=(function(){
  const scenarios={}; let current='Working'; let baselines=[];
  function snapshot(){ return SM.get(); }
  function saveAs(name){ scenarios[name]=clone(snapshot()); current=name; updateScenarioUI(); showToast(`Saved as "${name}"`); }
  function switchTo(name){ if(!scenarios[name]) return; SM.set(clone(scenarios[name])); current=name; updateScenarioUI(); showToast(`Switched to "${name}"`); }
  function get(name){ return scenarios[name]? clone(scenarios[name]): null; }
  function list(){ return Object.keys(scenarios); }
  function setBaselines(names){ baselines=names.filter(n=>scenarios[n]); updateScenarioUI(); showToast(`Baselines set: ${baselines.join(', ')||'none'}`); }
  function getBaselines(){ return baselines.slice(); }
  return {saveAs, switchTo, get, list, setBaselines, getBaselines, current:()=>current};
})();
function updateScenarioUI(){
  const sel=$('#scenarioSelect');
  if(sel){
    sel.innerHTML='';
    const items=SC.list();
    for(const name of items){
      const opt=document.createElement('option'); opt.value=name; opt.textContent=name; sel.appendChild(opt);
    }
    const badge=$('#scenarioBadge'); if(badge) badge.textContent = `Scenario: ${SC.current()}`;
    const bSel=$('#baselineSelect');
    if(bSel){
      bSel.innerHTML='';
      const bases=new Set(SC.getBaselines());
      for(const n of items){
        const o=document.createElement('option'); o.value=n; o.textContent=n; if(bases.has(n)) o.selected=true; bSel.appendChild(o);
      }
    }
  }
}
function buildCompare(){
  const baseNames=SC.getBaselines();
  if(baseNames.length===0){
    $('#cmpList').innerHTML='<div class="issue sev-info"><div class="msg">Select baseline scenario(s).</div></div>';
    return;
  }
  const curProj=SM.get();
  const B=computeCPM(curProj);
  const calB=makeCalendar(curProj.calendar, new Set(curProj.holidays||[]));
  $('#cmpFinishB').textContent=fmtDate(calB.add(parseDate(curProj.startDate), B.finishDays||0));
  const L=$('#cmpList');
  L.innerHTML='';
  baseNames.forEach((baseName, idx)=>{
    const baseProj=SC.get(baseName);
    if(!baseProj){
      const div=document.createElement('div'); div.className='issue sev-error'; div.innerHTML=`<div class="msg">Baseline scenario missing: ${esc(baseName)}</div>`; L.appendChild(div); return;
    }
    const A=computeCPM(baseProj);
    const calA=makeCalendar(baseProj.calendar, new Set(baseProj.holidays||[]));
    const finishA=fmtDate(calA.add(parseDate(baseProj.startDate), A.finishDays||0));
    const delta=(B.finishDays||0)-(A.finishDays||0);
    const critA=new Set(A.tasks.filter(t=>t.critical).map(t=>t.id));
    const critB=new Set(B.tasks.filter(t=>t.critical).map(t=>t.id));
    const critDelta=Math.abs(critA.size-critB.size);
    if(idx===0){
      $('#cmpFinishA').textContent=finishA;
      $('#cmpFinishDelta').textContent=String(delta);
      $('#cmpCritDelta').textContent=String(critDelta);
    }
    const header=document.createElement('div');
    header.className='issue sev-info';
    header.innerHTML=`<div class="msg"><b>${esc(baseName)}</b> • Δfinish ${delta}d • Δcritical ${critDelta}</div>`;
    L.appendChild(header);
    const mapA=Object.fromEntries(A.tasks.map(t=>[t.id,t]));
    const mapB=Object.fromEntries(B.tasks.map(t=>[t.id,t]));
    const rows=[];
    for(const id of Object.keys(mapB)){
      const a=mapA[id]; const b=mapB[id]; if(!b) continue;
      const ds=(b.es||0)-(a? a.es||0:0);
      const df=(b.ef||0)-(a? a.ef||0:0);
      const dsl=(b.slack||0)-(a? a.slack||0:0);
      rows.push({name:b.name||id, ds, df, dsl});
    }
    rows.sort((x,y)=> Math.abs(y.df)-Math.abs(x.df));
    rows.forEach(r=>{
      const div=document.createElement('div');
      div.className='row';
      div.innerHTML=`<span>${esc(r.name)}</span><span class="slack">Δstart ${r.ds}d • Δfinish ${r.df}d • Δslack ${r.dsl}d</span>`;
      L.appendChild(div);
    });
  });
}


// ---------------------------- CSV / IO ----------------------------
async function saveFile(json){ const blob=new Blob([json],{type:'application/json'}); if(window.showSaveFilePicker){ try{ const handle=await showSaveFilePicker({suggestedName:'project.hpc.json', types:[{description:'JSON', accept:{'application/json':['.json']}}]}); const w=await handle.createWritable(); await w.write(blob); await w.close(); return; }catch(e){ console.warn(e);} } const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='project.hpc.json'; a.click(); URL.revokeObjectURL(a.href); }
async function openFile(){ if(window.showOpenFilePicker){ try{ const [h]=await showOpenFilePicker({types:[{description:'JSON/CSV', accept:{'application/json':['.json'],'text/csv':['.csv']}}]}); const f=await h.getFile(); const txt=await f.text(); return f.name.endsWith('.csv')? csvToProject(txt) : JSON.parse(txt); }catch(e){ console.warn(e);} } return new Promise((res)=>{ const inp=document.createElement('input'); inp.type='file'; inp.accept='.json,.csv'; inp.onchange=async()=>{ const f=inp.files[0]; const txt=await f.text(); if(f.name.endsWith('.csv')) res(csvToProject(txt)); else res(JSON.parse(txt)); }; inp.click(); }); }
function exportCSV(){ const rows=[['id','name','duration(d)','deps','phase','subsystem']]; for(const t of SM.get().tasks){ if(t.active===false) continue; rows.push([t.id,t.name,parseDurationStrict(t.duration).days||0, (t.deps||[]).join(' '), t.phase||'', t.subsystem||''].map(x=>`"${String(x).replaceAll('"','""')}"`)); } const csv=rows.map(r=>r.join(',')).join('\n'); const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download='project.csv'; a.click(); URL.revokeObjectURL(a.href); }
function csvToProject(csv){ const lines=csv.trim().split(/\r?\n/); const [header,...rows]=lines; const idx=(k)=> header.split(',').map(s=>s.replace(/\W+/g,'').toLowerCase()).indexOf(k.toLowerCase()); const iId=idx('id'), iName=idx('name'), iDur=idx('durationd'), iDeps=idx('deps'), iPhase=idx('phase'), iSub=idx('subsystem'); const tasks=rows.map(r=>{ const cols=r.match(/\"([^\"]|\"\")*\"|[^,]+/g).map(s=>s.replace(/^\"|\"$/g,'').replaceAll('""','"')); const d=parseDurationStrict(+cols[iDur]||cols[iDur]||''); return { id: cols[iId]||uid('t'), name: cols[iName], duration: d.error? 1 : d.days, deps: (cols[iDeps]||'').split(/[\s;]/).filter(Boolean), phase: cols[iPhase]||'', subsystem: cols[iSub]||'System', active:true }; }); return {startDate: todayStr(), calendar: 'workdays', holidays:[], tasks}; }

// ---------------------------- Selection & Bulk edit ----------------------------
const SEL=new Set();
let LAST_SEL=null;
function toggleSelect(id){
  if(SEL.has(id)){
    SEL.delete(id);
    if(LAST_SEL===id) LAST_SEL=null;
  }else{
    SEL.add(id);
    LAST_SEL=id;
  }
  updateSelBadge();
}
function selectOnly(id){
  SEL.clear();
  SEL.add(id);
  LAST_SEL=id;
  updateSelBadge();
}
function moveSelection(dir){
  const tasks=SM.get().tasks.filter(matchesFilters);
  if(!tasks.length) return;
  let idx=tasks.findIndex(t=>t.id===LAST_SEL);
  if(idx===-1) idx = dir>0?0:tasks.length-1;
  else idx=(idx+dir+tasks.length)%tasks.length;
  selectOnly(tasks[idx].id);
  refresh();
}
function deleteSelected(){
  if(!SEL.size) return;
  const ids=new Set(SEL);
  const s=SM.get();
  const remaining=s.tasks.filter(t=>!ids.has(t.id));
  for(const t of remaining){
    if(t.deps){
      t.deps=t.deps.filter(tok=>{
        const e=parseDepToken(tok);
        return !(e && ids.has(e.pred));
      });
    }
  }
  SM.replaceTasks(remaining);
  clearSelection();
  showToast(`Deleted ${ids.size} task${ids.size>1?'s':''}`);
  refresh();
}
function duplicateSelected(){
  if(!SEL.size) return;
  const s=SM.get();
  const tasks=[...s.tasks];
  const ids=new Set(tasks.map(t=>t.id));
  const originals=tasks.filter(t=>SEL.has(t.id));
  const mapOldToNew=new Map();
  const clones=[];
  for(const t of originals){
    let id=t.id+'_copy';
    while(ids.has(id)) id=uid('t');
    ids.add(id);
    const clone=JSON.parse(JSON.stringify(t));
    clone.id=id;
    clone.name=(t.name||t.id)+' (copy)';
    mapOldToNew.set(t.id,id);
    clones.push(clone);
  }
  for(const c of clones){
    if(c.deps){
      c.deps=c.deps.map(tok=>{
        const e=parseDepToken(tok);
        if(!e) return tok;
        if(mapOldToNew.has(e.pred)) e.pred=mapOldToNew.get(e.pred);
        return stringifyDep(e);
      });
    }
  }
  for(let i=originals.length-1;i>=0;i--){
    const idx=tasks.findIndex(t=>t.id===originals[i].id);
    tasks.splice(idx+1,0,clones[i]);
  }
  SM.replaceTasks(tasks);
  SEL.clear();
  clones.forEach(c=>SEL.add(c.id));
  LAST_SEL=clones.length?clones[clones.length-1].id:null;
  updateSelBadge();
  showToast(`Duplicated ${clones.length} task${clones.length>1?'s':''}`);
  refresh();
}
function clearSelection(){ SEL.clear(); LAST_SEL=null; updateSelBadge(); }
function renderInlineEditor(){ const box=$('#inlineEdit'); if(!box) return; box.innerHTML=''; if(SEL.size===0) return; const s=SM.get();
  for(const id of SEL){ const t=s.tasks.find(x=>x.id===id); if(!t) continue; const row=document.createElement('div'); row.className='row';
    const dur=parseDurationStrict(t.duration).days||0;
    row.innerHTML=`<input type="text" data-id="${id}" data-field="name" value="${esc(t.name)}">
      <input type="number" min="0" data-id="${id}" data-field="duration" value="${dur}">
      <input type="number" min="0" max="100" data-id="${id}" data-field="pct" value="${t.pct||0}">
      <input type="text" data-id="${id}" data-field="phase" value="${esc(t.phase||'')}">
      <select data-id="${id}" data-field="subsystem">${SUBS.map(sub=>`<option${sub===t.subsystem?' selected':''}>${esc(sub)}</option>`).join('')}</select>
      <select data-id="${id}" data-field="active"><option value="true"${t.active!==false?' selected':''}>true</option><option value="false"${t.active===false?' selected':''}>false</option></select>`;
    box.appendChild(row);
  }
  box.querySelectorAll('input,select').forEach(inp=>{ inp.addEventListener('change',()=>{ const id=inp.dataset.id; const field=inp.dataset.field; let val=inp.value; if(field==='duration') val=parseInt(val,10)||0; else if(field==='active') val=(val==='true'); else if(field==='pct') val=Math.min(100, Math.max(0, parseInt(val,10)||0)); SM.updateTask(id,{[field]:val}); refresh(); }); });
}
function updateSelBadge(){ $('#selBadge').textContent = `${SEL.size} selected`; $('#bulkCount').textContent=String(SEL.size); $('#inlineCount') && ($('#inlineCount').textContent=String(SEL.size)); renderInlineEditor(); }
function applyBulk(){ if(SEL.size===0){ showToast('Select some tasks first'); return; } const s=SM.get(); const ids=new Set(SEL); let changed=0; for(const t of s.tasks){ if(!ids.has(t.id)) continue; changed++; const phase=$('#bulkPhase').value.trim(); if(phase) t.phase=phase; const sub=$('#bulkSub').value; if(sub) t.subsystem=sub; const act=$('#bulkActive').value; if(act!=='') t.active=(act==='true'); const pfx=$('#bulkPrefix').value||''; if(pfx) t.name=pfx+' '+(t.name||''); const addDep=$('#bulkAddDep').value.trim(); if(addDep){ t.deps=(t.deps||[]).concat([addDep]); }
    if($('#bulkClearDeps').checked) t.deps=[];
    const durV=$('#bulkDur').value; if(durV!==''){ const n=parseInt(durV,10)||0; if($('#bulkDurMode').value==='set') t.duration=n; else t.duration=Math.max(0, parseDurationStrict(t.duration).days + n); }
    const shift=$('#bulkShift').value; if(shift!==''){ const d=parseInt(shift,10)||0; const es = t.es||0; t.startConstraint = {type:'SNET', day: Math.max(0, es + d)}; }
    const pctV=$('#bulkPct').value; if(pctV!==''){ const n=Math.min(100, Math.max(0, parseInt(pctV,10)||0)); t.pct=n; }
  }
  SM.replaceTasks(s.tasks); showToast(`Bulk applied to ${changed} tasks`); refresh(); }

// ---------------------------- Templates/Libraries ----------------------------
function insertTemplate(which){ const lib = templateLib(which); const s=SM.get(); const base = slug(which)+'_'; const used=new Set(s.tasks.map(t=>t.id)); const toAdd=lib.map((t,i)=>{ let id = (t.id||uid('t')); if(used.has(id)) id = base + id; while(used.has(id)) id=base+uid('t'); used.add(id); return {...t, id}; });
  // remap deps if referencing ids in lib
  const mapOldToNew = new Map(lib.map((t,i)=>[t.id, toAdd[i].id]));
  toAdd.forEach((t,i)=>{ if(t.deps){ t.deps = t.deps.map(tok=>{ const e=parseDepToken(tok); if(!e) return tok; if(mapOldToNew.has(e.pred)) e.pred = mapOldToNew.get(e.pred); return stringifyDep(e); }); }
  });
  SM.addTasks(toAdd); showToast(`Inserted ${toAdd.length} tasks from ${which}`); }

// ---------------------------- UI orchestration ----------------------------
function setupLegend(){ const box=$('#subsysFilters'); box.innerHTML=''; SUBS.forEach(name=>{ const cls=slug(name).replace('_',''); const div=document.createElement('label'); div.className='tag'; div.innerHTML=`<input type="checkbox" checked value="${name}"><span class=\"dot ${cls}\" style="background:${colorFor(name)}"></span> ${name}`; box.appendChild(div); }); $('#btnSubAll').onclick=()=> $$('#subsysFilters input[type="checkbox"]').forEach(c=>c.checked=true);
  $('#btnSubNone').onclick=()=> $$('#subsysFilters input[type="checkbox"]').forEach(c=>c.checked=false); $$('#subsysFilters input[type="checkbox"]').forEach(c=> c.onchange=refresh); }
function parseHolidaysInput(){ const raw=$('#holidayInput').value||''; const tokens=raw.split(/[\s,]+/).filter(Boolean); const out=[]; for(const t of tokens){ const m=t.match(/^\d{4}-\d{2}-\d{2}$/); if(m){ out.push(t); } }
  return out; }

function refresh(){ const s=SM.get(); const cpm=computeCPM(s); renderGantt(s, cpm); renderGraph(s, cpm); renderFocus(s, cpm); renderIssues(s, cpm); $('#boot').style.display='none'; $('#appRoot').style.display='grid'; if($('.tab.active').dataset.tab==='compare') buildCompare(); }

function newProject(){ SM.set({startDate: todayStr(), calendar:'workdays', holidays:[], tasks:[]}); $('#startDate').value=todayStr(); $('#calendarMode').value='workdays'; $('#holidayInput').value=''; clearSelection(); refresh(); }

// ---------------------------- Boot ----------------------------
window.addEventListener('DOMContentLoaded', ()=>{
  try{
    $('#startDate').value = todayStr();
    setupLegend();
    // seed with sample HPC flow
    SM.set({startDate: todayStr(), calendar:'workdays', holidays:[], tasks: templateHPC()},{record:false});
    refresh();

    // reactive
    SM.onChange(()=>{ $('#btnUndo').disabled=!SM.canUndo(); $('#btnRedo').disabled=!SM.canRedo(); updateSelBadge(); });

    // tabs
    $$('.tab').forEach(t=> t.onclick=()=>{ $$('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active'); $$('.view').forEach(v=>v.classList.remove('active')); $('#'+t.dataset.tab).classList.add('active'); if(t.dataset.tab==='compare') buildCompare(); });

    // controls
    $('#slackThreshold').onchange = refresh;
    $('#calendarMode').onchange = ()=>{ SM.setProjectProps({calendar: $('#calendarMode').value}); refresh(); };
    $('#startDate').onchange = ()=>{ SM.setProjectProps({startDate: $('#startDate').value||todayStr()}); refresh(); };
    $('#holidayInput').onchange = ()=>{ SM.setProjectProps({holidays: parseHolidaysInput()}); refresh(); };
    $('#severityFilter').onchange = ()=>{ renderIssues(SM.get(), computeCPM(SM.get())); };
    $('#filterText').oninput = ()=>{ refresh(); };
    $('#groupBy').onchange = refresh;
    $('#btnFilterClear').onclick=()=>{ $('#filterText').value=''; $$('#subsysFilters input[type="checkbox"]').forEach(c=>c.checked=true); refresh(); };
    $('#btnSelectFiltered').onclick=()=>{ const cpm=computeCPM(SM.get()); computeCPM; const ids=new Set(cpm.tasks.filter(matchesFilters).map(t=>t.id)); ids.forEach(id=>SEL.add(id)); updateSelBadge(); refresh(); };
    $('#btnClearSel').onclick=()=>{ clearSelection(); refresh(); };

    // bulk
    $('#btnApplyBulk').onclick=applyBulk; $('#btnBulkReset').onclick=()=>{ ['bulkPhase','bulkSub','bulkActive','bulkDur','bulkDurMode','bulkPrefix','bulkPct','bulkAddDep','bulkClearDeps','bulkShift'].forEach(id=>{ const el=document.getElementById(id); if(!el) return; if(el.type==='checkbox') el.checked=false; else if(el.tagName==='SELECT') el.selectedIndex=0; else el.value=''; }); };

    // scenarios
    updateScenarioUI();
    $('#scenarioSelect') && ($('#scenarioSelect').onchange=(e)=>{ refresh(); });
    $('#btnScenarioNew') && ($('#btnScenarioNew').onclick=()=>{ const name=prompt('New scenario name'); if(!name) return; SC.saveAs(name); refresh(); });
    $('#btnScenarioSaveAs') && ($('#btnScenarioSaveAs').onclick=()=>{ const name=prompt('Save current as…'); if(!name) return; SC.saveAs(name); refresh(); });
    $('#btnScenarioBaseline') && ($('#btnScenarioBaseline').onclick=()=>{ const name=$('#scenarioSelect').value; if(!name) return; const cur=SC.getBaselines(); if(!cur.includes(name)) cur.push(name); SC.setBaselines(cur); buildCompare(); });
    $('#btnOpenCompare') && ($('#btnOpenCompare').onclick=()=>{ $$('.tab').forEach(x=>x.classList.remove('active')); $('[data-tab="compare"]').classList.add('active'); $$('.view').forEach(v=>v.classList.remove('active')); $('#compare').classList.add('active'); buildCompare(); });
    $('#btnSetBaseline').onclick=()=>{ const sel=$('#baselineSelect'); const vals=Array.from(sel.selectedOptions).map(o=>o.value); SC.setBaselines(vals); buildCompare(); };

    // I/O
    $('#btnExportCSV').onclick=exportCSV;
    $('#btnExportJSON').onclick=()=>{ const json=JSON.stringify(SM.get(), null, 2); const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([json],{type:'application/json'})); a.download='project.json'; a.click(); URL.revokeObjectURL(a.href); };
    $('#btnSave').onclick=()=> saveFile(JSON.stringify(SM.get(), null, 2));
    $('#btnLoad').onclick=async()=>{ const data=await openFile(); if(!data) return; SM.set({startDate:data.startDate||todayStr(), calendar:data.calendar||'workdays', holidays:data.holidays||[], tasks:ensureIds(data.tasks||[])}); $('#startDate').value=SM.get().startDate; $('#calendarMode').value=SM.get().calendar; $('#holidayInput').value=(SM.get().holidays||[]).join(', '); clearSelection(); refresh(); };
    $('#btnNew').onclick=newProject; $('#btnPrint').onclick=()=>window.print();

    // history
    $('#btnUndo').onclick=()=>{ SM.undo(); refresh(); };
    $('#btnRedo').onclick=()=>{ SM.redo(); refresh(); };
    window.addEventListener('keydown', (e)=>{
      const tag=(e.target.tagName||'').toLowerCase();
      if(e.target.isContentEditable || ['input','textarea','select'].includes(tag)) return;
      const k=e.key;
      if((e.ctrlKey||e.metaKey)&&!e.shiftKey && k.toLowerCase()==='z'){
        e.preventDefault(); SM.undo(); refresh();
      }else if((e.ctrlKey||e.metaKey) && (k.toLowerCase()==='y' || (e.shiftKey && k.toLowerCase()==='z'))){
        e.preventDefault(); SM.redo(); refresh();
      }else if(k==='Delete'){
        e.preventDefault(); deleteSelected();
      }else if((e.ctrlKey||e.metaKey) && k.toLowerCase()==='d'){
        e.preventDefault(); duplicateSelected();
      }else if(k==='ArrowDown' || k==='ArrowRight'){
        e.preventDefault(); moveSelection(1);
      }else if(k==='ArrowUp' || k==='ArrowLeft'){
        e.preventDefault(); moveSelection(-1);
      }
    });

    // Guide modal
    (function(){ let step=1; const max=5; const modal=$('#guideModal'); function showStep(){ for(let i=1;i<=max;i++){ $('#wz'+i).style.display = (i===step)?'block':'none'; } $('#wzPrev').disabled = step===1; $('#wzNext').textContent = step===max? 'Done' : 'Next'; }
      $('#btnGuide').onclick=()=>{ modal.style.display='flex'; step=1; showStep(); };
      $('#wzClose').onclick=()=>{ modal.style.display='none'; };
      $('#wzPrev').onclick=()=>{ if(step>1) step--; showStep(); };
      $('#wzNext').onclick=()=>{ if(step<max) step++; else modal.style.display='none'; showStep(); };
    })();

    // Zoom/Pan controls
    ZTL=makeZoomPan($('#gantt')); const ZGR=makeZoomPan($('#graphSvg'));
    ZTL.onChange(renderMiniMap);
    $('#zoomInTL').onclick=ZTL.zoomIn; $('#zoomOutTL').onclick=ZTL.zoomOut; $('#zoomResetTL').onclick=ZTL.fit;
    $('#zoomInGR').onclick=ZGR.zoomIn; $('#zoomOutGR').onclick=ZGR.zoomOut; $('#zoomResetGR').onclick=ZGR.fit;

    // Templates
    $('#btnInsertTpl').onclick=()=> insertTemplate($('#tplSelect').value);
    $('#ctxMenu').onclick=(e)=>{ const act=e.target.dataset.action; const id=$('#ctxMenu').dataset.id; hideContextMenu(); if(!id||!act) return; if(act==='edit'){ selectOnly(id); refresh(); const inp=$('#inlineEdit input'); inp&&inp.focus(); } else if(act==='duplicate'){ selectOnly(id); duplicateSelected(); } else if(act==='delete'){ selectOnly(id); deleteSelected(); } else if(act==='adddep'){ const tok=prompt('Dependency token (e.g. FS:pred+2d)'); if(tok){ const s=SM.get(); const t=s.tasks.find(x=>x.id===id); if(t){ t.deps=(t.deps||[]).concat([tok]); SM.replaceTasks(s.tasks); refresh(); } } } };

  }catch(err){
    console.error(err);
    const box=$('#fatal'); box.style.display='block'; box.textContent='Startup error:\n'+(err&&err.stack||String(err));
  }
});

// ---------------------------- Templates ----------------------------
function ensureIds(list){ return list.map(t=>({...t, id:t.id||uid('t'), active: t.active!==false})); }
function w(n){ return n*5; } function d(n){ return n; }
function templateHPC(){ return ensureIds([
  {id:'mobo_assembly', name:'Carte mère assemblée (PCB+ASM)', duration:w(1), subsystem:'System', phase:'EVT L1'},
  {id:'mobo_bringup_air', name:'Bring-up carte mère (à air, pas de méca)', duration:w(8), deps:['mobo_assembly'], subsystem:'power/VRM', phase:'EVT L1'},
  {id:'power_bringup_bench', name:'Bring-up power (banc)', duration:w(4), subsystem:'power/VRM', phase:'EVT L1'},
  {id:'power_full_load', name:'Power en puissance', duration:w(2), deps:['power_bringup_bench'], subsystem:'power/VRM', phase:'EVT L1'},
  {id:'power_rails_validated', name:'Power rails validés (gate)', duration:d(0), deps:['power_full_load'], subsystem:'power/VRM', phase:'EVT L1'},
  {id:'bringup_other_cards', name:'Bring-up autres cartes', duration:w(4), deps:['mobo_bringup_air'], subsystem:'System', phase:'EVT L1'},
  {id:'mech_deliveries', name:'Livraison méca', duration:w(4), subsystem:'Mech', phase:'EVT L1'},
  {id:'first_blade_assembly', name:'1ère lame assembly & corrections méca', duration:w(1), deps:['mech_deliveries','mobo_bringup_air','bringup_other_cards','power_full_load'], subsystem:'System', phase:'EVT L1'},
  {id:'remaining_blades_assembly', name:'Assemblage lames restantes (~5)', duration:w(2), deps:['first_blade_assembly'], subsystem:'System', phase:'EVT L1'},
  {id:'mech_lvl1_lab', name:'Méca L1 labo (WaterBox sans lame)', duration:w(1), deps:['mech_deliveries'], subsystem:'Mech', phase:'EVT L1'},
  {id:'blade_watercool_setup', name:'Setup water cooling', duration:w(1), deps:['remaining_blades_assembly','mech_lvl1_lab'], subsystem:'Thermal', phase:'EVT L2'},
  {id:'l2_integration_evt', name:'L2 tests (intégration lame)', duration:w(3), deps:['blade_watercool_setup'], subsystem:'System', phase:'EVT L2'},
  {id:'bmc_fw_evt', name:'Dev FW BMC (EVT)', duration:w(4), deps:['mobo_bringup_air'], subsystem:'BMC', phase:'EVT L2'},
  {id:'bios_dev_evt', name:'Dev BIOS (EVT)', duration:w(4), deps:['power_rails_validated','blade_watercool_setup'], subsystem:'BIOS', phase:'EVT L2'},
  {id:'sw_hal_evt', name:'Dev SW HAL (EVT 20j)', duration:d(20), deps:['blade_watercool_setup'], subsystem:'FW', phase:'EVT L2'},
  {id:'evt_done', name:'Fin EVT → GreenLight DVT', duration:d(0), deps:['l2_integration_evt'], subsystem:'System', phase:'EVT'},
  {id:'make_15_blades', name:'Préparer ~15 lames DVT', duration:w(4), deps:['evt_done'], subsystem:'System', phase:'DVT L3'},
  {id:'fw_dev_dvt', name:'Dev FW (BMC/BIOS) continue', duration:w(4), deps:['make_15_blades'], subsystem:'FW', phase:'DVT L3'},
  {id:'l2_integration_dvt', name:'L2 intégration + interconnect (8w)', duration:w(8), deps:['make_15_blades'], subsystem:'System', phase:'DVT L3'},
  {id:'l1_thermal_cont', name:'L1 thermique (TC) continue', duration:w(4), deps:['make_15_blades'], subsystem:'Thermal', phase:'DVT L3'},
  {id:'sw_hal_dvt', name:'Dev SW HAL (DVT 60j)', duration:d(60), deps:['make_15_blades','sw_hal_evt'], subsystem:'FW', phase:'DVT L3'},
  {id:'l3_system_test', name:'L3 tests système (8w)', duration:w(8), deps:['l2_integration_dvt','fw_dev_dvt','sw_hal_dvt'], subsystem:'System', phase:'DVT L3'},
  {id:'blade_for_angers', name:'Lame pour Angers (usine)', duration:w(1), deps:['make_15_blades'], subsystem:'System', phase:'DVT L3'},
  {id:'dvt_done', name:'Fin DVT', duration:d(0), deps:['l3_system_test'], subsystem:'System', phase:'DVT'},
  {id:'transfer_factory', name:'Transfert à Angers / CdP usine', duration:w(1), deps:['dvt_done'], subsystem:'System', phase:'PVT'},
  {id:'train_assembly', name:'Former montage lames', duration:w(1), deps:['transfer_factory'], subsystem:'System', phase:'PVT'},
  {id:'build_card_tester', name:'Construire testeur carte', duration:w(3), deps:['transfer_factory'], subsystem:'System', phase:'PVT'},
  {id:'pretest_bench', name:'Banc de pré‑test mémoire', duration:w(2), deps:['transfer_factory'], subsystem:'System', phase:'PVT'},
  {id:'pvt_launch_mfg', name:'Lancer MFG PVT (cartes + méca)', duration:w(2), deps:['transfer_factory'], subsystem:'System', phase:'PVT'},
  {id:'parts_received', name:'Réception pièces', duration:w(3), deps:['pvt_launch_mfg'], subsystem:'System', phase:'PVT'},
  {id:'mfg_process', name:'Process MFG (ramp‑up)', duration:w(4), deps:['parts_received'], subsystem:'System', phase:'PVT'},
  {id:'pvt_done', name:'Fin PVT', duration:d(0), deps:['mfg_process'], subsystem:'System', phase:'PVT'}
]); }

function templateLib(which){
  if(which==='hpc') return templateHPC();
  if(which==='sw') return ensureIds([
    {id:'sw_backlog', name:'Backlog grooming', duration:d(1), phase:'Sprint‑0', subsystem:'System'},
    {id:'sw_planning', name:'Sprint planning', duration:d(1), deps:['sw_backlog'], phase:'Sprint‑0', subsystem:'System'},
    {id:'sw_dev', name:'Development', duration:d(8), deps:['sw_planning'], phase:'Sprint‑1', subsystem:'FW'},
    {id:'sw_ci', name:'CI & Code review', duration:d(2), deps:['sw_dev'], phase:'Sprint‑1', subsystem:'FW'},
    {id:'sw_test', name:'Testing', duration:d(2), deps:['sw_ci'], phase:'Sprint‑1', subsystem:'System'},
    {id:'sw_release', name:'Release & Retro', duration:d(1), deps:['sw_test'], phase:'Sprint‑1', subsystem:'System'}
  ]);
  if(which==='hw') return ensureIds([
    {id:'schematic', name:'Schematic update', duration:w(2), subsystem:'System', phase:'SPIN'},
    {id:'layout', name:'PCB layout changes', duration:w(3), deps:['schematic'], subsystem:'System', phase:'SPIN'},
    {id:'fabrication', name:'Fabrication', duration:w(2), deps:['layout'], subsystem:'System', phase:'SPIN'},
    {id:'bringup', name:'Board bring‑up', duration:w(3), deps:['fabrication'], subsystem:'power/VRM', phase:'BRINGUP'}
  ]);
  return [];
}

})();
</script>
<noscript>
  <div style="padding:1rem; color:#7f1d1d; background:#fef2f2; border:1px solid #fecaca; margin:1rem; border-radius:.6rem">
    This app needs JavaScript enabled.
  </div>
</noscript>
</body>
</html>
