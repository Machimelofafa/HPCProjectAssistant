<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>HPC/AI Project Planner â€” singleâ€‘file, offline (Enhanced UI/UX)</title>
<style>
  :root{
    color-scheme: light;
    /* Enhanced color palette with better contrast and modern aesthetics */
    --bg: #fafbfc;
    --panel: #ffffff;
    --ink: #1a202c;
    --muted: #4a5568;
    --line: #e2e8f0;
    
    /* Primary colors with improved accessibility */
    --accent: #3182ce;
    --accent-light: #63b3ed;
    --accent-dark: #2c5282;
    
    /* Status colors with better contrast */
    --warn: #d69e2e;
    --error: #d53f40;
    --ok: #38a169;
    --crit: #d53f40;
    --info: #4299e1;
    
    /* Subsystem colors with enhanced visibility */
    --pwr: #fc8181;
    --pcie: #f6ad55;
    --bmc: #68d391;
    --bios: #9f7aea;
    --fw: #63b3ed;
    --mech: #4fd1c7;
    --thermal: #ed8936;
    --sys: #a0aec0;
    
      /* Enhanced shadows and effects */
  --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
  --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  --shadow-md: 0 6px 10px -3px rgba(0, 0, 0, 0.10), 0 3px 6px -3px rgba(0, 0, 0, 0.06);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
  
  /* Performance optimizations */
  --transition-fast: 0.15s ease;
  --transition-normal: 0.2s ease;
  --transition-slow: 0.3s ease;
  
  /* Reduced motion support */
  --motion-reduce: 0.01ms;
    
    /* Typography improvements */
    --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    --font-size-base: 15px;
    --font-size-sm: 13px;
    --font-size-lg: 16px;
    --font-size-xl: 18px;
    --line-height: 1.6;
    
    /* Spacing improvements */
    --spacing-xs: 0.25rem;
    --spacing-sm: 0.5rem;
    --spacing-md: 0.75rem;
    --spacing-lg: 1rem;
    --spacing-xl: 1.5rem;
    --spacing-2xl: 2rem;
    
    /* Border radius improvements */
    --radius-sm: 6px;
    --radius-md: 8px;
    --radius-lg: 12px;
    --radius-xl: 16px;
  }
  
  html,body{height:100%}
  body{
    margin:0; 
    font: var(--font-size-base)/var(--line-height) var(--font-family);
    background: linear-gradient(135deg, var(--bg) 0%, #f8fafc 100%);
    color: var(--ink);
    line-height: var(--line-height);
    min-height: 100vh;
    position: relative;
  }
  
  body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image: 
      radial-gradient(circle at 20% 80%, rgba(49, 130, 206, 0.03) 0%, transparent 50%),
      radial-gradient(circle at 80% 20%, rgba(56, 161, 105, 0.03) 0%, transparent 50%);
    pointer-events: none;
    z-index: -1;
  }
  
  /* Enhanced header with better visual hierarchy */
  header{
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--spacing-lg) var(--spacing-xl);
    background: var(--panel);
    position: sticky; 
    top: 0; 
    z-index: 3; 
    box-shadow: var(--shadow);
    border-bottom: 1px solid var(--line);
    backdrop-filter: blur(8px);
  }
  
  .header-left h1{
    font-size: var(--font-size-xl);
    margin: 0; 
    letter-spacing: -0.025em;
    font-weight: 700;
    color: var(--ink);
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
  }
  
  .title-icon {
    font-size: 1.5em;
    opacity: 0.8;
  }
  
  .subtitle {
    color: var(--muted);
    font-weight: 400;
    font-size: 0.7em;
    margin-left: var(--spacing-sm);
  }
  
  .header-center {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
    align-items: center;
  }
  
  .button-group {
    display: flex;
    gap: var(--spacing-sm);
    align-items: center;
  }
  
  
  .btn-icon {
    font-size: 0.9em;
    margin-right: var(--spacing-xs);
  }
  
  
  .status-indicators {
    display: flex;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-sm);
  }
  
  .status-pill {
    background: rgba(49, 130, 206, 0.1);
    border-color: var(--accent-light);
    color: var(--accent-dark);
    font-weight: 600;
  }
  
  .feature-pill {
    background: rgba(56, 161, 105, 0.1);
    border-color: var(--ok);
    color: var(--ok);
    font-size: 0.8em;
  }
  
  .pill-icon {
    margin-right: var(--spacing-xs);
    font-size: 0.9em;
  }
  
  header .right{
    display: flex; 
    flex-direction: column;
    gap: var(--spacing-sm);
    align-items: flex-end;
  }
  
  /* Enhanced button styles */
  .btn{
    background: var(--panel);
    color: var(--ink);
    border: 1px solid var(--line);
    padding: var(--spacing-sm) var(--spacing-md);
    border-radius: var(--radius-md);
    transition: background-color var(--transition-normal), color var(--transition-normal), border-color var(--transition-normal), transform var(--transition-normal), box-shadow var(--transition-normal);
    cursor: pointer;
    font-family: inherit;
    font-size: inherit;
    line-height: inherit;
    will-change: transform;
  }
  
  .btn:hover {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
    transform: translateY(-1px);
    box-shadow: var(--shadow-lg);
  }
  
  .btn:active {
    transform: translateY(0);
  }
  
  .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }
  
  .btn.ghost {
    background: transparent;
    border-color: transparent;
  }
  
  .btn.ghost:hover {
    background: rgba(49, 130, 206, 0.1);
    border-color: var(--accent);
    color: var(--accent);
  }
  
  .btn.accent {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
  }
  
  .btn.accent:hover {
    background: var(--accent-dark);
    border-color: var(--accent-dark);
  }
  
  .btn.small {
    padding: var(--spacing-xs) var(--spacing-sm);
    font-size: var(--font-size-sm);
  }
  
  .btn:hover{
    background: #f7fafc;
    border-color: var(--accent-light);
    transform: translateY(-1px);
    box-shadow: var(--shadow-lg);
  }
  
  .btn:active{
    transform: translateY(0);
  }
  
  .btn.ghost{
    background: transparent;
    border-color: var(--line);
  }
  
  .btn.warn{
    border-color: var(--warn);
    color: var(--warn);
  }
  
  .btn.accent{
    border-color: var(--accent);
    color: var(--accent);
    background: rgba(49, 130, 206, 0.1);
  }
  
  .btn.accent:hover{
    background: rgba(49, 130, 206, 0.15);
  }
  
  .btn.error{
    border-color: var(--error);
    color: var(--error);
  }
  
  .btn.small{
    padding: var(--spacing-xs) var(--spacing-sm);
    font-size: var(--font-size-sm);
  }
  
  /* Enhanced pill styles */
  .pill{
    border: 1px solid var(--line);
    border-radius: 999px;
    padding: var(--spacing-xs) var(--spacing-md);
    font-size: var(--font-size-sm);
    font-weight: 500;
    background: var(--panel);
    color: var(--muted);
  }
  
  /* Enhanced layout */
  .layout{
    display: grid;
    grid-template-columns: 400px 1fr;
    gap: var(--spacing-xl);
    padding: var(--spacing-xl);
    max-width: 1920px;
    margin: 0 auto;
  }
  
  /* Enhanced sidebar */
  aside{
    background: var(--panel);
    border: 1px solid var(--line);
    border-radius: var(--radius-lg);
    padding: var(--spacing-xl);
    position: sticky;
    top: 90px;
    height: calc(100vh - 110px);
    overflow: auto;
    box-shadow: var(--shadow);
  }
  
  aside h2{
    font-size: var(--font-size-sm);
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin: var(--spacing-xl) 0 var(--spacing-sm);
    font-weight: 600;
    border-bottom: 1px solid var(--line);
    padding-bottom: var(--spacing-xs);
  }
  
  aside label, aside .row{
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--spacing-md);
    padding: var(--spacing-sm) 0;
  }
  
  /* Enhanced form elements */
  .form-label {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs);
    width: 100%;
  }
  
  .form-label.full-width {
    width: 100%;
  }
  
  .label-icon {
    font-size: 1.1em;
    opacity: 0.7;
    margin-right: var(--spacing-xs);
  }
  
  .section-icon {
    margin-right: var(--spacing-sm);
    opacity: 0.8;
  }
  
  .form-input {
    background: var(--panel);
    color: var(--ink);
    border: 1px solid var(--line);
    border-radius: var(--radius-md);
    padding: var(--spacing-sm) var(--spacing-md);
    font-size: var(--font-size-sm);
    transition: border-color var(--transition-normal), box-shadow var(--transition-normal), transform var(--transition-normal);
    width: 100%;
    will-change: transform;
  }
  
  .form-input:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
    transform: translateY(-1px);
  }
  
  .form-input:invalid {
    border-color: var(--error);
    box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
  }
  
  .form-input:disabled {
    background: #f8fafc;
    color: var(--muted);
    cursor: not-allowed;
  }
  
  /* Enhanced form validation feedback */
  .form-input.error {
    border-color: var(--error);
    background: #fef2f2;
  }
  
  .form-input.success {
    border-color: var(--success);
    background: #f0fdf4;
  }
  
  .form-input.warning {
    border-color: var(--warning);
    background: #fffbeb;
  }
  
  /* Form field help text */
  .form-help {
    font-size: var(--font-size-sm);
    color: var(--muted);
    margin-top: var(--spacing-xs);
    line-height: 1.4;
  }
  
  .form-help.error {
    color: var(--error);
  }
  
  .form-help.success {
    color: var(--success);
  }
  
  .form-help.warning {
    color: var(--warning);
  }
  
  .search-container {
    position: relative;
    width: 100%;
  }
  
  .search-icon {
    position: absolute;
    left: var(--spacing-sm);
    top: 50%;
    transform: translateY(-50%);
    color: var(--muted);
    font-size: 0.9em;
    pointer-events: none;
  }
  
  .search-input {
    padding-left: calc(var(--spacing-sm) * 2 + 1em);
  }
  
  .filter-actions {
    display: flex;
    gap: var(--spacing-sm);
    flex-wrap: wrap;
    justify-content: center;
  }
  
  textarea{
    width: 100%;
    min-height: 70px;
    font: inherit;
    resize: vertical;
  }
  
  input[type="checkbox"]{
    transform: scale(1.2);
    accent-color: var(--accent);
  }
  
  /* Enhanced subsystem filters */
  .subsys{
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: var(--spacing-sm) var(--spacing-md);
  }
  
  .subsystem-controls {
    display: flex;
    gap: var(--spacing-sm);
    justify-content: center;
    margin-bottom: var(--spacing-sm);
  }
  
  /* Enhanced tag styles */
  .tag{
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-xs) var(--spacing-md);
    border-radius: var(--radius-md);
    border: 1px solid var(--line);
    font-size: var(--font-size-sm);
    background: var(--panel);
    cursor: pointer;
    transition: background-color var(--transition-normal), border-color var(--transition-normal), transform var(--transition-normal);
    font-weight: 500;
    will-change: transform;
  }
  
  .tag:hover{
    background: #f7fafc;
    border-color: var(--accent-light);
    transform: translateY(-1px);
  }
  
  .tag input{
    margin-right: var(--spacing-xs);
  }
  
  /* Enhanced dot indicators */
  .dot{
    width: 12px;
    height: 12px;
    border-radius: 999px;
    display: inline-block;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }
  
  .dot.pwr{background: var(--pwr)} 
  .dot.pcie{background: var(--pcie)} 
  .dot.bmc{background: var(--bmc)} 
  .dot.bios{background: var(--bios)} 
  .dot.fw{background: var(--fw)} 
  .dot.mech{background: var(--mech)} 
  .dot.thermal{background: var(--thermal)} 
  .dot.sys{background: var(--sys)}
  
  /* Enhanced main content area */
  main{
    background: var(--panel);
    border: 1px solid var(--line);
    border-radius: var(--radius-lg);
    padding: 0;
    min-height: 60vh;
    overflow: hidden;
    position: relative;
    box-shadow: var(--shadow);
  }
  
  /* Enhanced tabs */
  .tabs{
    display: flex;
    gap: var(--spacing-sm);
    border-bottom: 1px solid var(--line);
    background: #f8fafc;
    position: sticky;
    top: 0;
    z-index: 2;
    padding: 0 var(--spacing-lg);
  }
  
  .tab{
    padding: var(--spacing-md) var(--spacing-lg);
    cursor: pointer;
    user-select: none;
    font-weight: 500;
    color: var(--muted);
    border-bottom: 2px solid transparent;
    transition: all 0.2s ease;
    position: relative;
  }
  
  .tab:hover{
    color: var(--ink);
    background: rgba(49, 130, 206, 0.05);
  }
  
  .tab.active{
    border-bottom-color: var(--accent);
    color: var(--accent);
    font-weight: 600;
    background: rgba(49, 130, 206, 0.08);
  }
  
  .tab.active::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--accent);
    border-radius: 1px;
    box-shadow: 0 0 8px rgba(49, 130, 206, 0.4);
  }
  
  .view{
    display: none;
    padding: 0;
  }
  
  .view.active{
    display: block;
  }
  
  /* Enhanced graph and timeline */
  #graph svg, #timeline svg{
    width: 100%;
    height: 72vh;
    display: block;
    background: radial-gradient(1200px 800px at 60% -20%, rgba(49, 130, 206, 0.08), transparent 60%);
    border-radius: var(--radius-md);
  }
  
  #graph, #timeline {
    padding: var(--spacing-lg);
    background: var(--panel);
    border-radius: var(--radius-md);
    margin: var(--spacing-lg);
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
  }
  
  /* Enhanced legend */
  .legend{
    display: flex;
    gap: var(--spacing-md);
    padding: var(--spacing-md) var(--spacing-lg);
    border-bottom: 1px solid var(--line);
    align-items: center;
    color: var(--muted);
    flex-wrap: wrap;
    background: #f8fafc;
  }
  
  .legend .group{
    display: flex;
    gap: var(--spacing-sm);
    align-items: center;
  }
  
  /* Enhanced node styles */
  .node{
    cursor: pointer;
  }
  
  .node rect{
    fill: var(--panel);
    stroke: var(--line);
    rx: var(--radius-md);
    transition: all 0.2s ease;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
  }
  
    .node:hover rect{
    stroke: var(--accent);
    stroke-width: 2px;
    filter: drop-shadow(0 4px 8px rgba(49, 130, 206, 0.2));
    transform: translateY(-2px);
  }
  
  .node.critical rect{
    stroke: var(--crit);
    stroke-width: 2;
    fill: #fed7d7;
  }
  
  .node.selected rect{
    stroke: var(--accent);
    stroke-width: 2;
    filter: drop-shadow(0 0 0 3px rgba(49, 130, 206, 0.3));
  }
  
  .node .title{
    font-weight: 600;
    font-size: var(--font-size-sm);
  }
  
  /* Enhanced edge styles */
  .edge{
    stroke: var(--line);
    stroke-width: 1.5;
    transition: all 0.2s ease;
  }
  
  .edge:hover{
    stroke: var(--accent);
    stroke-width: 2;
  }
  
  .edge.critical{
    stroke: var(--crit);
    stroke-width: 2;
  }
  
  .edge.arrow{
    marker-end: url(#arrow);
  }
  
  /* Enhanced Gantt chart */
  .gantt .bar{
    stroke: var(--line);
    fill: #a0aec0;
    transition: all 0.2s ease;
    filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.05));
  }
  

  
  .gantt .bar:hover{
    stroke: var(--accent);
    stroke-width: 2;
    filter: drop-shadow(0 2px 4px rgba(49, 130, 206, 0.2));
  }
  
  .gantt .bar.critical rect{
    stroke: var(--crit);
    stroke-width: 2;
    fill: #f56565;
  }
  
  .gantt .bar.selected rect{
    stroke: var(--accent);
    stroke-width: 2;
    filter: drop-shadow(0 0 0 3px rgba(49, 130, 206, 0.3));
  }
  
  .gantt .bar .label{
    font-size: 13px;
    fill: var(--ink);
    font-weight: 500;
  }
  
  /* Enhanced task names in timeline for better visibility */
  .gantt .bar .label[text-anchor="end"]{
    font-size: 14px;
    fill: var(--ink);
    font-weight: 600;
    font-family: var(--font-family);
  }
  
  /* Task name labels specifically (positioned at P-8) */
  .gantt .bar text.label[text-anchor="end"]{
    font-size: 14px;
    fill: var(--ink);
    font-weight: 700;
    dominant-baseline: middle;
    text-rendering: optimizeLegibility;
  }
  
  /* Duration and percentage labels - make them more readable */
  .gantt .bar .label:not([text-anchor="end"]){
    font-size: 13px;
    fill: var(--ink);
    font-weight: 700;
  }
  
  /* Task name background styling */
  .taskNameBg{
    opacity: 0.95;
    filter: drop-shadow(0 1px 3px rgba(0, 0, 0, 0.15));
  }
  
  .gantt .handle{
    fill: #94a3b8;
    cursor: ew-resize;
  }
  
  .gantt .bar.moved{
    filter: drop-shadow(0 0 10px rgba(49, 130, 206, 0.35));
  }
  
  .gantt .bar.invalid rect{
    stroke: var(--error) !important;
    fill: #fed7d7;
  }
  
  .gantt .bar.valid rect{
    outline: 2px solid #9ae6b4;
  }
  
  .gantt .milestone{
    stroke-width: 2;
    fill: var(--panel);
  }
  
  .gantt .milestone.critical{
    fill: #fed7d7;
    stroke: var(--crit);
  }
  
  .gantt .bar .progress{
    opacity: 0.85;
  }
  
  /* Enhanced axis */
  .axis{
    stroke: var(--line);
  }
  
  .axis text{
    fill: var(--ink);
    font-size: 12px;
    font-weight: 600;
    font-family: var(--font-family);
  }
  
  /* Ensure all timeline text is highly readable */
  #timeline svg text {
    font-weight: 600;
    text-rendering: optimizeLegibility;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }
  
  /* Task labels specifically */
  #timeline .gantt .bar text.label {
    font-weight: 700;
    fill: var(--ink);
  }
  
  /* Enhanced issues */
    .issues{
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
    padding: var(--spacing-lg);
    background: var(--panel);
    border-radius: var(--radius-md);
    margin: var(--spacing-lg);
    border: 1px solid var(--line);
  }
  
  .issue{
    display: grid;
    grid-template-columns: 1fr auto;
    align-items: center;
    gap: var(--spacing-md);
    background: var(--panel);
    border: 1px solid var(--line);
    border-left-width: 4px;
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    transition: all 0.2s ease;
  }
  
  .issue:hover{
    transform: translateX(2px);
    box-shadow: var(--shadow);
  }
  
  .sev-info{border-left-color: var(--info)}
  .sev-warn{border-left-color: var(--warn)}
  .sev-error{border-left-color: var(--error)}
  .sev-critical{border-left-color: var(--crit)}
  
  .issue .meta{
    font-size: var(--font-size-sm);
    color: var(--muted);
  }
  
  .issue .msg{
    font-weight: 600;
    color: var(--ink);
  }
  
  .issue .actions{
    display: flex;
    gap: var(--spacing-sm);
  }
  
  /* Enhanced focus section */
  .focus{
    padding: var(--spacing-xl);
  }
  
  .focus-header {
    text-align: center;
    margin-bottom: var(--spacing-2xl);
    padding-bottom: var(--spacing-lg);
    border-bottom: 1px solid var(--line);
  }
  
  .focus-header h2 {
    color: var(--ink);
    font-size: var(--font-size-xl);
    font-weight: 700;
    margin: 0 0 var(--spacing-sm) 0;
  }
  
  .focus-description {
    color: var(--muted);
    font-size: var(--font-size-sm);
    margin: 0;
  }
  
  .focus-section {
    margin-bottom: var(--spacing-2xl);
  }
  
  .focus h3{
    margin: var(--spacing-sm) 0 var(--spacing-md);
    color: var(--accent);
    font-size: var(--font-size-lg);
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
  }
  
  .focus .cards{
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-lg);
    margin-bottom: var(--spacing-2xl);
  }
  
  /* Base card styles */
  .card{
    background: var(--panel);
    border: 1px solid var(--line);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
    transition: transform var(--transition-normal), box-shadow var(--transition-normal), border-color var(--transition-normal);
    box-shadow: var(--shadow);
    position: relative;
    overflow: hidden;
    will-change: transform;
  }
  
  .card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--accent), var(--accent-light));
    opacity: 0;
    transition: opacity 0.2s ease;
  }
  
  .card:hover{
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
    border-color: var(--accent);
  }
  
  .card:hover::before {
    opacity: 1;
  }
  
  /* Metric card variant */
  .metric-card {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    padding: var(--spacing-xl);
  }
  
  .card-icon {
    font-size: 2rem;
    opacity: 0.8;
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(49, 130, 206, 0.1);
    border-radius: var(--radius-lg);
    color: var(--accent);
  }
  
  .card-content {
    flex: 1;
  }
  
  .card-label {
    font-size: var(--font-size-sm);
    color: var(--muted);
    font-weight: 500;
    margin-bottom: var(--spacing-xs);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  
  .metric{
    font-size: 2rem;
    font-weight: 700;
    color: var(--accent);
    margin: 0;
  }
  
  /* Enhanced list styles */
  .list{
    display: grid;
    gap: var(--spacing-sm);
    max-height: 45vh;
    overflow: auto;
  }
  
  .list .row{
    display: flex;
    gap: var(--spacing-md);
    align-items: center;
    justify-content: space-between;
    padding: var(--spacing-sm) var(--spacing-md);
    border-bottom: 1px dashed var(--line);
    transition: background-color var(--transition-normal), transform var(--transition-normal), box-shadow var(--transition-normal), border-bottom-color var(--transition-normal);
    will-change: transform;
    border-radius: var(--radius-sm);
    margin: var(--spacing-xs) 0;
  }
  
  .list .row:hover{
    background: #f7fafc;
    transform: translateX(4px);
    box-shadow: var(--shadow);
    border-bottom-color: var(--accent);
  }
  
  .row .slack{
    font-variant-numeric: tabular-nums;
    font-weight: 600;
    color: var(--accent);
  }
  
  /* Enhanced keyboard shortcuts */
  .kbd{
    padding: var(--spacing-xs) var(--spacing-sm);
    border: 1px solid var(--line);
    border-bottom-width: 2px;
    background: #f8fafc;
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
    color: var(--muted);
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    transition: transform var(--transition-normal), box-shadow var(--transition-normal), border-color var(--transition-normal);
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    will-change: transform;
  }
  
  .kbd:hover{
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    border-color: var(--accent);
  }
  
  /* Enhanced hints and toasts with accessibility */
  .hint{
    position: fixed;
    z-index: 10;
    background: var(--panel);
    border: 1px solid #fde68a;
    box-shadow: var(--shadow-lg);
    border-radius: var(--radius-md);
    padding: var(--spacing-sm) var(--spacing-md);
    font-size: var(--font-size-sm);
    color: #7a5d00;
    display: none;
    backdrop-filter: blur(8px);
    animation: slideIn 0.3s ease-out;
    max-width: 300px;
    word-wrap: break-word;
  }
  
  /* Screen reader only text */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }
  
  /* Enhanced focus indicators for keyboard navigation */
  .btn:focus-visible,
  .form-input:focus-visible,
  select:focus-visible,
  .tab:focus-visible,
  .tag:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
    box-shadow: 0 0 0 4px rgba(49, 130, 206, 0.1);
  }
  
  /* Focus management for interactive elements */
  .tab:focus-visible {
    background: var(--accent-light);
    border-color: var(--accent);
  }
  
  .tag:focus-visible {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
  }
  
  /* Enhanced keyboard navigation for lists */
  .list .row:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
    background: var(--accent-light);
  }
  
  /* Focus management for cards */
  .card:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
    box-shadow: 0 0 0 4px rgba(49, 130, 206, 0.1);
  }
  
  /* Skip to main content link */
  .skip-link {
    position: absolute;
    top: -40px;
    left: 6px;
    background: var(--accent);
    color: white;
    padding: 8px;
    text-decoration: none;
    border-radius: var(--radius-sm);
    z-index: 1000;
    transition: top 0.3s;
  }
  
  .skip-link:focus {
    top: 6px;
  }
  
  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  /* Enhanced animations for better UX */
  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }
  
  @keyframes slideInLeft {
    from {
      opacity: 0;
      transform: translateX(-20px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }
  
  @keyframes slideInRight {
    from {
      opacity: 0;
      transform: translateX(20px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }
  
  @keyframes scaleIn {
    from {
      opacity: 0;
      transform: scale(0.9);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }
  
  /* Animation classes for dynamic content */
  .animate-fade-in {
    animation: fadeIn var(--transition-normal) ease-out;
  }
  
  .animate-slide-in-left {
    animation: slideInLeft var(--transition-normal) ease-out;
  }
  
  .animate-slide-in-right {
    animation: slideInRight var(--transition-normal) ease-out;
  }
  
  .animate-scale-in {
    animation: scaleIn var(--transition-normal) ease-out;
  }
  
  /* Staggered animations for lists */
  .list .row:nth-child(1) { animation-delay: 0.1s; }
  .list .row:nth-child(2) { animation-delay: 0.2s; }
  .list .row:nth-child(3) { animation-delay: 0.3s; }
  .list .row:nth-child(4) { animation-delay: 0.4s; }
  .list .row:nth-child(5) { animation-delay: 0.5s; }
  
  /* Reduced motion support */
  @media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
      animation-duration: var(--motion-reduce) !important;
      animation-iteration-count: 1 !important;
      transition-duration: var(--motion-reduce) !important;
    }
    
    .card:hover,
    .btn:hover,
    .list .row:hover {
      transform: none !important;
    }
  }
  
  .toast{
    position: fixed;
    right: 14px;
    bottom: 14px;
    background: var(--panel);
    border: 1px solid var(--line);
    box-shadow: var(--shadow-xl);
    padding: var(--spacing-md) var(--spacing-lg);
    border-radius: var(--radius-md);
    color: var(--ink);
    display: none;
    backdrop-filter: blur(8px);
    border-left: 4px solid var(--accent);
  }
  
  /* Enhanced timeline */
  #timeline{
    position: relative;
  }
  
  
  /* Enhanced context menu */
  .ctx-menu{
    position: fixed;
    display: none;
    background: var(--panel);
    border: 1px solid var(--line);
    box-shadow: var(--shadow-xl);
    border-radius: var(--radius-md);
    z-index: 1000;
    backdrop-filter: blur(8px);
    min-width: 160px;
  }
  
  .ctx-menu div{
    padding: var(--spacing-sm) var(--spacing-lg);
    cursor: pointer;
    transition: background-color var(--transition-normal), transform var(--transition-normal), color var(--transition-normal);
    border-radius: var(--radius-sm);
    margin: var(--spacing-xs) var(--spacing-sm);
    will-change: transform;
  }
  
  .ctx-menu div:hover{
    background: #f7fafc;
    transform: translateX(4px);
    color: var(--accent);
  }
  
  /* Enhanced toolbar */
  .toolbar{
    display: flex;
    gap: var(--spacing-sm);
    align-items: center;
  }
  
  /* Enhanced group headers */
  .groupHeader{
    fill: #f8fafc;
    stroke: #e2e8f0;
    filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.05));
    opacity: 0.8;
  }
  
  .groupLabel{
    font-size: 13px;
    fill: var(--ink);
    font-weight: 600;
    font-family: var(--font-family);
  }
  
  /* Enhanced loading states */
  .loading-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 60vh;
    text-align: center;
    gap: var(--spacing-lg);
  }
  
  .loading-spinner {
    width: 48px;
    height: 48px;
    border: 4px solid var(--line);
    border-top: 4px solid var(--accent);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .loading-tip {
    background: var(--accent-light);
    border: 1px solid var(--accent);
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    max-width: 400px;
    font-size: var(--font-size-sm);
  }
  
  .tip-icon {
    margin-right: var(--spacing-xs);
    opacity: 0.7;
  }
  
  /* Enhanced bulk edit section */
  .bulk{
    display: grid;
    gap: var(--spacing-md);
    padding: var(--spacing-lg);
    background: var(--panel);
    border-radius: var(--radius-md);
    border: 1px solid var(--line);
    margin: var(--spacing-lg);
  }
  
  .bulk .row{
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--spacing-md);
    padding: var(--spacing-md);
    background: #f8fafc;
    border-radius: var(--radius-sm);
    border: 1px solid var(--line);
    transition: background-color var(--transition-normal), border-color var(--transition-normal), transform var(--transition-normal), box-shadow var(--transition-normal);
    will-change: transform;
  }
  
  .bulk .row:hover{
    background: #f1f5f9;
    border-color: var(--accent);
    transform: translateY(-1px);
    box-shadow: var(--shadow);
  }
  
  .bulk .row-3{
    grid-template-columns: 1fr 1fr 1fr;
  }
  
  /* Utility classes for better maintainability */
  .text-center { text-align: center; }
  .text-left { text-align: left; }
  .text-right { text-align: right; }
  
  .font-bold { font-weight: 700; }
  .font-semibold { font-weight: 600; }
  .font-medium { font-weight: 500; }
  .font-normal { font-weight: 400; }
  
  .text-sm { font-size: var(--font-size-sm); }
  .text-md { font-size: var(--font-size-md); }
  .text-lg { font-size: var(--font-size-lg); }
  .text-xl { font-size: var(--font-size-xl); }
  
  .text-muted { color: var(--muted); }
  .text-accent { color: var(--accent); }
  .text-success { color: var(--success); }
  .text-warning { color: var(--warning); }
  .text-error { color: var(--error); }
  
  .bg-panel { background: var(--panel); }
  .bg-accent-light { background: var(--accent-light); }
  .bg-success-light { background: #f0fdf4; }
  .bg-warning-light { background: #fffbeb; }
  .bg-error-light { background: #fef2f2; }
  
  .border { border: 1px solid var(--line); }
  .border-accent { border-color: var(--accent); }
  .border-success { border-color: var(--success); }
  .border-warning { border-color: var(--warning); }
  .border-error { border-color: var(--error); }
  
  .rounded-sm { border-radius: var(--radius-sm); }
  .rounded-md { border-radius: var(--radius-md); }
  .rounded-lg { border-radius: var(--radius-lg); }
  .rounded-full { border-radius: 9999px; }
  
  .shadow-sm { box-shadow: var(--shadow-sm); }
  .shadow { box-shadow: var(--shadow); }
  .shadow-md { box-shadow: var(--shadow-md); }
  .shadow-lg { box-shadow: var(--shadow-lg); }
  .shadow-xl { box-shadow: var(--shadow-xl); }
  
  .p-xs { padding: var(--spacing-xs); }
  .p-sm { padding: var(--spacing-sm); }
  .p-md { padding: var(--spacing-md); }
  .p-lg { padding: var(--spacing-lg); }
  .p-xl { padding: var(--spacing-xl); }
  
  .m-xs { margin: var(--spacing-xs); }
  .m-sm { margin: var(--spacing-sm); }
  .m-md { margin: var(--spacing-md); }
  .m-lg { margin: var(--spacing-lg); }
  .m-xl { margin: var(--spacing-xl); }
  
  .flex { display: flex; }
  .flex-col { flex-direction: column; }
  .flex-row { flex-direction: row; }
  .items-center { align-items: center; }
  .items-start { align-items: flex-start; }
  .items-end { align-items: flex-end; }
  .justify-center { justify-content: center; }
  .justify-between { justify-content: space-between; }
  .justify-start { justify-content: flex-start; }
  .justify-end { justify-content: flex-end; }
  
  .hidden { display: none; }
  .block { display: block; }
  .inline-block { display: inline-block; }
  .inline { display: inline; }
  
  .w-full { width: 100%; }
  .w-auto { width: auto; }
  .h-full { height: 100%; }
  .h-auto { height: auto; }
  
  .cursor-pointer { cursor: pointer; }
  .cursor-not-allowed { cursor: not-allowed; }
  .cursor-default { cursor: default; }
  
  .select-none { user-select: none; }
  .select-text { user-select: text; }
  
  .overflow-hidden { overflow: hidden; }
  .overflow-auto { overflow: auto; }
  .overflow-scroll { overflow: scroll; }
  
  /* Enhanced inline edit */
  .inline-edit{
    display: grid;
    gap: var(--spacing-sm);
  }
  
  .inline-edit .row{
    display: grid;
    grid-template-columns: 1fr 60px 1fr 1fr 60px;
    gap: var(--spacing-sm);
    align-items: center;
    transition: background-color var(--transition-normal);
  }
  
  .inline-edit .row:hover {
    background: var(--accent-light);
  }
  
  /* Enhanced modal */
  .modal{
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(2, 6, 23, 0.6);
    backdrop-filter: blur(4px);
  }
  
  .modal .panel{
    background: var(--panel);
    border: 1px solid var(--line);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-xl);
    width: min(880px, 94vw);
    max-height: 85vh;
    overflow: auto;
  }
  
  .modal header{
    position: sticky;
    top: 0;
    box-shadow: none;
  }
  
  .wizard-step{
    padding: var(--spacing-xl);
  }
  
  .wizard-controls{
    display: flex;
    justify-content: flex-end;
    gap: var(--spacing-md);
    padding: 0 var(--spacing-xl) var(--spacing-xl);
  }
  
  /* Enhanced print styles */
  @media print{
    header, aside, .tabs, #timeline, #graph, #compare, .badges{
      display: none !important;
    }
    main{
      border: none;
    }
    .view#focus{
      display: block !important;
    }
    body{
      background: white;
      color: black;
    }
    .card, .list .row{
      border-color: #e5e7eb;
    }
  }
  
  /* Responsive improvements */
  @media (max-width: 1200px) {
    .layout {
      grid-template-columns: 350px 1fr;
      gap: var(--spacing-lg);
      padding: var(--spacing-lg);
    }
    
    .focus .cards {
      grid-template-columns: repeat(2, 1fr);
    }
  }
  
  @media (max-width: 768px) {
    .layout {
      grid-template-columns: 1fr;
      gap: var(--spacing-md);
      padding: var(--spacing-md);
    }
    
    aside {
      position: static;
      height: auto;
      max-height: 400px;
    }
    
    .focus .cards {
      grid-template-columns: 1fr;
    }
    
    header {
      flex-wrap: wrap;
      gap: var(--spacing-sm);
    }
    
    header .right {
      margin-left: 0;
      width: 100%;
      justify-content: center;
      margin-top: var(--spacing-sm);
    }
    
    /* Enhanced mobile navigation */
    .legend {
      flex-direction: column;
      gap: var(--spacing-md);
    }
    
    .legend .group {
      flex-direction: column;
      align-items: stretch;
    }
    
    .legend .group > * {
      width: 100%;
      text-align: center;
    }
    
    /* Mobile-optimized form inputs */
    .form-input {
      font-size: 16px; /* Prevents zoom on iOS */
    }
    
    /* Mobile-optimized buttons */
    .btn {
      min-height: 44px; /* Touch-friendly sizing */
      padding: var(--spacing-sm) var(--spacing-lg);
    }
    
    /* Mobile-optimized context menu */
    .ctx-menu {
      min-width: 200px;
      font-size: var(--font-size-md);
    }
    
    .ctx-menu div {
      padding: var(--spacing-md) var(--spacing-lg);
    }
  }
  
  /* Enhanced tablet breakpoint */
  @media (min-width: 769px) and (max-width: 1024px) {
    .layout {
      grid-template-columns: 300px 1fr;
    }
    
    .cards {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .subsys {
      grid-template-columns: repeat(2, 1fr);
    }
  }
  
  /* Enhanced large screen optimizations */
  @media (min-width: 1025px) {
    .layout {
      grid-template-columns: 350px 1fr;
    }
    
    .cards {
      grid-template-columns: repeat(4, 1fr);
    }
    
    .subsys {
      grid-template-columns: repeat(3, 1fr);
    }
  }
  
  /* Enhanced print styles */
  @media print {
    * {
      background: transparent !important;
      color: black !important;
      box-shadow: none !important;
      text-shadow: none !important;
    }
    
    .layout {
      grid-template-columns: 1fr;
      gap: 0;
    }
    
    aside {
      display: none;
    }
    
    .tabs {
      display: none;
    }
    
    .legend {
      display: none;
    }
    
    .btn {
      display: none;
    }
    
    .ctx-menu {
      display: none;
    }
    
    .toast {
      display: none;
    }
    
    .hint {
      display: none;
    }
    
    .modal {
      display: none;
    }
    
    #timeline {
      page-break-inside: avoid;
    }
    
    .card {
      page-break-inside: avoid;
      border: 1px solid #ccc;
      margin-bottom: 1em;
    }
    
    .list .row {
      page-break-inside: avoid;
      border-bottom: 1px solid #ccc;
    }
  }
  
  /* Loading and error states */
  #boot {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100vh;
    background: var(--bg);
  }
  
  .loading-container {
    text-align: center;
    max-width: 400px;
    padding: var(--spacing-2xl);
  }
  
  .loading-spinner {
    width: 60px;
    height: 60px;
    border: 4px solid var(--line);
    border-top: 4px solid var(--accent);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto var(--spacing-xl);
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .loading-container h2 {
    color: var(--ink);
    font-size: var(--font-size-xl);
    font-weight: 700;
    margin: 0 0 var(--spacing-sm) 0;
  }
  
  .loading-container p {
    color: var(--muted);
    font-size: var(--font-size-sm);
    margin: 0 0 var(--spacing-lg) 0;
  }
  
  .loading-tip {
    background: rgba(49, 130, 206, 0.1);
    border: 1px solid var(--accent-light);
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    color: var(--accent-dark);
    font-size: var(--font-size-sm);
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
  }
  
  .tip-icon {
    font-size: 1.2em;
  }
  
  #fatal {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #fed7d7;
    border: 1px solid var(--error);
    color: var(--error);
    padding: var(--spacing-xl);
    border-radius: var(--radius-lg);
    max-width: 500px;
    text-align: center;
    box-shadow: var(--shadow-xl);
  }
  
  /* Smooth scrolling */
  html {
    scroll-behavior: smooth;
  }
  
  /* Enhanced focus states */
  .btn:focus, .form-input:focus, .tab:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.2);
  }
  
  /* Apply animations to key elements */
  .layout {
    animation: fadeIn 0.6s ease-out;
  }
  
  .card, .metric-card, .issue {
    animation: fadeIn 0.4s ease-out;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }
  
  /* Custom scrollbar */
  ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }
  
  ::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: var(--radius-sm);
  }
  
  ::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: var(--radius-sm);
  }
  
  ::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
  }
</style>

</head>
<body>
  <a href="#appRoot" class="skip-link">Skip to main content</a>
  <header>
    <div class="header-left">
      <h1>
        <span class="title-icon" aria-hidden="true">ğŸ“Š</span>
        HPC/AI Project Planner
        <small class="subtitle">â€” offline â€¢ single file</small>
      </h1>
    </div>
    
    <div class="header-center">
      <div class="button-group">
        <button class="btn" id="btnNew" aria-label="Create new project">
          <span class="btn-icon" aria-hidden="true">âœ¨</span>
          New
        </button>
        <button class="btn" id="btnLoad" aria-label="Open existing project file">
          <span class="btn-icon" aria-hidden="true">ğŸ“</span>
          Openâ€¦
        </button>
        <button class="btn" id="btnSave" aria-label="Save current project">
          <span class="btn-icon" aria-hidden="true">ğŸ’¾</span>
          Save
        </button>
        <button class="btn" id="btnExportJSON" aria-label="Export project data as JSON">
          <span class="btn-icon" aria-hidden="true">ğŸ“¤</span>
          Export JSON
        </button>
        <button class="btn" id="btnExportCSV" aria-label="Export project data as CSV">
          <span class="btn-icon" aria-hidden="true">ğŸ“Š</span>
          Export CSV
        </button>
        <button class="btn small" id="btnUndo" title="Ctrl+Z" aria-label="Undo last action">
          <span class="btn-icon" aria-hidden="true">â†¶</span>
          Undo
        </button>
        <button class="btn small" id="btnRedo" title="Ctrl+Y" aria-label="Redo last undone action">
          <span class="btn-icon" aria-hidden="true">â†·</span>
          Redo
        </button>
        <button class="btn accent" id="btnPrint" aria-label="Print project or export as PDF">
          <span class="btn-icon" aria-hidden="true">ğŸ–¨ï¸</span>
          Print / PDF
        </button>
        <button class="btn" id="btnGuide" aria-label="Show user guide and help" onclick="document.getElementById('guided-workflow').style.display = 'block';">
          <span class="btn-icon" aria-hidden="true">â“</span>
          Guide
        </button>
      </div>
    </div>
    
    <div class="right">
      <div class="status-indicators">
        <span class="pill status-pill" id="selBadge" role="status" aria-live="polite">
          <span class="pill-icon" aria-hidden="true">ğŸ¯</span>
          0 selected
        </span>
        <span class="pill status-pill" id="scenarioBadge" role="status" aria-live="polite">
          <span class="pill-icon" aria-hidden="true">âš™ï¸</span>
          Scenario: Working
        </span>
      </div>
      
    </div>
  </header>
  <div id="boot">
    <div class="loading-container">
      <div class="loading-spinner" role="status" aria-label="Loading application"></div>
      <h2>Loading HPC/AI Project Planner</h2>
      <p>Initializing application components...</p>
      <div class="loading-tip">
        <span class="tip-icon" aria-hidden="true">ğŸ’¡</span>
        If this persists, press F12 â†’ Console and share any red error message.
      </div>
    </div>
  </div>
  <div id="fatal"></div>
  <div class="layout" style="display:none" id="appRoot">
    <aside>
      <h2><span class="section-icon" aria-hidden="true">ğŸ“…</span> Project Settings</h2>
      <div class="row">
        <label class="form-label">
          <span class="label-icon" aria-hidden="true">ğŸ“…</span>
          Start date
          <input type="date" id="startDate" class="form-input" aria-describedby="startDateHelp">
        </label>
        <div id="startDateHelp" class="sr-only">Select the project start date</div>
      </div>
      <div class="row">
        <label class="form-label">
          <span class="label-icon" aria-hidden="true">ğŸ—“ï¸</span>
          Calendar
          <select id="calendarMode" class="form-input" aria-describedby="calendarModeHelp">
            <option value="workdays">Working days (Monâ€“Fri + holidays)</option>
            <option value="calendar">Calendar days</option>
          </select>
        </label>
        <div id="calendarModeHelp" class="sr-only">Choose between working days or calendar days for project scheduling</div>
      </div>
      <div class="row" style="align-items:flex-start">
        <label class="form-label full-width">
          <span class="label-icon" aria-hidden="true">ğŸ‰</span>
          Holidays (YYYYâ€‘MMâ€‘DD)
          <textarea id="holidayInput" placeholder="2025-01-01, 2025-05-01, 2025-12-25" class="form-input" aria-describedby="holidayInputHelp"></textarea>
        </label>
        <div id="holidayInputHelp" class="sr-only">Enter holiday dates in YYYY-MM-DD format, separated by commas</div>
      </div>
      <div class="row">
        <label class="form-label">
          <span class="label-icon" aria-hidden="true">â°</span>
          Slack threshold
          <input type="number" id="slackThreshold" min="0" value="2" class="form-input" aria-describedby="slackThresholdHelp"> days
        </label>
        <div id="slackThresholdHelp" class="sr-only">Set the minimum slack threshold in days for highlighting critical paths</div>
      </div>

      <h2><span class="section-icon" aria-hidden="true">ğŸ”</span> Filter & Group</h2>
              <div class="row">
          <div class="search-container">
            <span class="search-icon" aria-hidden="true">ğŸ”</span>
            <input type="text" id="filterText" placeholder="Filter by name or phaseâ€¦" class="form-input search-input" aria-label="Filter tasks by name or phase">
          </div>
        </div>
      <div class="row">
        <label class="form-label">
          <span class="label-icon" aria-hidden="true">ğŸ“Š</span>
          Group by
          <select id="groupBy" class="form-input" aria-describedby="groupByHelp">
            <option value="none">None</option>
            <option value="phase">Phase</option>
            <option value="subsystem">Subsystem</option>
          </select>
        </label>
        <div id="groupByHelp" class="sr-only">Choose how to group and organize tasks in the display</div>
      </div>
      <div class="row filter-actions">
        <button class="btn small" id="btnFilterClear" aria-label="Clear all active filters">
          <span class="btn-icon" aria-hidden="true">ğŸ§¹</span>
          Clear filters
        </button>
        <button class="btn small" id="btnSelectFiltered" aria-label="Select all filtered tasks">
          <span class="btn-icon" aria-hidden="true">âœ…</span>
          Select filtered
        </button>
        <button class="btn small" id="btnClearSel" aria-label="Clear current task selection">
          <span class="btn-icon" aria-hidden="true">âŒ</span>
          Clear selection
        </button>
      </div>

      <h2><span class="section-icon" aria-hidden="true">ğŸ¨</span> Subsystem Legend</h2>
      <div class="row subsystem-controls">
        <button class="btn small" id="btnSubAll">
          <span class="btn-icon">âœ…</span>
          Select All
        </button>
        <button class="btn small" id="btnSubNone">
          <span class="btn-icon">âŒ</span>
          Clear All
        </button>
      </div>
      <div class="subsys" id="subsysFilters"></div>

      <h2>Edit Selected (<span id="inlineCount">0</span>)</h2>
      <div class="inline-edit" id="inlineEdit"></div>

      <details>
        <summary>
          <h2>Bulk Edit (<span id="bulkCount">0</span>)</h2>
        </summary>
        <div class="bulk">
          <div class="row-3 row">
            <label>Phase <input type="text" id="bulkPhase" placeholder="leave blank = skip"></label>
            <label>Subsystem
              <select id="bulkSub">
                <option value="">â€”</option>
                <option>System</option><option>power/VRM</option><option>PCIe</option><option>BMC</option><option>BIOS</option><option>FW</option><option>Mech</option><option>Thermal</option>
              </select>
            </label>
            <label>Active <select id="bulkActive"><option value="">â€”</option><option value="true">true</option><option value="false">false</option></select></label>
          </div>
          <div class="row-3 row">
            <label>Duration <input type="number" id="bulkDur" min="0" placeholder="e.g. 5"></label>
            <label>Mode
              <select id="bulkDurMode"><option value="set">set</option><option value="add">+/-</option></select>
            </label>
            <label>Name prefix <input type="text" id="bulkPrefix" placeholder="e.g. [R1]"></label>
          </div>
          <div class="row">
            <label>Progress (%) <input type="number" id="bulkPct" min="0" max="100" placeholder="0"></label>
          </div>
          <div class="row">
            <label>Add dependency token <input type="text" id="bulkAddDep" placeholder="e.g. FS:mobo_assembly+2d"></label>
            <label><input type="checkbox" id="bulkClearDeps"> clear all deps</label>
          </div>
          <div class="row">
            <label>Shift with SNET (+/â€‘ days) <input type="number" id="bulkShift" placeholder="0"></label>
            <div style="display:flex; gap:.35rem"><button class="btn small" id="btnApplyBulk">Apply</button><button class="btn small" id="btnBulkReset">Reset fields</button></div>
          </div>
        </div>
      </details>

      <details>
        <summary>
          <h2>Templates</h2>
        </summary>
        <div class="row">
          <label>Library
            <select id="tplSelect">
              <option value="hpc">HPC Bringâ€‘up (sample)</option>
              <option value="sw">Software Sprint (2â€‘week)</option>
              <option value="hw">Board Spin Cycle</option>
            </select>
          </label>
        </div>
        <div class="row" style="gap:.4rem; flex-wrap:wrap">
          <button class="btn" id="btnInsertTpl">Insert library</button>
        </div>
      </details>

      <details>
        <summary>
          <h2>Validation & Warnings</h2>
        </summary>
        <div class="row" style="justify-content:flex-start; gap:.5rem">
          <button class="btn small" id="btnAutoFix">Autoâ€‘fix common</button>
          <select id="severityFilter">
            <option value="all">Show: All</option>
            <option value="critical">Critical only</option>
            <option value="error">Errors & up</option>
            <option value="warn">Warnings & up</option>
            <option value="info">Info only</option>
          </select>
        </div>
        <div class="issues" id="issues"></div>
      </details>
    </aside>

    <main role="main" aria-label="Project planning workspace">
      <div class="tabs" role="tablist" aria-label="Project views">
        <div class="tab active" data-tab="timeline" role="tab" aria-selected="true" aria-controls="timeline">Timeline</div>
        <div class="tab" data-tab="graph" role="tab" aria-selected="false" aria-controls="graph">Dependency Graph</div>
        <div class="tab" data-tab="focus" role="tab" aria-selected="false" aria-controls="focus">Where to focus</div>
        <div class="tab" data-tab="compare" role="tab" aria-selected="false" aria-controls="compare">Compare</div>
      </div>
      <div class="legend" role="region" aria-label="Chart legend and controls">
        <div class="group">
          <span class="pill">Links: FS/SS/FF/SF + \+/- lag (d or w)</span>
          <span class="pill">Constraints: MSO / SNET</span>
          <span class="pill">Severities: info / warn / error / critical</span>
        </div>
        <div class="group" style="margin-left:auto">
          <span>Timeline</span>
          <button class="btn small" id="zoomOutTL" aria-label="Zoom out timeline">âˆ’</button>
          <button class="btn small" id="zoomInTL" aria-label="Zoom in timeline">+</button>
          <button class="btn small" id="zoomResetTL" aria-label="Reset timeline zoom">Fit</button>
          <span style="margin-left:.5rem">Graph</span>
          <button class="btn small" id="zoomOutGR" aria-label="Zoom out graph">âˆ’</button>
          <button class="btn small" id="zoomInGR" aria-label="Zoom in graph">+</button>
          <button class="btn small" id="zoomResetGR" aria-label="Reset graph zoom">Fit</button>
        </div>
      </div>
      <section id="timeline" class="view active" role="tabpanel" aria-label="Project timeline view">
        <svg id="gantt" class="gantt" role="img" aria-label="Gantt chart showing project timeline"></svg>
      </section>
      <section id="graph" class="view" role="tabpanel" aria-label="Dependency graph view">
        <svg id="graphSvg" role="img" aria-label="Dependency graph showing task relationships"></svg>
      </section>
      <section id="focus" class="view" role="tabpanel" aria-label="Project focus and analysis view">
        <div class="focus">
          <div class="focus-header">
            <h2><span class="section-icon" aria-hidden="true">ğŸ¯</span> Project Overview</h2>
            <p class="focus-description">Key metrics and areas requiring attention</p>
          </div>
          
          <div class="cards">
            <div class="card metric-card" role="region" aria-label="Planned finish date">
              <div class="card-icon" aria-hidden="true">ğŸ“…</div>
              <div class="card-content">
                <div class="card-label">Planned Finish</div>
                <div class="metric" id="finishMetric" aria-live="polite">â€”</div>
              </div>
            </div>
            <div class="card metric-card" role="region" aria-label="Critical tasks count">
              <div class="card-icon" aria-hidden="true">ğŸš¨</div>
              <div class="card-content">
                <div class="card-label">Critical Tasks</div>
                <div class="metric" id="critMetric" aria-live="polite">â€”</div>
              </div>
            </div>
            <div class="card metric-card" role="region" aria-label="Total tasks count">
              <div class="card-icon" aria-hidden="true">ğŸ“‹</div>
              <div class="card-content">
                <div class="card-label">Total Tasks</div>
                <div class="metric" id="countMetric" aria-live="polite">â€”</div>
              </div>
            </div>
            <div class="card metric-card" role="region" aria-label="Change impact assessment">
              <div class="card-icon" aria-hidden="true">âš¡</div>
              <div class="card-content">
                <div class="card-label">Change Impact</div>
                <div class="metric" id="impactMetric" aria-live="polite">â€”</div>
              </div>
            </div>
          </div>
          
          <div class="focus-section">
            <h3><span class="section-icon" aria-hidden="true">âš ï¸</span> Nearâ€‘critical (slack â‰¤ threshold)</h3>
            <div class="list" id="nearList" role="region" aria-label="Near-critical tasks list"></div>
          </div>
          
          <div class="focus-section">
            <h3><span class="section-icon" aria-hidden="true">ğŸ”</span> Open Warnings</h3>
            <div class="issues" id="focusWarnings" role="region" aria-label="Open warnings and issues"></div>
          </div>
        </div>
      </section>
      <section id="compare" class="view" role="tabpanel" aria-label="Project comparison view">
        <div class="focus">
          <div class="row" style="gap:.5rem; align-items:center">
            <label>Baselines <select id="baselineSelect" multiple size="3" aria-label="Select baseline projects for comparison"></select></label>
            <button class="btn small" id="btnSetBaseline" aria-label="Use selected baselines for comparison">Use Selected</button>
          </div>
          <div class="cards" style="margin-top:.5rem">
            <div class="card" role="region" aria-label="Baseline finish date"><div>Finish (baseline)</div><div class="metric" id="cmpFinishA" aria-live="polite">â€”</div></div>
            <div class="card" role="region" aria-label="Current finish date"><div>Finish (current)</div><div class="metric" id="cmpFinishB" aria-live="polite">â€”</div></div>
            <div class="card" role="region" aria-label="Finish date difference"><div>Î” days</div><div class="metric" id="cmpFinishDelta" aria-live="polite">â€”</div></div>
            <div class="card" role="region" aria-label="Critical path difference"><div>Critical Î” (count)</div><div class="metric" id="cmpCritDelta" aria-live="polite">â€”</div></div>
          </div>
          <h3>Task deltas (start / finish / slack)</h3>
          <div class="list" id="cmpList"></div>
        </div>
      </section>
    </main>
  </div>

  <div class="hint" id="hint"></div>
  <div class="toast" id="toast"></div>
  <div class="ctx-menu" id="ctxMenu" role="menu" aria-label="Task actions menu">
    <div data-action="edit" role="menuitem" tabindex="0">Edit</div>
    <div data-action="duplicate" role="menuitem" tabindex="0">Duplicate</div>
    <div data-action="delete" role="menuitem" tabindex="0">Delete</div>
    <div data-action="adddep" role="menuitem" tabindex="0">Add dependency</div>
  </div>

  <div id="guided-workflow" style="display: none; position: fixed; top: 20%; left: 20%; width: 60%; background: white; border: 1px solid #ccc; padding: 20px; z-index: 1000; box-shadow: 0 0 10px rgba(0,0,0,0.5);" aria-hidden="true" role="dialog" aria-labelledby="guideModalTitle" aria-describedby="guideModalDescription">
    <div class="panel">
      <header>
        <h1 id="guideModalTitle" style="font-size:1rem">Guided Workflow</h1>
        <div id="guideModalDescription" class="sr-only">Step-by-step guide to using the project planner</div>
      </header>
      <div class="wizard-step" id="wz1" role="tabpanel" aria-labelledby="wz1Title">
        <h3 id="wz1Title">1) Choose dates & calendar</h3>
        <p>Pick a start date and whether to use working days with holidays or calendar days.</p>
      </div>
      <div class="wizard-step" id="wz2" style="display:none" role="tabpanel" aria-labelledby="wz2Title">
        <h3 id="wz2Title">2) Import or insert a template</h3>
        <p>Use <b>Openâ€¦</b> to load JSON/CSV or pick a library from the sidebar and click <b>Insert library</b>.</p>
      </div>
      <div class="wizard-step" id="wz3" style="display:none" role="tabpanel" aria-labelledby="wz3Title">
        <h3 id="wz3Title">3) Wire dependencies</h3>
        <p>Use tokens like <code>FS:pred+2d</code>, <code>SS:pred</code> in the task editor (bulk add works too).</p>
      </div>
      <div class="wizard-step" id="wz4" style="display:none" role="tabpanel" aria-labelledby="wz4Title">
        <h3 id="wz4Title">4) Validate & iterate</h3>
        <p>Open <b>Validation & Warnings</b> to fix issues. Drag bars to adjust, or use bulk edit.</p>
      </div>
      <div class="wizard-step" id="wz5" style="display:none" role="tabpanel" aria-labelledby="wz5Title">
        <h3 id="wz5Title">5) Compare scenarios</h3>
        <p>Create scenarios and set a baseline. Use <b>Compare</b> to see deltas.</p>
      </div>
              <div class="wizard-controls">
          <button class="btn ghost" aria-label="Close guided workflow" onclick="document.getElementById('guided-workflow').style.display = 'none';">Close</button>
          <button class="btn" id="wzPrev" disabled aria-label="Go to previous step">Back</button>
          <button class="btn accent" id="wzNext" aria-label="Go to next step">Next</button>
        </div>
    </div>
  </div>

<script>
(function(){
'use strict';
let ZTL;
// ---------------------------- tiny utils ----------------------------
const $ = (q,el=document)=>el.querySelector(q); const $$=(q,el=document)=>Array.from(el.querySelectorAll(q));
const todayStr = ()=> new Date().toISOString().slice(0,10);
function parseDate(s){ return new Date(s+'T00:00:00'); }
function fmtDate(d){ return d.toISOString().slice(0,10); }
function addDays(date, n){ const d=new Date(date); d.setDate(d.getDate()+n); return d; }
function isWeekend(d){ const x=d.getDay(); return x===0||x===6; }
function daysBetween(a,b){ return Math.round((b-a)/86400000); }
function esc(s){ return String(s??'').replace(/[&<>]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }
function uid(prefix='t'){ return prefix+'_'+Math.random().toString(36).slice(2,8); }
function slug(s){ return String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_|_$/g,''); }
function clone(o){ return JSON.parse(JSON.stringify(o)); }
function deepFreeze(o){ if(o&&typeof o==='object'&&!Object.isFrozen(o)){ Object.freeze(o); for(const k of Object.keys(o)){ deepFreeze(o[k]); } } return o; }
function showToast(msg){ const t=$('#toast'); t.textContent=msg; t.style.display='block'; clearTimeout(showToast._h); showToast._h=setTimeout(()=>{ t.style.display='none'; }, 2600); }
function showHint(x,y,msg){ const h=$('#hint'); h.textContent=msg; h.style.left=(x+12)+'px'; h.style.top=(y+12)+'px'; h.style.display='block'; }
function hideHint(){ $('#hint').style.display='none'; }
function showContextMenu(x,y,id){ const m=$('#ctxMenu'); m.dataset.id=id; m.style.display='block'; m.style.left=x+'px'; m.style.top=y+'px'; }
function hideContextMenu(){ $('#ctxMenu').style.display='none'; }
document.addEventListener('click', hideContextMenu);

// ---------------------------- duration parsing & validation ----------------------------
function parseDurationStrict(v){
  if(typeof v==='number'){
    if(!Number.isInteger(v) || v<0) return {error:'Duration must be a nonâ€‘negative integer (days).'};
    return {days:v};
  }
  const s=String(v||'').trim();
  if(s==='') return {error:'Duration is required.'};
  const m=s.match(/^(\d+)\s*([dw])?$/i);
  if(!m) return {error:'Use number of days or Nd/Nw (e.g., 10 or 3w).'};
  const n=parseInt(m[1],10); const u=(m[2]||'d').toLowerCase();
  if(n<0) return {error:'Duration cannot be negative.'};
  const days = u==='w'? n*5 : n;
  return {days};
}

// ---------------------------- calendar (standardized) ----------------------------
function makeCalendar(mode, holidaysSet){
  const isHoliday = d=> holidaysSet.has(fmtDate(d));
  function isWorkday(d){ return mode==='calendar'? true : (!isWeekend(d) && !isHoliday(d)); }
  function addBusinessDays(start, n){ let d=new Date(start); let step=n>=0?1:-1; let count=0; while(count!==n){ d.setDate(d.getDate()+step); if(isWorkday(d)) count+=step; } return d; }
  function diffBusinessDays(start, end){ let d=new Date(start); let n=0; const step=start<end?1:-1; while((step>0? d<end : d>end)){ d.setDate(d.getDate()+step); if(isWorkday(d)) n+=step; } return n; }
  return {
    mode,
    isWorkday,
    add:(start,n)=> mode==='calendar'? addDays(start,n): addBusinessDays(start,n),
    diff:(start,end)=> mode==='calendar'? daysBetween(start,end): diffBusinessDays(start,end)
  };
}

// ---------------------------- dependency parser ----------------------------
function parseDepToken(token){
  const s=String(token||'').trim(); if(!s) return null;
  let type='FS'; let rest=s; const colon=s.indexOf(':');
  if(colon>0){ const t=s.slice(0,colon).toUpperCase(); if(['FS','SS','FF','SF'].includes(t)){ type=t; rest=s.slice(colon+1); } }
  let pred=rest; let lag=0;
  const m = rest.match(/^(.*?)([+-])(\d+)([dw])?$/i);
  if(m){ pred=m[1]; const sign=m[2]==='-'?-1:1; const n=parseInt(m[3],10); const u=(m[4]||'d').toLowerCase(); lag = sign * (u==='w'? n*5 : n); }
  pred=pred.trim();
  return {type, pred, lag};
}
function stringifyDep(e){ const lagStr = e.lag? ((e.lag>0?'+':'')+Math.round(e.lag)+'d') : ''; return (e.type==='FS' && !lagStr? e.pred : `${e.type}:${e.pred}${lagStr}`); }
function normalizeDeps(task){ const raw=task.deps||[]; const arr=[]; for(const tok of raw){ const p=parseDepToken(tok); if(!p) continue; arr.push(p); } return arr; }
function adjustIncomingLags(task, delta){ const out=[]; for(const tok of (task.deps||[])){ const e=parseDepToken(tok); if(!e){ out.push(tok); continue; } if(e.type==='FS'||e.type==='SS'){ e.lag=(e.lag|0)+delta; out.push(stringifyDep(e)); } else { out.push(tok); } } return out; }

// ---------------------------- basic graph helpers ----------------------------
function findCycles(tasks){
  const id2=Object.fromEntries(tasks.map(t=>[t.id,t]));
  const deps=Object.fromEntries(tasks.map(t=>[t.id, normalizeDeps(t).map(x=>x.pred).filter(x=>id2[x]) ]));
  const color={}; const stack=[]; const cycles=[];
  function dfs(u){ color[u]=1; stack.push(u); for(const v of (deps[u]||[])){ if(color[v]==null){ dfs(v); } else if(color[v]===1){ const idx=stack.indexOf(v); cycles.push(stack.slice(idx).concat(v)); } } stack.pop(); color[u]=2; }
  for(const t of tasks){ if(color[t.id]==null) dfs(t.id); }
  return cycles;
}

// ---------------------------- centralized state manager ----------------------------
const SM=(function(){
  let state=deepFreeze({ startDate: todayStr(), calendar:'workdays', holidays:[], tasks:[] });
  let listeners=[]; let lastCPMWarns=[];
  const undo=[]; const redo=[]; const MAX=100;
  function get(){ return clone(state); }
  function _apply(next){ state=deepFreeze(clone(next)); for(const fn of listeners){ try{ fn(get()); }catch(e){ console.warn(e); } } }
  function set(next, opts={}){ const prev=get(); _apply(next); if(opts.record!==false){ undo.push(prev); if(undo.length>MAX) undo.shift(); redo.length=0; }
    window.dispatchEvent(new CustomEvent('state:changed', {detail:{sourceIds:opts.sourceIds||[]}}));
  }
  function setProjectProps(props){ const cur=get(); Object.assign(cur, props); set(cur); }
  function addTasks(list){ const cur=get(); const ids=new Set(cur.tasks.map(t=>t.id)); const add=list.map(t=>{ let id=t.id||uid('t'); while(ids.has(id)) id=uid('t'); ids.add(id); return {...t, id}; }); cur.tasks=cur.tasks.concat(add); set(cur); }
  function replaceTasks(tasks, opts={}){ const cur=get(); cur.tasks=tasks; set(cur, opts); }
  function updateTask(id, patch, opts={}){ const cur=get(); const i=cur.tasks.findIndex(t=>t.id===id); if(i<0) return; cur.tasks=cur.tasks.slice(); cur.tasks[i]={...cur.tasks[i], ...patch}; set(cur,{sourceIds:[id], ...opts}); }
  function onChange(fn){ listeners.push(fn); }
  function setCPMWarnings(list){ lastCPMWarns = list||[]; }
  function canUndo(){ return undo.length>0; } function canRedo(){ return redo.length>0; }
  function undoOp(){ if(!canUndo()) return; const prev=undo.pop(); const cur=get(); redo.push(cur); _apply(prev); }
  function redoOp(){ if(!canRedo()) return; const next=redo.pop(); const cur=get(); undo.push(cur); _apply(next); }
  return {get,set,setProjectProps,addTasks,replaceTasks,updateTask,onChange,setCPMWarnings,undo:undoOp,redo:redoOp,canUndo,canRedo};
})();

// ---------------------------- CPM (FS/SS/FF/SF + lags + constraints) ----------------------------
function computeCPM(project){
  const cal = makeCalendar(project.calendar, new Set(project.holidays||[]));
  const active = project.tasks.filter(t=>t.active!==false);
  const id2 = Object.fromEntries(active.map(t=>[t.id,t]));
  const predMap = new Map(active.map(t=>[t.id, normalizeDeps(t).filter(e=>id2[e.pred]) ]));
  const succMap = new Map(active.map(t=>[t.id, []]));
  for(const [sid,edges] of predMap){ for(const e of edges){ if(!succMap.has(e.pred)) succMap.set(e.pred,[]); succMap.get(e.pred).push({to:sid, type:e.type, lag:e.lag}); } }
  const indeg = new Map(active.map(t=>[t.id,0]));
  for(const [sid,edges] of predMap){ for(const e of edges){ indeg.set(sid, (indeg.get(sid)||0)+1); } }
  const q=[]; for(const t of active){ if((indeg.get(t.id)||0)===0) q.push(t.id); }
  const order=[]; while(q.length){ const u=q.shift(); order.push(u); for(const arc of (succMap.get(u)||[])){ const v=arc.to; indeg.set(v, (indeg.get(v)||0)-1); if(indeg.get(v)===0) q.push(v); } }
  const usable=active.filter(t=>order.includes(t.id));
  // Forward
  const ES={}, EF={}; const warnings=[];
  for(const id of order){ const t=id2[id]; if(!t) continue; const dur = parseDurationStrict(t.duration).days||0; let baseES=0; for(const e of (predMap.get(id)||[])){
      const p=e.pred; const type=e.type; const lag=e.lag|0; const esP = ES[p]||0; const efP = EF[p]||0;
      if(type==='FS') baseES=Math.max(baseES, efP + lag);
      else if(type==='SS') baseES=Math.max(baseES, esP + lag);
      else if(type==='FF') baseES=Math.max(baseES, efP + lag - dur);
      else if(type==='SF') baseES=Math.max(baseES, esP + lag - dur);
  }
  const sc = t.startConstraint || (t.fixedStart!=null ? {type:'SNET', day:t.fixedStart|0} : null);
  if(sc){ if(sc.type==='SNET') baseES = Math.max(baseES, sc.day|0); else if(sc.type==='MSO'){ if(baseES > (sc.day|0)) warnings.push({sev:'error', msg:`MSO violated for ${t.name}: deps force start ${baseES} > ${sc.day}`, taskId:t.id}); baseES = Math.max(baseES, sc.day|0); } }
  ES[id]=baseES; EF[id]=baseES + dur; }
  const projectFinish = Math.max(0, ...order.map(id=>EF[id]||0));
  // Backward
  const LF={}, LS={};
  const orderRev = order.slice().reverse();
  for(const id of orderRev){ const t=id2[id]; if(!t) continue; const dur=parseDurationStrict(t.duration).days||0; let baseLF = projectFinish; const succs = succMap.get(id)||[]; if(succs.length===0){ baseLF = projectFinish; }
    for(const arc of succs){ const s=arc.to; const type=arc.type; const lag=arc.lag|0; const lsS = LS[s]; const lfS = LF[s]; if(lsS==null || lfS==null) continue;
      if(type==='FS') baseLF = Math.min(baseLF, lsS - lag);
      else if(type==='SS') baseLF = Math.min(baseLF, (LS[id]==null? (lsS - lag) + dur : Math.min(LF[id]||Infinity, (lsS - lag) + dur) ));
      else if(type==='FF') baseLF = Math.min(baseLF, lfS - lag);
      else if(type==='SF') baseLF = Math.min(baseLF, (lfS - lag));
    }
    LF[id] = baseLF; LS[id] = baseLF - dur; }
  const out = usable.map(t=>({ ...t,
    es:ES[t.id]||0, ef:EF[t.id]||parseDurationStrict(t.duration).days||0,
    ls:LS[t.id]||0, lf:LF[t.id]||parseDurationStrict(t.duration).days||0,
    slack: (LS[t.id]??0)-(ES[t.id]??0),
    start: cal.add(parseDate(project.startDate), ES[t.id]||0),
    finish: cal.add(parseDate(project.startDate), EF[t.id]||0),
    critical: (LS[t.id]??0)===(ES[t.id]??0)
  }));
  SM.setCPMWarnings(warnings);
  return {order, tasks: out, finishDays: projectFinish};
}

// ---------------------------- Issue engine (ruleâ€‘based) ----------------------------
function collectIssues(project, cpm){
  const issues=[]; let seq=0; const FIX={};
  const id2=Object.fromEntries(project.tasks.map(t=>[t.id,t]));
  const seenIds=new Set(); const dupIds=new Set(); for(const t of project.tasks){ if(seenIds.has(t.id)) dupIds.add(t.id); seenIds.add(t.id); }
  function push(sev, msg, opts={}){ const id='i_'+(++seq); const it={id, sev, msg, ...opts}; if(opts.fix){ FIX[id]=opts.fix; it.hasFix=true; } issues.push(it); }
  if(!project.startDate) push('error','Project start date is missing.',{fix:()=> SM.setProjectProps({startDate: todayStr()})});
  if(dupIds.size){ push('critical',`Duplicate task ids: ${Array.from(dupIds).join(', ')}`,{fix:()=>{ const s=SM.get(); const used=new Set(); for(const t of s.tasks){ if(used.has(t.id)){ t.id = t.id+"_"+Math.random().toString(36).slice(2,5); } used.add(t.id); } SM.replaceTasks(s.tasks); }}); }
  for(const t of project.tasks){
    if(!t.id||String(t.id).trim()==='') push('error',`Task with empty id: "${t.name||'(no name)'}"`,{fix:()=>{ const s=SM.get(); const T=s.tasks.find(x=>x===t); T.id = uid('t'); SM.replaceTasks(s.tasks);} });
    if(!t.name||String(t.name).trim()==='') push('error',`Task ${t.id}: name is required.`,{fix:()=>{ const s=SM.get(); const T=s.tasks.find(x=>x.id===t.id); T.name = T.name && T.name.trim()? T.name : t.id; SM.replaceTasks(s.tasks);} });
    const pd=parseDurationStrict(t.duration); if(pd.error) push('error',`Task ${t.name||t.id}: ${pd.error}`,{taskId:t.id, fix:()=>{ const s=SM.get(); const T=s.tasks.find(x=>x.id===t.id); T.duration=1; SM.replaceTasks(s.tasks);} });
    if(t.fixedStart!=null && (!Number.isInteger(t.fixedStart) || t.fixedStart<0)) push('error',`Task ${t.name}: fixedStart must be a nonâ€‘negative integer (days offset).`,{taskId:t.id, fix:()=>{ const s=SM.get(); const T=s.tasks.find(x=>x.id===t.id); delete T.fixedStart; SM.replaceTasks(s.tasks);} });
    if(t.startConstraint){ const sc=t.startConstraint; if(!sc || !['MSO','SNET'].includes(sc.type)) push('error',`Task ${t.name}: startConstraint.type must be MSO or SNET.`,{fix:()=>{ const s=SM.get(); const T=s.tasks.find(x=>x.id===t.id); delete T.startConstraint; SM.replaceTasks(s.tasks);} }); if(sc && (sc.day==null || !Number.isInteger(sc.day) || sc.day<0)) push('error',`Task ${t.name}: startConstraint.day must be a nonâ€‘negative integer (days).`,{fix:()=>{ const s=SM.get(); const T=s.tasks.find(x=>x.id===t.id); if(T.startConstraint) T.startConstraint.day=0; SM.replaceTasks(s.tasks);} }); }
    const depStrings=t.deps||[];
    const seen=new Set();
    for(const tok of depStrings){ const d=parseDepToken(tok); if(!d) continue; if(d.pred===t.id) push('critical',`Task ${t.name}: selfâ€‘dependency not allowed (${tok}).`,{taskId:t.id, fix:()=>{ const s=SM.get(); const T=s.tasks.find(x=>x.id===t.id); T.deps=(T.deps||[]).filter(x=>x!==tok); SM.replaceTasks(s.tasks);} });
      if(!id2[d.pred]) push('error',`Task ${t.name}: missing dependency "${d.pred}".`,{taskId:t.id, fix:()=>{ const s=SM.get(); const pred={id:d.pred||uid('t'), name:`Placeholder: ${d.pred||'pred'}`, duration:1, deps:[]}; s.tasks.push(pred); SM.replaceTasks(s.tasks);} });
      if(seen.has(d.pred)) push('warn',`Task ${t.name}: duplicate dependency on ${d.pred}.`,{taskId:t.id, fix:()=>{ const s=SM.get(); const T=s.tasks.find(x=>x.id===t.id); const seen2=new Set(); T.deps=(T.deps||[]).filter(x=>{ const p=parseDepToken(x); if(!p) return false; if(seen2.has(p.pred)) return false; seen2.add(p.pred); return true; }); SM.replaceTasks(s.tasks);} });
      seen.add(d.pred);
      if(id2[d.pred] && id2[d.pred].active===false) push('warn',`Task ${t.name}: predecessor ${d.pred} is inactive.`,{taskId:t.id, fix:()=>{ const s=SM.get(); const P=s.tasks.find(x=>x.id===d.pred); if(P){ P.active=true; SM.replaceTasks(s.tasks);} }});
    }
  }
  const cycles=findCycles(project.tasks);
  for(const c of cycles){ const chain=c.join(' â†’ '); push('critical',`Cycle detected: ${chain}`,{fix:()=>{ const s=SM.get(); const last=c[c.length-2]; const first=c[0]; const T=s.tasks.find(x=>x.id===last); if(T&&T.deps){ T.deps=T.deps.filter(tok=>{ const p=parseDepToken(tok); return !(p && p.pred===first); }); SM.replaceTasks(s.tasks);} }}); }
  if(cpm && cpm.tasks){ const map=Object.fromEntries(cpm.tasks.map(t=>[t.id,t]));
    for(const t of cpm.tasks){ const cur=id2[t.id]; if(!cur) continue;
      if(cur.startConstraint && cur.startConstraint.type==='MSO'){
        let esReq=0; for(const dep of normalizeDeps(cur)){ const p=map[dep.pred]; if(!p) continue; const dur=parseDurationStrict(cur.duration).days||0; if(dep.type==='FS') esReq=Math.max(esReq, p.ef + dep.lag); else if(dep.type==='SS') esReq=Math.max(esReq, p.es + dep.lag); else if(dep.type==='FF') esReq=Math.max(esReq, p.ef + dep.lag - dur); else if(dep.type==='SF') esReq=Math.max(esReq, p.es + dep.lag - dur); }
        if(esReq > (cur.startConstraint.day|0)){
          push('error',`MSO earlier than dependency bound for ${t.name} (MSO ${cur.startConstraint.day}d < required ${esReq}d).`,{taskId:t.id, fix:()=>{ const s=SM.get(); const T=s.tasks.find(x=>x.id===t.id); if(T.startConstraint){ T.startConstraint.day=esReq; } SM.replaceTasks(s.tasks);} });
        }
      }
      const dur=parseDurationStrict(cur.duration).days||0; if(dur===0 && !(String(cur.name||'').toLowerCase().includes('gate') || String(cur.phase||'').toLowerCase().includes('gate'))){ push('info',`Zeroâ€‘duration task: ${cur.name}. Consider a milestone (ok) or set to 1d.`,{taskId:t.id, fix:()=>{ const s=SM.get(); const T=s.tasks.find(x=>x.id===t.id); T.duration=1; SM.replaceTasks(s.tasks);} }); }
    }
  }
  return {issues, FIX};
}

// ---------------------------- Zoom/Pan helpers ----------------------------
function makeZoomPan(svg){
  const Z={};
  let vb=[0,0, svg.clientWidth||800, svg.clientHeight||500];
  const listeners=[];
  function setVB(x,y,w,h){ vb=[x,y,w,h]; svg.setAttribute('viewBox', vb.join(' ')); listeners.forEach(fn=>fn(vb)); }
  function fit(){ const w=svg.clientWidth||800, h=svg.clientHeight||500; setVB(0,0,w,h); }
  fit();
  let dragging=false; let p0=null;
  svg.addEventListener('wheel', (e)=>{ e.preventDefault(); const scale = e.deltaY>0? 1.1 : 0.9; const mx=e.offsetX, my=e.offsetY; const nx = vb[0] + (mx/vb[2])*vb[2]*(1-scale); const ny = vb[1] + (my/vb[3])*vb[3]*(1-scale); const nw = vb[2]*scale; const nh = vb[3]*scale; setVB(nx, ny, nw, nh); });
  svg.addEventListener('pointerdown', (e)=>{ if(e.button!==0) return; dragging=true; p0={x:e.clientX, y:e.clientY, vb0:[...vb]}; svg.setPointerCapture(e.pointerId); });
  svg.addEventListener('pointermove', (e)=>{ if(!dragging) return; const dx=e.clientX-p0.x, dy=e.clientY-p0.y; setVB(p0.vb0[0]-dx, p0.vb0[1]-dy, p0.vb0[2], p0.vb0[3]); });
  svg.addEventListener('pointerup', (e)=>{ dragging=false; svg.releasePointerCapture(e.pointerId); });
  Z.zoomIn=()=> setVB(vb[0]+vb[2]*0.05, vb[1]+vb[3]*0.05, vb[2]*0.9, vb[3]*0.9);
  Z.zoomOut=()=> setVB(vb[0]-vb[2]*0.055, vb[1]-vb[3]*0.055, vb[2]*1.1, vb[3]*1.1);
  Z.fit=fit;
  Z.getViewBox=()=>vb.slice();
  Z.setViewBox=(x,y,w,h)=>setVB(x,y,w,h);
  Z.onChange=(fn)=>{ listeners.push(fn); };
  return Z;
}

// ---------------------------- Filtering & grouping ----------------------------
const SUBS=['power/VRM','PCIe','BMC','BIOS','FW','Mech','Thermal','System'];
function getActiveSubsystems(){ return $$('#subsysFilters input[type="checkbox"]').filter(x=>x.checked).map(x=>x.value); }
function matchesFilters(t){ const txt=($('#filterText').value||'').toLowerCase(); if(txt){ const inName=(t.name||'').toLowerCase().includes(txt); const inPhase=(t.phase||'').toLowerCase().includes(txt); if(!inName && !inPhase) return false; }
  const act=getActiveSubsystems(); if(act.length && !act.includes(t.subsystem||'System')) return false; return true; }
function groupKey(t){ const g=$('#groupBy').value||'none'; if(g==='phase') return t.phase||'(no phase)'; if(g==='subsystem') return t.subsystem||'System'; return null; }

// ---------------------------- Rendering: Graph ----------------------------
function layoutDAG(tasks){ const byLevel=new Map(); const K=100; for(const t of tasks){ const lvl=t.es; const y=Math.round(lvl/5); if(!byLevel.has(y)) byLevel.set(y,[]); byLevel.get(y).push(t);} const pos=new Map(); for(const [lvl,arr] of byLevel){ arr.sort((a,b)=> (a.phase||'').localeCompare(b.phase||'')); let x=40; for(const t of arr){ pos.set(t.id,{x, y: 40+lvl*K}); x+=Math.max(160, 8*(t.name||'').length); } } return pos; }
function renderGraph(project, cpm){ const svg = $('#graphSvg'); svg.innerHTML=''; const defs=document.createElementNS('http://www.w3.org/2000/svg','defs'); defs.innerHTML=`<marker id="arrow" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="8" markerHeight="8" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#94a3b8"/></marker>`; svg.appendChild(defs); const g=document.createElementNS('http://www.w3.org/2000/svg','g'); svg.appendChild(g); const tasks=cpm.tasks.filter(matchesFilters); const id2=Object.fromEntries(cpm.tasks.map(t=>[t.id,t])); const pos=layoutDAG(tasks); for(const t of tasks){ const edges = normalizeDeps(t); for(const e of edges){ const d=e.pred; if(!id2[d] || !matchesFilters(id2[d])) continue; const p1=pos.get(d), p2=pos.get(t.id); if(!p1||!p2) continue; const line=document.createElementNS('http://www.w3.org/2000/svg','path'); line.setAttribute('d',`M ${p1.x+120} ${p1.y+20} L ${p2.x-12} ${p2.y+20}`); line.setAttribute('class','edge arrow'+(t.critical&&id2[d].critical?' critical':'')); g.appendChild(line);} } for(const t of tasks){ const p=pos.get(t.id); if(!p) continue; const node=document.createElementNS('http://www.w3.org/2000/svg','g'); node.setAttribute('class','node'+(t.critical?' critical':'')); node.setAttribute('data-id',t.id); if(SEL.has(t.id)) node.classList.add('selected'); const color=colorFor(t.subsystem); node.innerHTML = `<rect x="${p.x}" y="${p.y}" width="240" height="44" style="stroke:${color}" rx="8" fill="#fff"/> <text x="${p.x+10}" y="${p.y+18}" class="title">${esc(t.name)}</text> <text x="${p.x+10}" y="${p.y+34}" fill="#64748b">${esc(t.phase||'')} â€¢ ${esc(String(t.duration))}d â€¢ slack ${esc(String(t.slack))}</text>`; node.addEventListener('click', ()=>{ toggleSelect(t.id); renderGraph(project,cpm); }); g.appendChild(node);} }

// ---------------------------- Rendering: Timeline ----------------------------
function colorFor(subsys){ const M={'power/VRM':'--pwr','PCIe':'--pcie','BMC':'--bmc','BIOS':'--bios','FW':'--fw','Mech':'--mech','Thermal':'--thermal','System':'--sys'}; const v=M[subsys]||'--ok'; return getComputedStyle(document.documentElement).getPropertyValue(v).trim()||'#16a34a'; }
function renderGantt(project, cpm){ const svg=$('#gantt'); svg.innerHTML=''; const W=(svg.getBoundingClientRect().width||800); const H=(svg.getBoundingClientRect().height||500); const P=120; const tasksAll=cpm.tasks.slice(); const tasks=tasksAll.filter(matchesFilters);
  // grouping
  const groups={}; const order=[]; for(const t of tasks){ const k=groupKey(t); if(k==null){ order.push(['', [t]]); continue; } if(!groups[k]) groups[k]=[]; groups[k].push(t); }
  if(Object.keys(groups).length){ for(const k of Object.keys(groups).sort()){ order.push([k, groups[k].sort((a,b)=> (a.es-b.es)|| (a.name||'').localeCompare(b.name||''))]); } }
  if(!order.length) order.push(['', tasks.sort((a,b)=> (a.es-b.es)|| (a.name||'').localeCompare(b.name||''))]);
  const rows=[]; order.forEach(([k,arr])=>{ if(k){ rows.push({type:'group', label:k}); } arr.forEach(t=> rows.push({type:'task', t})); });
  const rowH=28; const chartH=Math.max(H, rows.length*rowH+60); svg.setAttribute('viewBox',`0 0 ${W} ${chartH}`);
  const finish=Math.max(10,cpm.finishDays||10); const scale = (x)=> P + (x*(W-P-20))/finish; const scaleInv=(px)=> Math.round((px-P)*finish/(W-P-20));
  const gAxis=document.createElementNS('http://www.w3.org/2000/svg','g'); gAxis.setAttribute('class','axis'); const ticks=10; for(let i=0;i<=ticks;i++){ const x=scale(i*(finish/ticks)); const l=document.createElementNS('http://www.w3.org/2000/svg','line'); l.setAttribute('x1',x); l.setAttribute('y1',20); l.setAttribute('x2',x); l.setAttribute('y2',chartH-20); l.setAttribute('stroke','#e5e7eb'); gAxis.appendChild(l); const t=document.createElementNS('http://www.w3.org/2000/svg','text'); t.setAttribute('x',x+2); t.setAttribute('y',14); t.textContent = Math.round(i*(finish/ticks))+'d'; gAxis.appendChild(t); } svg.appendChild(gAxis);
  const g=document.createElementNS('http://www.w3.org/2000/svg','g'); svg.appendChild(g);
  let y=30; rows.forEach((r)=>{ if(r.type==='group'){ const rect=document.createElementNS('http://www.w3.org/2000/svg','rect'); rect.setAttribute('x',0); rect.setAttribute('y',y-6); rect.setAttribute('width',P-10); rect.setAttribute('height',22); rect.setAttribute('class','groupHeader'); g.appendChild(rect); const tx=document.createElementNS('http://www.w3.org/2000/svg','text'); tx.setAttribute('x',8); tx.setAttribute('y',y+8); tx.setAttribute('class','groupLabel'); tx.textContent=r.label; g.appendChild(tx); y+=22; return; }
    const t=r.t; const x=scale(Math.max(0,t.es||0)), w=Math.max(4, scale(Math.max(0,t.ef||1))-scale(Math.max(0,t.es||0)) );
    const bar=document.createElementNS('http://www.w3.org/2000/svg','g');
    bar.setAttribute('class','bar'+(t.critical?' critical':'')); bar.setAttribute('data-id',t.id);
    if(SEL.has(t.id)) bar.classList.add('selected');
    const col=colorFor(t.subsystem);
    const isMilestone=(parseDurationStrict(t.duration).days||0)===0;
    if(isMilestone){
      bar.setAttribute('data-ms','1');
      const diamond=document.createElementNS("http://www.w3.org/2000/svg","rect");
      diamond.setAttribute("x",x-6); diamond.setAttribute("y",y+2); diamond.setAttribute("width",12); diamond.setAttribute("height",12);
      diamond.setAttribute("transform",`rotate(45 ${x} ${y+8})`);
      diamond.setAttribute("class","milestone"+(t.critical?' critical':''));
      diamond.setAttribute("style",`stroke:${col}`);
      bar.appendChild(diamond);
    }else{
      const rect=document.createElementNS("http://www.w3.org/2000/svg","rect");
      rect.setAttribute("x",x); rect.setAttribute("y",y); rect.setAttribute("width",w); rect.setAttribute("height",16); rect.setAttribute("fill","#e2e8f0"); rect.setAttribute("style",`stroke:${col}`);
      bar.appendChild(rect);
      const progW=Math.max(0, Math.min(w, w*(t.pct||0)/100));
      if(progW>0){ const prog=document.createElementNS("http://www.w3.org/2000/svg","rect"); prog.setAttribute("x",x); prog.setAttribute("y",y); prog.setAttribute("width",progW); prog.setAttribute("height",16); prog.setAttribute("class","progress"); prog.setAttribute("fill",col); bar.appendChild(prog); }
      const left=document.createElementNS("http://www.w3.org/2000/svg","rect"); left.setAttribute("x",x-3); left.setAttribute("y",y); left.setAttribute("width",3); left.setAttribute("height",16); left.setAttribute("class","handle"); left.setAttribute("data-side","left"); bar.appendChild(left);
      const right=document.createElementNS("http://www.w3.org/2000/svg","rect"); right.setAttribute("x",x+w); right.setAttribute("y",y); right.setAttribute("width",3); right.setAttribute("height",16); right.setAttribute("class","handle"); right.setAttribute("data-side","right"); bar.appendChild(right);
    }
    // Add background rectangle for task name readability
    const nameBg=document.createElementNS("http://www.w3.org/2000/svg","rect");
    const nameWidth = Math.max(80, t.name.length * 8); // Estimate text width
    nameBg.setAttribute("x", P-8-nameWidth);
    nameBg.setAttribute("y", y-2);
    nameBg.setAttribute("width", nameWidth);
    nameBg.setAttribute("height", 20);
    nameBg.setAttribute("fill", "rgba(255, 255, 255, 0.95)");
    nameBg.setAttribute("rx", "4");
    nameBg.setAttribute("class", "taskNameBg");
    bar.appendChild(nameBg);
    
    const label=document.createElementNS("http://www.w3.org/2000/svg","text"); label.setAttribute("class","label"); label.setAttribute("x",P-8); label.setAttribute("y",y+12); label.setAttribute("text-anchor","end"); label.textContent=t.name; bar.appendChild(label);
    const dur=document.createElementNS("http://www.w3.org/2000/svg","text"); dur.setAttribute("class","label"); dur.setAttribute("x",isMilestone? x+6 : x+w+6); dur.setAttribute("y",y+12); dur.textContent=String(t.duration)+"d"; bar.appendChild(dur);
    if(!isMilestone){ const pct=document.createElementNS("http://www.w3.org/2000/svg","text"); pct.setAttribute("class","label"); pct.setAttribute("x",x+4); pct.setAttribute("y",y+12); pct.textContent=(t.pct||0)+"%"; bar.appendChild(pct); }
    bar.addEventListener('click', (ev)=>{ if(ev.shiftKey||ev.metaKey||ev.ctrlKey){ toggleSelect(t.id); renderGantt(project,cpm); } });
    bar.addEventListener('contextmenu',(ev)=>{ ev.preventDefault(); selectOnly(t.id); showContextMenu(ev.clientX, ev.clientY, t.id); });
    g.appendChild(bar); y+=rowH; });

  // drag
  let drag=null; svg.onpointerdown=(ev)=>{ const tgt=ev.target; const gg=tgt.closest('.bar'); if(!gg || gg.dataset.ms) return; const id=gg.getAttribute('data-id'); const rect=gg.querySelector('rect'); const x0=+rect.getAttribute('x'); const w0=+rect.getAttribute('width'); const side = tgt.classList.contains('handle')? tgt.getAttribute('data-side') : 'move'; drag={id, side, x0, w0, px0:ev.clientX, py0:ev.clientY}; gg.classList.add('moved'); svg.setPointerCapture(ev.pointerId); };
  svg.onpointermove=(ev)=>{ if(!drag) return; const dx=ev.clientX-drag.px0; const gg=$(`.bar[data-id="${drag.id}"]`, svg); const rect=gg.querySelector('rect'); const labelNext=gg.querySelectorAll('text')[1]; if(drag.side==='right'){ const newW=Math.max(4, drag.w0+dx); rect.setAttribute('width', newW); const dur = scaleInv(+rect.getAttribute('x')+newW) - (cpm.tasks.find(t=>t.id===drag.id).es||0); labelNext.textContent = Math.max(1,dur)+'d'; hideHint(); gg.classList.remove('invalid','valid'); } else { const newX=Math.max(P, drag.x0+dx); rect.setAttribute('x', newX); const esCand = scaleInv(newX); const cur=cpm.tasks.find(t=>t.id===drag.id); const dur=cur.ef - cur.es; const allowed = $('#toggleConAware')? ($('#toggleConAware').checked? calcEarliestESFor(SM.get(), drag.id, dur) : 0) : 0; const ok = (esCand>=allowed) || ev.shiftKey; labelNext.textContent = (cur.duration)+'d'; if(ok){ gg.classList.add('valid'); gg.classList.remove('invalid'); hideHint(); } else { gg.classList.add('invalid'); gg.classList.remove('valid'); showHint(ev.clientX, ev.clientY, `Blocked: earliest ${allowed}d`); } }
  };
  svg.onpointerup=(ev)=>{ if(!drag) return; svg.releasePointerCapture(ev.pointerId); hideHint(); const gg=$(`.bar[data-id="${drag.id}"]`, svg); const rect=gg.querySelector('rect'); const x=+rect.getAttribute('x'); const w=+rect.getAttribute('width'); const scaleInv=(px)=> Math.round((px-P)*finish/(W-P-20)); const esNew = scaleInv(x); const efNew = scaleInv(x+w); const durNew = Math.max(1, efNew-esNew); const cur=cpm.tasks.find(t=>t.id===drag.id);
    if(drag.side==='right'){ SM.updateTask(drag.id,{duration:durNew}); showToast('Duration updated'); }
    else if(drag.side==='left' || (drag.side==='move' && ev.shiftKey)){
      const sc={type:'SNET', day:esNew}; SM.updateTask(drag.id,{startConstraint:sc, duration:durNew}); showToast('Set SNET constraint');
    } else {
      const allowed=$('#toggleConAware')? ($('#toggleConAware').checked? calcEarliestESFor(SM.get(), drag.id, cur.ef-cur.es) : 0) : 0; const autoLag=$('#toggleAutoLag')? $('#toggleAutoLag').checked : false;
      if(esNew<allowed && !autoLag){ const sc={type:'SNET', day:allowed}; SM.updateTask(drag.id,{startConstraint:sc}, {record:true}); showToast(`Snapped to earliest ${allowed}d`);
      } else if(esNew!== (cur.es||0)){
        const delta = esNew - (cur.es||0);
        if(autoLag){ const s=SM.get(); const t=s.tasks.find(x=>x.id===drag.id); t.deps=adjustIncomingLags(t, delta); SM.replaceTasks(s.tasks,{record:true}); showToast(`Adjusted predecessor lags by ${delta}d`); }
        else { const sc={type:'SNET', day:Math.max(0, esNew)}; SM.updateTask(drag.id,{startConstraint:sc}, {record:true}); showToast('Added SNET to honor move'); }
      }
    }
    gg.classList.remove('invalid','valid'); drag=null; setTimeout(()=>{ refresh(); }, 0);
  };
}

function calcEarliestESFor(project, id, dur){
  const id2=Object.fromEntries(project.tasks.map(t=>[t.id,t]));
  const cur=id2[id]; if(!cur) return 0; let es=0;
  for(const e of normalizeDeps(cur)){ const p=id2[e.pred]; if(!p) continue; const pd=parseDurationStrict(p.duration).days||0; if(e.type==='FS') es=Math.max(es, (p.ef!=null?p.ef:pd)+e.lag); else if(e.type==='SS') es=Math.max(es, (p.es!=null?p.es:0)+e.lag); else if(e.type==='FF') es=Math.max(es, (p.ef!=null?p.ef:pd)+e.lag - dur); else if(e.type==='SF') es=Math.max(es, (p.es!=null?p.es:0)+e.lag - dur); }
  if(cur.startConstraint){ const sc=cur.startConstraint; if(sc.type==='SNET' || sc.type==='MSO') es=Math.max(es, sc.day|0); }
  if(cur.fixedStart!=null) es=Math.max(es, cur.fixedStart|0);
  return Math.max(0, Math.round(es));
}

// ---------------------------- Focus & Issues rendering ----------------------------
function renderFocus(project, cpm){
  $('#countMetric').textContent = String(cpm.tasks.length);
  const cal=makeCalendar(project.calendar, new Set(project.holidays||[]));
  const finishDate = cal.add(parseDate(project.startDate), cpm.finishDays||0);
  $('#finishMetric').textContent = fmtDate(finishDate);
  $('#critMetric').textContent = String(cpm.tasks.filter(t=>t.critical).length);
  const th = +($('#slackThreshold').value||0);
  const near = cpm.tasks.filter(t=>t.slack<=th && !t.critical).sort((a,b)=>a.slack-b.slack);
  const L=$('#nearList'); L.innerHTML=''; for(const t of near){ const row=document.createElement('div'); row.className='row'; row.innerHTML=`<span>${esc(t.name)}</span><span class="slack">slack ${t.slack}d</span>`; L.appendChild(row); }
  // focus warnings = same as issues filter
  renderIssues(project, cpm, '#focusWarnings');
}

function renderIssues(project, cpm, targetSel){
  const {issues, FIX} = collectIssues(project, cpm);
  const filter=$('#severityFilter').value||'all';
  const box=$(targetSel||'#issues'); box.innerHTML='';
  if(!issues.length){ const ok=document.createElement('div'); ok.className='issue sev-info'; ok.innerHTML='<span class="msg">No validation issues.</span><span class="meta">Realâ€‘time checks clean</span>'; box.appendChild(ok); return; }
  for(const it of issues){ if(filter!=='all'){
      const rank={info:1,warn:2,error:3,critical:4}; if(rank[it.sev] < (filter==='info'?1: filter==='warn'?2: filter==='error'?3:4)) continue;
    }
    const div=document.createElement('div'); div.className='issue sev-'+it.sev; const sub = it.taskId? `<span class="meta">Task: ${esc(it.taskId)}</span>`:''; const btn = it.hasFix && !targetSel? `<div class="actions"><button class="btn small fix-btn" data-i="${it.id}">Fix</button></div>`:''; div.innerHTML = `<div><div class="msg">${esc(it.msg)}</div>${sub}</div>${btn}`; box.appendChild(div);
  }
  if(!targetSel){ box.onclick=(e)=>{ const b=e.target.closest('.fix-btn'); if(!b) return; const id=b.getAttribute('data-i'); const fn=FIX[id]; if(typeof fn==='function'){ fn(); showToast('Applied fix'); refresh(); } }; $('#btnAutoFix').onclick=()=>{ const rank={info:1,warn:2,error:3,critical:4}; for(const it of issues){ if(it.hasFix && rank[it.sev]>=3){ const fn=FIX[it.id]; if(typeof fn==='function') fn(); } } showToast('Autoâ€‘fix pass finished'); refresh(); }; }
}

// ---------------------------- Scenarios (same as v7 + bugfix) ----------------------------
const SC=(function(){
  const scenarios={}; let current='Working'; let baselines=[];
  function snapshot(){ return SM.get(); }
  function saveAs(name){ scenarios[name]=clone(snapshot()); current=name; updateScenarioUI(); showToast(`Saved as "${name}"`); }
  function switchTo(name){ if(!scenarios[name]) return; SM.set(clone(scenarios[name])); current=name; updateScenarioUI(); showToast(`Switched to "${name}"`); }
  function get(name){ return scenarios[name]? clone(scenarios[name]): null; }
  function list(){ return Object.keys(scenarios); }
  function setBaselines(names){ baselines=names.filter(n=>scenarios[n]); updateScenarioUI(); showToast(`Baselines set: ${baselines.join(', ')||'none'}`); }
  function getBaselines(){ return baselines.slice(); }
  return {saveAs, switchTo, get, list, setBaselines, getBaselines, current:()=>current};
})();
function updateScenarioUI(){
  const sel=$('#scenarioSelect');
  if(sel){
    sel.innerHTML='';
    const items=SC.list();
    for(const name of items){
      const opt=document.createElement('option'); opt.value=name; opt.textContent=name; sel.appendChild(opt);
    }
    const badge=$('#scenarioBadge'); if(badge) badge.textContent = `Scenario: ${SC.current()}`;
    const bSel=$('#baselineSelect');
    if(bSel){
      bSel.innerHTML='';
      const bases=new Set(SC.getBaselines());
      for(const n of items){
        const o=document.createElement('option'); o.value=n; o.textContent=n; if(bases.has(n)) o.selected=true; bSel.appendChild(o);
      }
    }
  }
}
function buildCompare(){
  const baseNames=SC.getBaselines();
  if(baseNames.length===0){
    $('#cmpList').innerHTML='<div class="issue sev-info"><div class="msg">Select baseline scenario(s).</div></div>';
    return;
  }
  const curProj=SM.get();
  const B=computeCPM(curProj);
  const calB=makeCalendar(curProj.calendar, new Set(curProj.holidays||[]));
  $('#cmpFinishB').textContent=fmtDate(calB.add(parseDate(curProj.startDate), B.finishDays||0));
  const L=$('#cmpList');
  L.innerHTML='';
  baseNames.forEach((baseName, idx)=>{
    const baseProj=SC.get(baseName);
    if(!baseProj){
      const div=document.createElement('div'); div.className='issue sev-error'; div.innerHTML=`<div class="msg">Baseline scenario missing: ${esc(baseName)}</div>`; L.appendChild(div); return;
    }
    const A=computeCPM(baseProj);
    const calA=makeCalendar(baseProj.calendar, new Set(baseProj.holidays||[]));
    const finishA=fmtDate(calA.add(parseDate(baseProj.startDate), A.finishDays||0));
    const delta=(B.finishDays||0)-(A.finishDays||0);
    const critA=new Set(A.tasks.filter(t=>t.critical).map(t=>t.id));
    const critB=new Set(B.tasks.filter(t=>t.critical).map(t=>t.id));
    const critDelta=Math.abs(critA.size-critB.size);
    if(idx===0){
      $('#cmpFinishA').textContent=finishA;
      $('#cmpFinishDelta').textContent=String(delta);
      $('#cmpCritDelta').textContent=String(critDelta);
    }
    const header=document.createElement('div');
    header.className='issue sev-info';
    header.innerHTML=`<div class="msg"><b>${esc(baseName)}</b> â€¢ Î”finish ${delta}d â€¢ Î”critical ${critDelta}</div>`;
    L.appendChild(header);
    const mapA=Object.fromEntries(A.tasks.map(t=>[t.id,t]));
    const mapB=Object.fromEntries(B.tasks.map(t=>[t.id,t]));
    const rows=[];
    for(const id of Object.keys(mapB)){
      const a=mapA[id]; const b=mapB[id]; if(!b) continue;
      const ds=(b.es||0)-(a? a.es||0:0);
      const df=(b.ef||0)-(a? a.ef||0:0);
      const dsl=(b.slack||0)-(a? a.slack||0:0);
      rows.push({name:b.name||id, ds, df, dsl});
    }
    rows.sort((x,y)=> Math.abs(y.df)-Math.abs(x.df));
    rows.forEach(r=>{
      const div=document.createElement('div');
      div.className='row';
      div.innerHTML=`<span>${esc(r.name)}</span><span class="slack">Î”start ${r.ds}d â€¢ Î”finish ${r.df}d â€¢ Î”slack ${r.dsl}d</span>`;
      L.appendChild(div);
    });
  });
}


// ---------------------------- CSV / IO ----------------------------
async function saveFile(json){ const blob=new Blob([json],{type:'application/json'}); if(window.showSaveFilePicker){ try{ const handle=await showSaveFilePicker({suggestedName:'project.hpc.json', types:[{description:'JSON', accept:{'application/json':['.json']}}]}); const w=await handle.createWritable(); await w.write(blob); await w.close(); return; }catch(e){ console.warn(e);} } const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='project.hpc.json'; a.click(); URL.revokeObjectURL(a.href); }
async function openFile(){ if(window.showOpenFilePicker){ try{ const [h]=await showOpenFilePicker({types:[{description:'JSON/CSV', accept:{'application/json':['.json'],'text/csv':['.csv']}}]}); const f=await h.getFile(); const txt=await f.text(); return f.name.endsWith('.csv')? csvToProject(txt) : JSON.parse(txt); }catch(e){ console.warn(e);} } return new Promise((res)=>{ const inp=document.createElement('input'); inp.type='file'; inp.accept='.json,.csv'; inp.onchange=async()=>{ const f=inp.files[0]; const txt=await f.text(); if(f.name.endsWith('.csv')) res(csvToProject(txt)); else res(JSON.parse(txt)); }; inp.click(); }); }
function exportCSV(){ const rows=[['id','name','duration(d)','deps','phase','subsystem']]; for(const t of SM.get().tasks){ if(t.active===false) continue; rows.push([t.id,t.name,parseDurationStrict(t.duration).days||0, (t.deps||[]).join(' '), t.phase||'', t.subsystem||''].map(x=>`"${String(x).replaceAll('"','""')}"`)); } const csv=rows.map(r=>r.join(',')).join('\n'); const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download='project.csv'; a.click(); URL.revokeObjectURL(a.href); }
function csvToProject(csv){ const lines=csv.trim().split(/\r?\n/); const [header,...rows]=lines; const idx=(k)=> header.split(',').map(s=>s.replace(/\W+/g,'').toLowerCase()).indexOf(k.toLowerCase()); const iId=idx('id'), iName=idx('name'), iDur=idx('durationd'), iDeps=idx('deps'), iPhase=idx('phase'), iSub=idx('subsystem'); const tasks=rows.map(r=>{ const cols=r.match(/\"([^\"]|\"\")*\"|[^,]+/g).map(s=>s.replace(/^\"|\"$/g,'').replaceAll('""','"')); const d=parseDurationStrict(+cols[iDur]||cols[iDur]||''); return { id: cols[iId]||uid('t'), name: cols[iName], duration: d.error? 1 : d.days, deps: (cols[iDeps]||'').split(/[\s;]/).filter(Boolean), phase: cols[iPhase]||'', subsystem: cols[iSub]||'System', active:true }; }); return {startDate: todayStr(), calendar: 'workdays', holidays:[], tasks}; }

// ---------------------------- Selection & Bulk edit ----------------------------
const SEL=new Set();
let LAST_SEL=null;
function toggleSelect(id){
  if(SEL.has(id)){
    SEL.delete(id);
    if(LAST_SEL===id) LAST_SEL=null;
  }else{
    SEL.add(id);
    LAST_SEL=id;
  }
  updateSelBadge();
}
function selectOnly(id){
  SEL.clear();
  SEL.add(id);
  LAST_SEL=id;
  updateSelBadge();
}
function moveSelection(dir){
  const tasks=SM.get().tasks.filter(matchesFilters);
  if(!tasks.length) return;
  let idx=tasks.findIndex(t=>t.id===LAST_SEL);
  if(idx===-1) idx = dir>0?0:tasks.length-1;
  else idx=(idx+dir+tasks.length)%tasks.length;
  selectOnly(tasks[idx].id);
  refresh();
}
function deleteSelected(){
  if(!SEL.size) return;
  const ids=new Set(SEL);
  const s=SM.get();
  const remaining=s.tasks.filter(t=>!ids.has(t.id));
  for(const t of remaining){
    if(t.deps){
      t.deps=t.deps.filter(tok=>{
        const e=parseDepToken(tok);
        return !(e && ids.has(e.pred));
      });
    }
  }
  SM.replaceTasks(remaining);
  clearSelection();
  showToast(`Deleted ${ids.size} task${ids.size>1?'s':''}`);
  refresh();
}
function duplicateSelected(){
  if(!SEL.size) return;
  const s=SM.get();
  const tasks=[...s.tasks];
  const ids=new Set(tasks.map(t=>t.id));
  const originals=tasks.filter(t=>SEL.has(t.id));
  const mapOldToNew=new Map();
  const clones=[];
  for(const t of originals){
    let id=t.id+'_copy';
    while(ids.has(id)) id=uid('t');
    ids.add(id);
    const clone=JSON.parse(JSON.stringify(t));
    clone.id=id;
    clone.name=(t.name||t.id)+' (copy)';
    mapOldToNew.set(t.id,id);
    clones.push(clone);
  }
  for(const c of clones){
    if(c.deps){
      c.deps=c.deps.map(tok=>{
        const e=parseDepToken(tok);
        if(!e) return tok;
        if(mapOldToNew.has(e.pred)) e.pred=mapOldToNew.get(e.pred);
        return stringifyDep(e);
      });
    }
  }
  for(let i=originals.length-1;i>=0;i--){
    const idx=tasks.findIndex(t=>t.id===originals[i].id);
    tasks.splice(idx+1,0,clones[i]);
  }
  SM.replaceTasks(tasks);
  SEL.clear();
  clones.forEach(c=>SEL.add(c.id));
  LAST_SEL=clones.length?clones[clones.length-1].id:null;
  updateSelBadge();
  showToast(`Duplicated ${clones.length} task${clones.length>1?'s':''}`);
  refresh();
}
function clearSelection(){ SEL.clear(); LAST_SEL=null; updateSelBadge(); }
function renderInlineEditor(){ const box=$('#inlineEdit'); if(!box) return; box.innerHTML=''; if(SEL.size===0) return; const s=SM.get();
  for(const id of SEL){ const t=s.tasks.find(x=>x.id===id); if(!t) continue; const row=document.createElement('div'); row.className='row';
    const dur=parseDurationStrict(t.duration).days||0;
    row.innerHTML=`<input type="text" data-id="${id}" data-field="name" value="${esc(t.name)}">
      <input type="number" min="0" data-id="${id}" data-field="duration" value="${dur}">
      <input type="number" min="0" max="100" data-id="${id}" data-field="pct" value="${t.pct||0}">
      <input type="text" data-id="${id}" data-field="phase" value="${esc(t.phase||'')}">
      <select data-id="${id}" data-field="subsystem">${SUBS.map(sub=>`<option${sub===t.subsystem?' selected':''}>${esc(sub)}</option>`).join('')}</select>
      <select data-id="${id}" data-field="active"><option value="true"${t.active!==false?' selected':''}>true</option><option value="false"${t.active===false?' selected':''}>false</option></select>`;
    box.appendChild(row);
  }
  box.querySelectorAll('input,select').forEach(inp=>{ inp.addEventListener('change',()=>{ const id=inp.dataset.id; const field=inp.dataset.field; let val=inp.value; if(field==='duration') val=parseInt(val,10)||0; else if(field==='active') val=(val==='true'); else if(field==='pct') val=Math.min(100, Math.max(0, parseInt(val,10)||0)); SM.updateTask(id,{[field]:val}); refresh(); }); });
}
function updateSelBadge(){ $('#selBadge').textContent = `${SEL.size} selected`; $('#bulkCount').textContent=String(SEL.size); $('#inlineCount') && ($('#inlineCount').textContent=String(SEL.size)); renderInlineEditor(); }
function applyBulk(){ if(SEL.size===0){ showToast('Select some tasks first'); return; } const s=SM.get(); const ids=new Set(SEL); let changed=0; for(const t of s.tasks){ if(!ids.has(t.id)) continue; changed++; const phase=$('#bulkPhase').value.trim(); if(phase) t.phase=phase; const sub=$('#bulkSub').value; if(sub) t.subsystem=sub; const act=$('#bulkActive').value; if(act!=='') t.active=(act==='true'); const pfx=$('#bulkPrefix').value||''; if(pfx) t.name=pfx+' '+(t.name||''); const addDep=$('#bulkAddDep').value.trim(); if(addDep){ t.deps=(t.deps||[]).concat([addDep]); }
    if($('#bulkClearDeps').checked) t.deps=[];
    const durV=$('#bulkDur').value; if(durV!==''){ const n=parseInt(durV,10)||0; if($('#bulkDurMode').value==='set') t.duration=n; else t.duration=Math.max(0, parseDurationStrict(t.duration).days + n); }
    const shift=$('#bulkShift').value; if(shift!==''){ const d=parseInt(shift,10)||0; const es = t.es||0; t.startConstraint = {type:'SNET', day: Math.max(0, es + d)}; }
    const pctV=$('#bulkPct').value; if(pctV!==''){ const n=Math.min(100, Math.max(0, parseInt(pctV,10)||0)); t.pct=n; }
  }
  SM.replaceTasks(s.tasks); showToast(`Bulk applied to ${changed} tasks`); refresh(); }

// ---------------------------- Templates/Libraries ----------------------------
function insertTemplate(which){ const lib = templateLib(which); const s=SM.get(); const base = slug(which)+'_'; const used=new Set(s.tasks.map(t=>t.id)); const toAdd=lib.map((t,i)=>{ let id = (t.id||uid('t')); if(used.has(id)) id = base + id; while(used.has(id)) id=base+uid('t'); used.add(id); return {...t, id}; });
  // remap deps if referencing ids in lib
  const mapOldToNew = new Map(lib.map((t,i)=>[t.id, toAdd[i].id]));
  toAdd.forEach((t,i)=>{ if(t.deps){ t.deps = t.deps.map(tok=>{ const e=parseDepToken(tok); if(!e) return tok; if(mapOldToNew.has(e.pred)) e.pred = mapOldToNew.get(e.pred); return stringifyDep(e); }); }
  });
  SM.addTasks(toAdd); showToast(`Inserted ${toAdd.length} tasks from ${which}`); }

// ---------------------------- UI orchestration ----------------------------
function setupLegend(){ const box=$('#subsysFilters'); box.innerHTML=''; SUBS.forEach(name=>{ const cls=slug(name).replace('_',''); const div=document.createElement('label'); div.className='tag'; div.innerHTML=`<input type="checkbox" checked value="${name}"><span class=\"dot ${cls}\" style="background:${colorFor(name)}"></span> ${name}`; box.appendChild(div); }); $('#btnSubAll').onclick=()=> $$('#subsysFilters input[type="checkbox"]').forEach(c=>c.checked=true);
  $('#btnSubNone').onclick=()=> $$('#subsysFilters input[type="checkbox"]').forEach(c=>c.checked=false); $$('#subsysFilters input[type="checkbox"]').forEach(c=> c.onchange=refresh); }
function parseHolidaysInput(){ const raw=$('#holidayInput').value||''; const tokens=raw.split(/[\s,]+/).filter(Boolean); const out=[]; for(const t of tokens){ const m=t.match(/^\d{4}-\d{2}-\d{2}$/); if(m){ out.push(t); } }
  return out; }

function refresh(){ const s=SM.get(); const cpm=computeCPM(s); renderGantt(s, cpm); renderGraph(s, cpm); renderFocus(s, cpm); renderIssues(s, cpm); $('#boot').style.display='none'; $('#appRoot').style.display='grid'; if($('.tab.active').dataset.tab==='compare') buildCompare(); }

function newProject(){ SM.set({startDate: todayStr(), calendar:'workdays', holidays:[], tasks:[]}); $('#startDate').value=todayStr(); $('#calendarMode').value='workdays'; $('#holidayInput').value=''; clearSelection(); refresh(); }

// ---------------------------- Boot ----------------------------
window.addEventListener('DOMContentLoaded', ()=>{
  try{
    $('#startDate').value = todayStr();
    setupLegend();
    // seed with sample HPC flow
    SM.set({startDate: todayStr(), calendar:'workdays', holidays:[], tasks: templateHPC()},{record:false});
    refresh();

    // reactive
    SM.onChange(()=>{ $('#btnUndo').disabled=!SM.canUndo(); $('#btnRedo').disabled=!SM.canRedo(); updateSelBadge(); });

    // tabs
    $$('.tab').forEach(t=> t.onclick=()=>{ $$('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active'); $$('.view').forEach(v=>v.classList.remove('active')); $('#'+t.dataset.tab).classList.add('active'); if(t.dataset.tab==='compare') buildCompare(); });

    // controls
    $('#slackThreshold').onchange = refresh;
    $('#calendarMode').onchange = ()=>{ SM.setProjectProps({calendar: $('#calendarMode').value}); refresh(); };
    $('#startDate').onchange = ()=>{ SM.setProjectProps({startDate: $('#startDate').value||todayStr()}); refresh(); };
    $('#holidayInput').onchange = ()=>{ SM.setProjectProps({holidays: parseHolidaysInput()}); refresh(); };
    $('#severityFilter').onchange = ()=>{ renderIssues(SM.get(), computeCPM(SM.get())); };
    $('#filterText').oninput = ()=>{ refresh(); };
    $('#groupBy').onchange = refresh;
    $('#btnFilterClear').onclick=()=>{ $('#filterText').value=''; $$('#subsysFilters input[type="checkbox"]').forEach(c=>c.checked=true); refresh(); };
    $('#btnSelectFiltered').onclick=()=>{ const cpm=computeCPM(SM.get()); computeCPM; const ids=new Set(cpm.tasks.filter(matchesFilters).map(t=>t.id)); ids.forEach(id=>SEL.add(id)); updateSelBadge(); refresh(); };
    $('#btnClearSel').onclick=()=>{ clearSelection(); refresh(); };

    // bulk
    $('#btnApplyBulk').onclick=applyBulk; $('#btnBulkReset').onclick=()=>{ ['bulkPhase','bulkSub','bulkActive','bulkDur','bulkDurMode','bulkPrefix','bulkPct','bulkAddDep','bulkClearDeps','bulkShift'].forEach(id=>{ const el=document.getElementById(id); if(!el) return; if(el.type==='checkbox') el.checked=false; else if(el.tagName==='SELECT') el.selectedIndex=0; else el.value=''; }); };

    // scenarios
    updateScenarioUI();
    $('#scenarioSelect') && ($('#scenarioSelect').onchange=(e)=>{ refresh(); });
    $('#btnScenarioNew') && ($('#btnScenarioNew').onclick=()=>{ const name=prompt('New scenario name'); if(!name) return; SC.saveAs(name); refresh(); });
    $('#btnScenarioSaveAs') && ($('#btnScenarioSaveAs').onclick=()=>{ const name=prompt('Save current asâ€¦'); if(!name) return; SC.saveAs(name); refresh(); });
    $('#btnScenarioBaseline') && ($('#btnScenarioBaseline').onclick=()=>{ const name=$('#scenarioSelect').value; if(!name) return; const cur=SC.getBaselines(); if(!cur.includes(name)) cur.push(name); SC.setBaselines(cur); buildCompare(); });
    $('#btnOpenCompare') && ($('#btnOpenCompare').onclick=()=>{ $$('.tab').forEach(x=>x.classList.remove('active')); $('[data-tab="compare"]').classList.add('active'); $$('.view').forEach(v=>v.classList.remove('active')); $('#compare').classList.add('active'); buildCompare(); });
    $('#btnSetBaseline').onclick=()=>{ const sel=$('#baselineSelect'); const vals=Array.from(sel.selectedOptions).map(o=>o.value); SC.setBaselines(vals); buildCompare(); };

    // I/O
    $('#btnExportCSV').onclick=exportCSV;
    $('#btnExportJSON').onclick=()=>{ const json=JSON.stringify(SM.get(), null, 2); const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([json],{type:'application/json'})); a.download='project.json'; a.click(); URL.revokeObjectURL(a.href); };
    $('#btnSave').onclick=()=> saveFile(JSON.stringify(SM.get(), null, 2));
    $('#btnLoad').onclick=async()=>{ const data=await openFile(); if(!data) return; SM.set({startDate:data.startDate||todayStr(), calendar:data.calendar||'workdays', holidays:data.holidays||[], tasks:ensureIds(data.tasks||[])}); $('#startDate').value=SM.get().startDate; $('#calendarMode').value=SM.get().calendar; $('#holidayInput').value=(SM.get().holidays||[]).join(', '); clearSelection(); refresh(); };
    $('#btnNew').onclick=newProject; $('#btnPrint').onclick=()=>window.print();

    // history
    $('#btnUndo').onclick=()=>{ SM.undo(); refresh(); };
    $('#btnRedo').onclick=()=>{ SM.redo(); refresh(); };
    window.addEventListener('keydown', (e)=>{
      const tag=(e.target.tagName||'').toLowerCase();
      if(e.target.isContentEditable || ['input','textarea','select'].includes(tag)) return;
      const k=e.key;
      if((e.ctrlKey||e.metaKey)&&!e.shiftKey && k.toLowerCase()==='z'){
        e.preventDefault(); SM.undo(); refresh();
      }else if((e.ctrlKey||e.metaKey) && (k.toLowerCase()==='y' || (e.shiftKey && k.toLowerCase()==='z'))){
        e.preventDefault(); SM.redo(); refresh();
      }else if(k==='Delete'){
        e.preventDefault(); deleteSelected();
      }else if((e.ctrlKey||e.metaKey) && k.toLowerCase()==='d'){
        e.preventDefault(); duplicateSelected();
      }else if(k==='ArrowDown' || k==='ArrowRight'){
        e.preventDefault(); moveSelection(1);
      }else if(k==='ArrowUp' || k==='ArrowLeft'){
        e.preventDefault(); moveSelection(-1);
      }
    });

    // Guide modal
    (function(){ let step=1; const max=5; const modal=$('#guided-workflow'); function showStep(){ for(let i=1;i<=max;i++){ $('#wz'+i).style.display = (i===step)?'block':'none'; } $('#wzPrev').disabled = step===1; $('#wzNext').textContent = step===max? 'Done' : 'Next'; }
      $('#wzPrev').onclick=()=>{ if(step>1) step--; showStep(); };
      $('#wzNext').onclick=()=>{ if(step<max) step++; else modal.style.display='none'; showStep(); };
    })();

    // Zoom/Pan controls
    ZTL=makeZoomPan($('#gantt')); const ZGR=makeZoomPan($('#graphSvg'));
    $('#zoomInTL').onclick=ZTL.zoomIn; $('#zoomOutTL').onclick=ZTL.zoomOut; $('#zoomResetTL').onclick=ZTL.fit;
    $('#zoomInGR').onclick=ZGR.zoomIn; $('#zoomOutGR').onclick=ZGR.zoomOut; $('#zoomResetGR').onclick=ZGR.fit;

    // Templates
    $('#btnInsertTpl').onclick=()=> insertTemplate($('#tplSelect').value);
    $('#ctxMenu').onclick=(e)=>{ const act=e.target.dataset.action; const id=$('#ctxMenu').dataset.id; hideContextMenu(); if(!id||!act) return; if(act==='edit'){ selectOnly(id); refresh(); const inp=$('#inlineEdit input'); inp&&inp.focus(); } else if(act==='duplicate'){ selectOnly(id); duplicateSelected(); } else if(act==='delete'){ selectOnly(id); deleteSelected(); } else if(act==='adddep'){ const tok=prompt('Dependency token (e.g. FS:pred+2d)'); if(tok){ const s=SM.get(); const t=s.tasks.find(x=>x.id===id); if(t){ t.deps=(t.deps||[]).concat([tok]); SM.replaceTasks(s.tasks); refresh(); } } } };

  }catch(err){
    console.error(err);
    const box=$('#fatal'); box.style.display='block'; box.textContent='Startup error:\n'+(err&&err.stack||String(err));
  }
});

// ---------------------------- Templates ----------------------------
function ensureIds(list){ return list.map(t=>({...t, id:t.id||uid('t'), active: t.active!==false})); }
function w(n){ return n*5; } function d(n){ return n; }
function templateHPC(){ return ensureIds([
  {id:'mobo_assembly', name:'Carte mÃ¨re assemblÃ©e (PCB+ASM)', duration:w(1), subsystem:'System', phase:'EVT L1'},
  {id:'mobo_bringup_air', name:'Bring-up carte mÃ¨re (Ã  air, pas de mÃ©ca)', duration:w(8), deps:['mobo_assembly'], subsystem:'power/VRM', phase:'EVT L1'},
  {id:'power_bringup_bench', name:'Bring-up power (banc)', duration:w(4), subsystem:'power/VRM', phase:'EVT L1'},
  {id:'power_full_load', name:'Power en puissance', duration:w(2), deps:['power_bringup_bench'], subsystem:'power/VRM', phase:'EVT L1'},
  {id:'power_rails_validated', name:'Power rails validÃ©s (gate)', duration:d(0), deps:['power_full_load'], subsystem:'power/VRM', phase:'EVT L1'},
  {id:'bringup_other_cards', name:'Bring-up autres cartes', duration:w(4), deps:['mobo_bringup_air'], subsystem:'System', phase:'EVT L1'},
  {id:'mech_deliveries', name:'Livraison mÃ©ca', duration:w(4), subsystem:'Mech', phase:'EVT L1'},
  {id:'first_blade_assembly', name:'1Ã¨re lame assembly & corrections mÃ©ca', duration:w(1), deps:['mech_deliveries','mobo_bringup_air','bringup_other_cards','power_full_load'], subsystem:'System', phase:'EVT L1'},
  {id:'remaining_blades_assembly', name:'Assemblage lames restantes (~5)', duration:w(2), deps:['first_blade_assembly'], subsystem:'System', phase:'EVT L1'},
  {id:'mech_lvl1_lab', name:'MÃ©ca L1 labo (WaterBox sans lame)', duration:w(1), deps:['mech_deliveries'], subsystem:'Mech', phase:'EVT L1'},
  {id:'blade_watercool_setup', name:'Setup water cooling', duration:w(1), deps:['remaining_blades_assembly','mech_lvl1_lab'], subsystem:'Thermal', phase:'EVT L2'},
  {id:'l2_integration_evt', name:'L2 tests (intÃ©gration lame)', duration:w(3), deps:['blade_watercool_setup'], subsystem:'System', phase:'EVT L2'},
  {id:'bmc_fw_evt', name:'Dev FW BMC (EVT)', duration:w(4), deps:['mobo_bringup_air'], subsystem:'BMC', phase:'EVT L2'},
  {id:'bios_dev_evt', name:'Dev BIOS (EVT)', duration:w(4), deps:['power_rails_validated','blade_watercool_setup'], subsystem:'BIOS', phase:'EVT L2'},
  {id:'sw_hal_evt', name:'Dev SW HAL (EVT 20j)', duration:d(20), deps:['blade_watercool_setup'], subsystem:'FW', phase:'EVT L2'},
  {id:'evt_done', name:'Fin EVT â†’ GreenLight DVT', duration:d(0), deps:['l2_integration_evt'], subsystem:'System', phase:'EVT'},
  {id:'make_15_blades', name:'PrÃ©parer ~15 lames DVT', duration:w(4), deps:['evt_done'], subsystem:'System', phase:'DVT L3'},
  {id:'fw_dev_dvt', name:'Dev FW (BMC/BIOS) continue', duration:w(4), deps:['make_15_blades'], subsystem:'FW', phase:'DVT L3'},
  {id:'l2_integration_dvt', name:'L2 intÃ©gration + interconnect (8w)', duration:w(8), deps:['make_15_blades'], subsystem:'System', phase:'DVT L3'},
  {id:'l1_thermal_cont', name:'L1 thermique (TC) continue', duration:w(4), deps:['make_15_blades'], subsystem:'Thermal', phase:'DVT L3'},
  {id:'sw_hal_dvt', name:'Dev SW HAL (DVT 60j)', duration:d(60), deps:['make_15_blades','sw_hal_evt'], subsystem:'FW', phase:'DVT L3'},
  {id:'l3_system_test', name:'L3 tests systÃ¨me (8w)', duration:w(8), deps:['l2_integration_dvt','fw_dev_dvt','sw_hal_dvt'], subsystem:'System', phase:'DVT L3'},
  {id:'blade_for_angers', name:'Lame pour Angers (usine)', duration:w(1), deps:['make_15_blades'], subsystem:'System', phase:'DVT L3'},
  {id:'dvt_done', name:'Fin DVT', duration:d(0), deps:['l3_system_test'], subsystem:'System', phase:'DVT'},
  {id:'transfer_factory', name:'Transfert Ã  Angers / CdP usine', duration:w(1), deps:['dvt_done'], subsystem:'System', phase:'PVT'},
  {id:'train_assembly', name:'Former montage lames', duration:w(1), deps:['transfer_factory'], subsystem:'System', phase:'PVT'},
  {id:'build_card_tester', name:'Construire testeur carte', duration:w(3), deps:['transfer_factory'], subsystem:'System', phase:'PVT'},
  {id:'pretest_bench', name:'Banc de prÃ©â€‘test mÃ©moire', duration:w(2), deps:['transfer_factory'], subsystem:'System', phase:'PVT'},
  {id:'pvt_launch_mfg', name:'Lancer MFG PVT (cartes + mÃ©ca)', duration:w(2), deps:['transfer_factory'], subsystem:'System', phase:'PVT'},
  {id:'parts_received', name:'RÃ©ception piÃ¨ces', duration:w(3), deps:['pvt_launch_mfg'], subsystem:'System', phase:'PVT'},
  {id:'mfg_process', name:'Process MFG (rampâ€‘up)', duration:w(4), deps:['parts_received'], subsystem:'System', phase:'PVT'},
  {id:'pvt_done', name:'Fin PVT', duration:d(0), deps:['mfg_process'], subsystem:'System', phase:'PVT'}
]); }

function templateLib(which){
  if(which==='hpc') return templateHPC();
  if(which==='sw') return ensureIds([
    {id:'sw_backlog', name:'Backlog grooming', duration:d(1), phase:'Sprintâ€‘0', subsystem:'System'},
    {id:'sw_planning', name:'Sprint planning', duration:d(1), deps:['sw_backlog'], phase:'Sprintâ€‘0', subsystem:'System'},
    {id:'sw_dev', name:'Development', duration:d(8), deps:['sw_planning'], phase:'Sprintâ€‘1', subsystem:'FW'},
    {id:'sw_ci', name:'CI & Code review', duration:d(2), deps:['sw_dev'], phase:'Sprintâ€‘1', subsystem:'FW'},
    {id:'sw_test', name:'Testing', duration:d(2), deps:['sw_ci'], phase:'Sprintâ€‘1', subsystem:'System'},
    {id:'sw_release', name:'Release & Retro', duration:d(1), deps:['sw_test'], phase:'Sprintâ€‘1', subsystem:'System'}
  ]);
  if(which==='hw') return ensureIds([
    {id:'schematic', name:'Schematic update', duration:w(2), subsystem:'System', phase:'SPIN'},
    {id:'layout', name:'PCB layout changes', duration:w(3), deps:['schematic'], subsystem:'System', phase:'SPIN'},
    {id:'fabrication', name:'Fabrication', duration:w(2), deps:['layout'], subsystem:'System', phase:'SPIN'},
    {id:'bringup', name:'Board bringâ€‘up', duration:w(3), deps:['fabrication'], subsystem:'power/VRM', phase:'BRINGUP'}
  ]);
  return [];
}

})();
</script>
<noscript>
  <div style="padding:1rem; color:#7f1d1d; background:#fef2f2; border:1px solid #fecaca; margin:1rem; border-radius:.6rem">
    This app needs JavaScript enabled.
  </div>
</noscript>
</body>
</html>
