<!--
  CHANGELOG:
  - Job A (Layout): Added a new sticky header and a responsive 3-column grid layout (Controls, Main, Context). Inventoried all DOM IDs. Created a backup of the original file.
  - Job B (Styling): Added a new <style> block with CSS custom properties for a high-contrast theme (light/dark modes) and consistent spacing. Improved accessibility with better focus rings and label associations.
  - Job C (Enhancements): Added a new <script> block to handle theme/density toggling with localStorage persistence. Implemented a graceful skeleton loading state that disappears when the main application is ready.
-->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>HPC/AI Project Planner â€” offline web app (Enhanced UI/UX)</title>
<script src="assets/js/theme-init.js"></script>
<link rel="stylesheet" href="assets/css/style.css">

</head>
<body>
<!--
  ID INVENTORY:
  stripes, critStripes, btnNew, btnLoad, btnSave, btnExportJSON, btnExportCSV, btnUndo, btnRedo,
  btnPrint, btnGuide, btnToggleTheme, selBadge, scenarioBadge, lastSavedBadge,
  boot, fatal, appRoot, startDate, startDateHelp, calendarMode, calendarModeHelp, holidayInput,
  holidayInputHelp, slackThreshold, slackThresholdHelp, filterText, groupBy, groupByHelp,
  btnFilterClear, btnSelectFiltered, btnClearSel, btnSubAll, btnSubNone, subsysFilters,
  inlineCount, inlineEdit, bulkCount, bulkPhase, bulkSub, bulkActive, bulkDur, bulkDurMode,
  bulkPrefix, bulkPct, bulkAddDep, bulkClearDeps, bulkShift, btnApplyBulk, btnBulkReset,
  tplSelect, btnInsertTpl, btnAutoFix, severityFilter, issues, zoomOutGR, zoomInGR, zoomResetGR,
  timeline, zoomOutTL, zoomInTL, zoomResetTL, gantt, gantt-accessible-summary, graph, graphSvg,
  focus, finishMetric, critMetric, countMetric, impactMetric, nearList, focusWarnings, compare,
  baselineSelect, btnUseBaseline, btnAddBaseline, cmpFinishA, cmpFinishB, cmpFinishDelta, cmpCritDelta, cmpList,
  hint, toast, ctxMenu, help-modal, helpModalTitle, guided-workflow, guideModalTitle,
  guideModalDescription, wz1, wz1Title, wz2, wz2Title, wz3, wz3Title, wz4, wz4Title, wz5,
  wz5Title, wzPrev, wzNext, arrow
-->
  <svg style="position:absolute;width:0;height:0;overflow:hidden" aria-hidden="true">
    <defs>
      <pattern id="stripes" patternUnits="userSpaceOnUse" width="6" height="6" patternTransform="rotate(45)">
        <rect width="6" height="6" class="stripes-bg"/>
        <line x1="0" y1="0" x2="0" y2="6" class="stripes-line" stroke-width="3"/>
      </pattern>
      <!-- Diagonal stripe pattern for critical tasks (works in dark/light) -->
      <pattern id="critStripes" width="6" height="6" patternUnits="userSpaceOnUse" patternTransform="rotate(45)">
        <rect width="6" height="6" fill="none"></rect>
        <path d="M 0 0 L 0 6" stroke="currentColor" stroke-width="2" />
      </pattern>
    </defs>
  </svg>
  <a href="#main-content" class="skip-link">Skip to main content</a>
  <header class="legacy-header">
    <div class="header-left">
      <h1>
        <span class="title-icon" aria-hidden="true">ğŸ“Š</span>
        HPC/AI Project Planner
        <small class="subtitle">â€” offline â€¢ single file</small>
      </h1>
    </div>
    
    <div class="header-center">
      <div class="toolbar-group">
        <h2 class="toolbar-heading">File</h2>
        <div class="button-group">
          <button class="btn" id="btnNew" aria-label="Create new project" title="Create new project">
            <span class="btn-icon" aria-hidden="true">âœ¨</span>
            <span class="sr-only">New</span>
          </button>
          <button class="btn" id="btnLoad" aria-label="Open existing project file" title="Open existing project file">
            <span class="btn-icon" aria-hidden="true">ğŸ“</span>
            <span class="sr-only">Openâ€¦</span>
          </button>
          <button class="btn" id="btnSave" aria-label="Save current project" title="Save current project">
            <span class="btn-icon" aria-hidden="true">ğŸ’¾</span>
            <span class="sr-only">Save</span>
          </button>
          <button class="btn" id="btnExportJSON" aria-label="Export project data as JSON" title="Export project data as JSON">
            <span class="btn-icon" aria-hidden="true">ğŸ“¤</span>
            <span class="sr-only">Export JSON</span>
          </button>
          <button class="btn" id="btnExportCSV" aria-label="Export project data as CSV" title="Export project data as CSV">
            <span class="btn-icon" aria-hidden="true">ğŸ“Š</span>
            <span class="sr-only">Export CSV</span>
          </button>
          <button class="btn" id="btnImportCSV" aria-label="Import project data from CSV" title="Import project data from CSV">
            <span class="btn-icon" aria-hidden="true">ğŸ“¥</span>
            <span class="sr-only">Import CSV</span>
          </button>
          <input type="file" id="csvImportInput" accept=".csv" style="display:none" />
        </div>
      </div>
      <div class="toolbar-group">
        <h2 class="toolbar-heading">Tools</h2>
        <div class="button-group">
        <button class="btn" id="btnUndo" title="Undo (Ctrl+Z)" aria-label="Undo last action">
            <span class="btn-icon" aria-hidden="true">â†¶</span>
            <span class="sr-only">Undo</span>
          </button>
        <button class="btn" id="btnRedo" title="Redo (Ctrl+Y)" aria-label="Redo last undone action">
            <span class="btn-icon" aria-hidden="true">â†·</span>
            <span class="sr-only">Redo</span>
          </button>
          <button class="btn accent" id="btnPrint" title="Print project or export as PDF" aria-label="Print project or export as PDF">
            <span class="btn-icon" aria-hidden="true">ğŸ–¨ï¸</span>
            <span class="sr-only">Print / PDF</span>
          </button>
          <button class="btn" id="btnGuide" aria-label="Show user guide and help" title="Show user guide and help">
            <span class="btn-icon" aria-hidden="true">â“</span>
            <span class="sr-only">Guide</span>
          </button>
          <button class="btn" id="btnToggleTheme" aria-label="Toggle dark mode" title="Toggle dark mode">
            <span class="btn-icon" aria-hidden="true">ğŸŒ™</span>
            <span class="sr-only">Theme</span>
          </button>
        </div>
      </div>
    </div>
    
    <div class="right">
      <div class="status-indicators">
        <span class="pill status-pill" id="cpmStatusBadge" style="display:none; background-color: var(--warn); color: white;"><span class="pill-icon" aria-hidden="true">â³</span>Calculatingâ€¦</span>
        <span class="pill status-pill" id="selBadge" role="status" aria-live="polite">
          <span class="pill-icon" aria-hidden="true">ğŸ¯</span>
          0 selected
        </span>
        <span class="pill status-pill" id="scenarioBadge" role="status" aria-live="polite">
          <span class="pill-icon" aria-hidden="true">âš™ï¸</span>
          Scenario: Working
        </span>
        <span class="pill status-pill" id="lastSavedBadge" role="status" aria-live="polite"></span>
      </div>
      
    </div>
  </header>

  <header id="new-header" class="app-header">
    <div class="header-left">
      <h1>HPC/AI Planner</h1>
    </div>
    <div class="header-center">
      <div class="toolbar" id="top-toolbar">
        <div class="toolbar-item">
          <button class="btn" id="btn-project-calendar" aria-haspopup="true" aria-expanded="false">Project Calendar</button>
          <div id="menu-project-calendar" class="action-menu" role="menu" style="display:none">
            <div class="row" style="flex-direction: column; align-items: flex-start;">
              <label for="startDate" class="label">
                <span class="label-icon" aria-hidden="true">ğŸ“…</span>
                Start date
              </label>
              <input type="date" id="startDate" class="form-input" aria-describedby="startDateHelp startDateError">
              <div id="startDateError" class="form-help error" style="display: none; margin-top: var(--space-1);"></div>
              <div id="startDateHelp" class="form-help">Use DD-MM-YYYY format. Arrow keys change day, Shift+arrow for week, Alt+arrow for month.</div>
            </div>
            <div class="row">
              <label for="calendarMode" class="label">
                <span class="label-icon" aria-hidden="true">ğŸ—“ï¸</span>
                Calendar
              </label>
              <select id="calendarMode" class="form-input" aria-describedby="calendarModeHelp">
                <option value="workdays">Working days (Monâ€“Fri + holidays)</option>
                <option value="calendar">Calendar days</option>
              </select>
              <div id="calendarModeHelp" class="sr-only">Choose between working days or calendar days for project scheduling</div>
            </div>
            <div class="row" style="align-items:flex-start">
              <label for="holidayInput" class="label full-width">
                <span class="label-icon" aria-hidden="true">ğŸ‰</span>
                Holidays (DDâ€‘MMâ€‘YYYY)
              </label>
              <textarea id="holidayInput" placeholder="01-01-2025, 01-05-2025, 25-12-2025" class="form-input" aria-describedby="holidayInputHelp"></textarea>
              <div id="holidayInputHelp" class="sr-only">Enter holiday dates in DD-MM-YYYY format, separated by commas</div>
            </div>
            <div class="row">
              <label for="slackThreshold" class="label">
                <span class="label-icon" aria-hidden="true">â°</span>
                Slack threshold
              </label>
              <input type="number" id="slackThreshold" min="0" value="2" class="form-input" aria-describedby="slackThresholdHelp"> days
              <div id="slackThresholdHelp" class="sr-only">Set the minimum slack threshold in days for highlighting critical paths</div>
            </div>
          </div>
        </div>

        <div class="toolbar-item">
          <button class="btn" id="btn-filter-group" aria-haspopup="true" aria-expanded="false">Filter &amp; Group</button>
          <div id="menu-filter-group" class="action-menu" role="menu" style="display:none">
            <div class="row">
              <label for="filterText" class="label sr-only">Filter</label>
              <div class="search-container">
                <span class="search-icon" aria-hidden="true">ğŸ”</span>
                <input type="text" id="filterText" placeholder="Filter by name or phaseâ€¦" class="form-input search-input" aria-label="Filter tasks by name or phase">
              </div>
            </div>
            <div class="row">
              <label for="groupBy" class="label">
                <span class="label-icon" aria-hidden="true">ğŸ“Š</span>
                Group by
              </label>
              <select id="groupBy" class="form-input" aria-describedby="groupByHelp">
                <option value="none">None</option>
                <option value="phase">Phase</option>
                <option value="subsystem">Subsystem</option>
              </select>
              <div id="groupByHelp" class="sr-only">Choose how to group and organize tasks in the display</div>
            </div>
            <div class="row filter-actions">
              <button class="btn small" id="btnFilterClear" aria-label="Clear all active filters"><span class="btn-icon" aria-hidden="true">ğŸ§¹</span>Clear filters</button>
              <button class="btn small" id="btnSelectFiltered" aria-label="Select all filtered tasks"><span class="btn-icon" aria-hidden="true">âœ…</span>Select filtered</button>
              <button class="btn small" id="btnClearSel" aria-label="Clear current task selection"><span class="btn-icon" aria-hidden="true">âŒ</span>Clear selection</button>
            </div>
          </div>
        </div>

        <div class="toolbar-item">
          <button class="btn" id="btn-subsystem-legend" aria-haspopup="true" aria-expanded="false">Subsystem Legend</button>
          <div id="menu-subsystem-legend" class="action-menu" role="menu" style="display:none">
            <div class="row subsystem-controls">
              <button class="btn small" id="btnSubAll"><span class="btn-icon">âœ…</span>Select All</button>
              <button class="btn small" id="btnSubNone"><span class="btn-icon">âŒ</span>Clear All</button>
            </div>
            <div class="subsys" id="subsysFilters"></div>
          </div>
        </div>

        <div class="toolbar-item">
          <button class="btn" id="btn-edit-selected" aria-haspopup="true" aria-expanded="false">Edit Selected</button>
          <div id="menu-edit-selected" class="action-menu" role="menu" style="display:none">
            <div class="inline-edit" id="inlineEdit"></div>
          </div>
        </div>

        <div class="toolbar-item">
          <button class="btn" id="btn-bulk-edit" aria-haspopup="true" aria-expanded="false">Bulk Edit</button>
          <div id="menu-bulk-edit" class="action-menu" role="menu" style="display:none">
            <div class="bulk">
              <div class="row-3 row">
                <label>Phase <input type="text" id="bulkPhase" placeholder="leave blank = skip"></label>
                <label>Subsystem
                  <select id="bulkSub">
                    <option value="">â€”</option>
                    <option>System</option><option>power/VRM</option><option>PCIe</option><option>BMC</option><option>BIOS</option><option>FW</option><option>Mech</option><option>Thermal</option>
                  </select>
                </label>
                <label>Active <select id="bulkActive"><option value="">â€”</option><option value="true">true</option><option value="false">false</option></select></label>
              </div>
              <div class="row-3 row">
                <label>Duration <input type="number" id="bulkDur" min="0" placeholder="e.g. 5"></label>
                <label>Mode
                  <select id="bulkDurMode"><option value="set">set</option><option value="add">+/-</option></select>
                </label>
                <label>Name prefix <input type="text" id="bulkPrefix" placeholder="e.g. [R1]"></label>
              </div>
              <div class="row">
                <label>Progress (%) <input type="number" id="bulkPct" min="0" max="100" placeholder="0"></label>
              </div>
              <div class="row">
                <label>Add dependency token <input type="text" id="bulkAddDep" placeholder="e.g. FS:mobo_assembly+2d"></label>
                <label><input type="checkbox" id="bulkClearDeps"> clear all deps</label>
              </div>
              <div class="row">
                <label>Shift with SNET (+/â€‘ days) <input type="number" id="bulkShift" placeholder="0"></label>
                <div style="display:flex; gap:.35rem"><button class="btn small" id="btnApplyBulk">Apply</button><button class="btn small" id="btnBulkReset">Reset fields</button></div>
              </div>
            </div>
          </div>
        </div>

        <div class="toolbar-item">
          <button class="btn" id="btn-template" aria-haspopup="true" aria-expanded="false">Template</button>
          <div id="menu-template" class="action-menu" role="menu" style="display:none">
            <div class="row">
              <label>Library
                <select id="tplSelect">
                  <option value="hpc">HPC Bringâ€‘up (sample)</option>
                  <option value="sw">Software Sprint (2â€‘week)</option>
                  <option value="hw">Board Spin Cycle</option>
                </select>
              </label>
            </div>
            <div class="row" style="gap:.4rem; flex-wrap:wrap">
              <button class="btn" id="btnInsertTpl">Insert library</button>
            </div>
          </div>
        </div>

        <div class="toolbar-item">
          <button class="btn" id="btn-validation" aria-haspopup="true" aria-expanded="false">Validation &amp; Warnings</button>
          <div id="menu-validation" class="action-menu" role="menu" style="display:none">
            <div class="row" style="justify-content:flex-start; gap:.5rem">
              <button class="btn small" id="btnAutoFix">Autoâ€‘fix common</button>
              <select id="severityFilter">
                <option value="all">Show: All</option>
                <option value="critical">Critical only</option>
                <option value="error">Errors &amp; up</option>
                <option value="warn">Warnings &amp; up</option>
                <option value="info">Info only</option>
              </select>
            </div>
            <div id="warning-badges"></div>
            <div class="issues" id="issues"></div>
          </div>
        </div>

        <div class="toolbar-item">
          <button class="btn" id="btn-legend" aria-haspopup="true" aria-expanded="false">Legend</button>
          <div id="menu-legend" class="action-menu" role="menu" style="display:none">
            <div class="p-sm" style="display: flex; flex-wrap: wrap; gap: var(--spacing-sm);">
              <span class="pill">Links: FS/SS/FF/SF + \+/- lag (d or w)</span>
              <span class="pill">Constraints: MSO / SNET</span>
              <span class="pill">Severities: info / warn / error / critical</span>
            </div>
          </div>
        </div>

      </div>
    </div>
    <div class="header-right">
      <button class="btn" id="toggle-theme">Theme</button>
      <button class="btn" id="toggle-density">Density</button>
      <button class="btn" id="btn-help" aria-label="Help">?</button>
      <button class="btn accent" id="primary-action" aria-haspopup="true" aria-controls="action-menu" aria-expanded="false">Action</button>
      <div id="action-menu" class="action-menu" role="menu" aria-labelledby="primary-action" style="display: none;">
        <button role="menuitem" class="menu-item" id="action-export-json">
          <span aria-hidden="true" style="margin-right: .5em;">ğŸ“¤</span> Export JSON
        </button>
        <button role="menuitem" class="menu-item" id="action-import-json">
          <span aria-hidden="true" style="margin-right: .5em;">ğŸ“¥</span> Import JSON
        </button>
        <button role="menuitem" class="menu-item" id="action-export-png">
          <span aria-hidden="true" style="margin-right: .5em;">ğŸ–¼ï¸</span> Export PNG
        </button>
        <hr role="separator" style="margin: 4px 0; border-color: var(--c-border, #D4D4D8);">
        <button role="menuitem" class="menu-item" id="action-reset-demo">
          <span aria-hidden="true" style="margin-right: .5em;">ğŸ”„</span> Reset Demo
        </button>
        <button role="menuitem" class="menu-item" id="action-toggle-theme">
          <span aria-hidden="true" style="margin-right: .5em;">ğŸ¨</span> Theme: Light/Dark
        </button>
      </div>
    </div>
  </header>

  <div id="boot">
    <div class="loading-container">
      <div class="loading-spinner" role="status" aria-label="Loading application"></div>
      <h2>Loading HPC/AI Project Planner</h2>
      <p>Initializing application components...</p>
      <div class="loading-tip">
        <span class="tip-icon" aria-hidden="true">ğŸ’¡</span>
        If this persists, press F12 â†’ Console and share any red error message.
      </div>
    </div>
  </div>
  <div id="fatal"></div>
  <div class="container grid" id="layout" style="display:grid">
    <section class="panel" id="main">
        <div class="kpis">
            <div class="kpi card" id="kpiCritical">Critical: 12</div>
            <div class="kpi card" id="kpiBlocked">Blocked: 3</div>
            <div class="kpi card" id="kpiMilestone">Next Milestone: 5d</div>
        </div>
        <main id="main-content" aria-label="Project planning workspace">
        <nav class="tabs" role="tablist" aria-label="Project views">
            <div class="tab active" data-tab="timeline" role="tab" aria-selected="true" aria-controls="timeline">Timeline</div>
            <div class="tab" data-tab="graph" role="tab" aria-selected="false" aria-controls="graph">Dependency Graph</div>
            <div class="tab" data-tab="focus" role="tab" aria-selected="false" aria-controls="focus">Where to focus</div>
            <div class="tab" data-tab="compare" role="tab" aria-selected="false" aria-controls="compare">Compare</div>
            <div class="tab" data-tab="tasks" role="tab" aria-controls="tasks">Tasks table</div>
            <div class="view-controls" style="margin-left: auto; display: flex; align-items: center; gap: var(--spacing-md);">
                <span style="margin-left:.5rem">Graph</span>
                <button class="btn small" id="zoomOutGR" aria-label="Zoom out graph">âˆ’</button>
                <button class="btn small" id="zoomInGR" aria-label="Zoom in graph">+</button>
                <button class="btn small" id="zoomResetGR" aria-label="Reset graph zoom">Fit</button>
            </div>
        </nav>
        <section id="timeline" class="view active" role="tabpanel" aria-label="Project timeline view" tabindex="0">
            <div class="floating-toolbar">
            <button class="btn small" id="zoomOutTL" aria-label="Zoom out timeline">âˆ’</button>
            <button class="btn small" id="zoomInTL" aria-label="Zoom in timeline">+</button>
            <button class="btn small" id="zoomResetTL" aria-label="Reset timeline zoom">Fit</button>
            </div>
            <svg id="gantt" class="gantt" role="img" aria-label="Project timeline" tabindex="0"></svg>
            <div id="gantt-accessible-summary" class="sr-only" aria-live="polite"></div>
        </section>
        <section id="graph" class="view" role="tabpanel" aria-label="Dependency graph view" tabindex="0">
            <svg id="graphSvg" role="img" aria-label="Dependency graph showing task relationships" tabindex="0"></svg>
        </section>
        <section id="focus" class="view" role="tabpanel" aria-label="Project focus and analysis view" tabindex="0">
            <div class="focus">
            <div class="focus-header">
                <h2><span class="section-icon" aria-hidden="true">ğŸ¯</span> Project Overview</h2>
                <p class="focus-description">Key metrics and areas requiring attention</p>
            </div>

            <div class="cards">
                <div class="card metric-card" role="region" aria-label="Planned finish date">
                <div class="card-icon" aria-hidden="true">ğŸ“…</div>
                <div class="card-content">
                    <div class="card-label">Planned Finish</div>
                    <div class="metric" id="finishMetric" aria-live="polite">â€”</div>
                </div>
                </div>
                <div class="card metric-card" role="region" aria-label="Critical tasks count">
                <div class="card-icon" aria-hidden="true">ğŸš¨</div>
                <div class="card-content">
                    <div class="card-label">Critical Tasks</div>
                    <div class="metric" id="critMetric" aria-live="polite">â€”</div>
                </div>
                </div>
                <div class="card metric-card" role="region" aria-label="Total tasks count">
                <div class="card-icon" aria-hidden="true">ğŸ“‹</div>
                <div class="card-content">
                    <div class="card-label">Total Tasks</div>
                    <div class="metric" id="countMetric" aria-live="polite">â€”</div>
                </div>
                </div>
                <div class="card metric-card" role="region" aria-label="Change impact assessment">
                <div class="card-icon" aria-hidden="true">âš¡</div>
                <div class="card-content">
                    <div class="card-label">Change Impact</div>
                    <div class="metric" id="impactMetric" aria-live="polite">â€”</div>
                </div>
                </div>
            </div>

            <div class="focus-section">
                <h3><span class="section-icon" aria-hidden="true">âš ï¸</span> Nearâ€‘critical (slack â‰¤ threshold)</h3>
                <div class="list" id="nearList" role="region" aria-label="Near-critical tasks list"></div>
            </div>

            <div class="focus-section">
                <h3><span class="section-icon" aria-hidden="true">ğŸ”</span> Open Warnings</h3>
                <div class="issues" id="focusWarnings" role="region" aria-label="Open warnings and issues"></div>
            </div>
            </div>
        </section>
        <section id="compare" class="view" role="tabpanel" aria-label="Project comparison view" tabindex="0">
            <div class="focus">
            <div class="row" style="gap:.5rem; align-items:center">
                <label>Baseline <select id="baselineSelect" aria-label="Select baseline project for comparison"></select></label>
                <button class="btn small" id="btnUseBaseline" aria-label="Use selected baseline for comparison">Use Selected</button>
                <button class="btn small" id="btnAddBaseline" aria-label="Save current project as new baseline">Save new baseline</button>
            </div>
            <div class="cards" style="margin-top:.5rem">
                <div class="card" role="region" aria-label="Baseline finish date"><div>Finish (baseline)</div><div class="metric" id="cmpFinishA" aria-live="polite">â€”</div></div>
                <div class="card" role="region" aria-label="Current finish date"><div>Finish (current)</div><div class="metric" id="cmpFinishB" aria-live="polite">â€”</div></div>
                <div class="card" role="region" aria-label="Finish date difference"><div>Î” days</div><div class="metric" id="cmpFinishDelta" aria-live="polite">â€”</div></div>
                <div class="card" role="region" aria-label="Critical path difference"><div>Critical Î” (count)</div><div class="metric" id="cmpCritDelta" aria-live="polite">â€”</div></div>
            </div>
            <h3>Task deltas (start / finish / slack)</h3>
            <div class="list" id="cmpList"></div>
            </div>
        </section>
        <section id="tasks" class="view" role="tabpanel" aria-label="Tasks table view" tabindex="0">
          <table class="table">
            <thead><tr>
              <th>ID</th><th>Name</th><th>Duration</th><th>Deps</th>
              <th>Subsystem</th><th>Phase</th><th>%</th><th>Critical</th><th>Milestone</th>
            </tr></thead>
            <tbody id="taskTableBody"></tbody>
          </table>
        </section>
        </main>
    </section>
    <aside class="panel" id="side" tabindex="-1">
      <h3>Context</h3>
      <div class="skeleton"></div>
    </aside>
  </div>

  <div class="hint" id="hint"></div>
  <div class="toast" id="toast"></div>
  <div class="ctx-menu" id="ctxMenu" role="menu" aria-label="Task actions menu">
    <div data-action="edit" role="menuitem" tabindex="0">Edit</div>
    <div data-action="duplicate" role="menuitem" tabindex="0">Duplicate</div>
    <div data-action="delete" role="menuitem" tabindex="0">Delete</div>
    <div data-action="adddep" role="menuitem" tabindex="0">Add dependency</div>
  </div>

  <div class="modal" id="help-modal" role="dialog" aria-labelledby="helpModalTitle" aria-hidden="true" style="z-index: 1001;">
    <div class="panel">
      <header style="justify-content: space-between;">
        <h1 id="helpModalTitle">Keyboard Shortcuts</h1>
        <button class="btn ghost" aria-label="Close help dialog" onclick="document.getElementById('help-modal').style.display = 'none';">Ã—</button>
      </header>
      <div class="p-lg" style="display: grid; grid-template-columns: auto 1fr; gap: var(--spacing-sm) var(--spacing-lg); align-items: center;">
        <kbd>Ctrl/Cmd + Z</kbd> <span>Undo last action</span>
        <kbd>Ctrl/Cmd + Y</kbd> <span>Redo last action</span>
        <kbd>Delete</kbd> <span>Delete selected tasks</span>
        <kbd>Ctrl/Cmd + D</kbd> <span>Duplicate selected tasks</span>
        <kbd>â†‘</kbd> / <kbd>â†“</kbd> <span>Navigate task list</span>
        <hr style="grid-column: 1 / -1; border-color: var(--line); margin: var(--spacing-sm) 0;">
        <kbd>Ctrl/Cmd + S</kbd> <span>Save Project</span>
        <kbd>Ctrl/Cmd + O</kbd> <span>Open Project</span>
        <kbd>Ctrl/Cmd + P</kbd> <span>Print / PDF</span>
        <hr style="grid-column: 1 / -1; border-color: var(--line); margin: var(--spacing-sm) 0;">
        <kbd>?</kbd> or <kbd>F1</kbd> <span>Show this help dialog</span>
      </div>
    </div>
  </div>

  <div class="modal" id="new-help-modal" role="dialog" aria-labelledby="newHelpModalTitle" aria-hidden="true" style="z-index: 1001; display: none;">
    <div class="panel">
      <header style="justify-content: space-between;">
        <h1 id="newHelpModalTitle">Help & Shortcuts</h1>
        <button class="btn ghost" aria-label="Close help dialog" onclick="document.getElementById('new-help-modal').style.display = 'none';">Ã—</button>
      </header>
      <div class="p-lg" style="display: grid; grid-template-columns: auto 1fr; gap: var(--spacing-sm) var(--spacing-lg); align-items: center;">
        <kbd>Ctrl/Cmd + Z</kbd> <span>Undo last action</span>
        <kbd>Ctrl/Cmd + Y</kbd> <span>Redo last action</span>
        <kbd>Delete</kbd> <span>Delete selected tasks</span>
        <kbd>Ctrl/Cmd + D</kbd> <span>Duplicate selected tasks</span>
        <kbd>â†‘</kbd> / <kbd>â†“</kbd> <span>Navigate task list</span>
        <hr style="grid-column: 1 / -1; border-color: var(--line); margin: var(--spacing-sm) 0;">
        <kbd>Ctrl + Mouse Wheel</kbd> <span>Zoom in/out</span>
        <kbd>Mouse Wheel</kbd> <span>Pan vertically</span>
        <kbd>Shift + Mouse Wheel</kbd> <span>Pan horizontally</span>
        <hr style="grid-column: 1 / -1; border-color: var(--line); margin: var(--spacing-sm) 0;">
        <kbd>?</kbd> or <kbd>F1</kbd> <span>Show this help dialog</span>
        <hr style="grid-column: 1 / -1; border-color: var(--line); margin: var(--spacing-sm) 0;">
        <div style="grid-column: 1 / -1; text-align: center;">
          <p>For more information, see the <a href="README.md" target="_blank">README</a> file.</p>
          <p>We welcome your feedback! Please <a href="https://github.com/user-repo/job-12-polish-docs/issues" target="_blank">open an issue</a> on our GitHub page.</p>
        </div>
      </div>
    </div>
  </div>

  <div id="guided-workflow" style="display: none; position: fixed; top: 20%; left: 20%; width: 60%; background: white; border: 1px solid #ccc; padding: 20px; z-index: 1000; box-shadow: 0 0 10px rgba(0,0,0,0.5);" aria-hidden="true" role="dialog" aria-labelledby="guideModalTitle" aria-describedby="guideModalDescription">
    <div class="panel">
      <header>
        <h1 id="guideModalTitle" style="font-size:1rem">Guided Workflow</h1>
        <div id="guideModalDescription" class="sr-only">Step-by-step guide to using the project planner</div>
      </header>
      <div class="wizard-step" id="wz1" role="tabpanel" aria-labelledby="wz1Title">
        <h3 id="wz1Title">1) Choose dates & calendar</h3>
        <p>Pick a start date and whether to use working days with holidays or calendar days.</p>
      </div>
      <div class="wizard-step" id="wz2" style="display:none" role="tabpanel" aria-labelledby="wz2Title">
        <h3 id="wz2Title">2) Import or insert a template</h3>
          <p>Use <b>Openâ€¦</b> to load JSON/CSV or choose a library from the toolbar and click <b>Insert library</b>.</p>
      </div>
      <div class="wizard-step" id="wz3" style="display:none" role="tabpanel" aria-labelledby="wz3Title">
        <h3 id="wz3Title">3) Wire dependencies</h3>
        <p>Use tokens like <code>FS:pred+2d</code>, <code>SS:pred</code> in the task editor (bulk add works too).</p>
      </div>
      <div class="wizard-step" id="wz4" style="display:none" role="tabpanel" aria-labelledby="wz4Title">
        <h3 id="wz4Title">4) Validate & iterate</h3>
        <p>Open <b>Validation & Warnings</b> to fix issues. Drag bars to adjust, or use bulk edit.</p>
      </div>
      <div class="wizard-step" id="wz5" style="display:none" role="tabpanel" aria-labelledby="wz5Title">
        <h3 id="wz5Title">5) Compare scenarios</h3>
        <p>Create scenarios and set a baseline. Use <b>Compare</b> to see deltas.</p>
      </div>
              <div class="wizard-controls">
          <button class="btn ghost" aria-label="Close guided workflow" onclick="document.getElementById('guided-workflow').style.display = 'none';">Close</button>
          <button class="btn" id="wzPrev" disabled aria-label="Go to previous step">Back</button>
          <button class="btn accent" id="wzNext" aria-label="Go to next step">Next</button>
        </div>
    </div>
  </div>

<noscript>
  <div style="padding:1rem; color:#7f1d1d; background:#fef2f2; border:1px solid #fecaca; margin:1rem; border-radius:.6rem">
    This app needs JavaScript enabled.
  </div>
</noscript>
<script defer src="assets/js/core/date-cal.js"></script>
<script defer src="assets/js/core/duration.js"></script>
<script defer src="assets/js/core/deps.js"></script>
<script defer src="assets/js/core/cpm.js"></script>
<script id="cpm-worker-src" type="text/plain">
'use strict';

// --- date-cal.js ---
/**
 * Parse a date in `dd-mm-yyyy` format.
 * @param {string} s
 * @returns {Date|null}
 */
function parseDate(s){
  const [d,m,y] = String(s||'').split('-').map(n=>parseInt(n,10));
  if(!d || !m || !y) return null;
  const dt = new Date(y, m-1, d);
  if(dt.getFullYear()!==y || dt.getMonth()!==m-1 || dt.getDate()!==d) return null;
  return dt;
}

/**
 * Format date as `dd-mm-yyyy`.
 * @param {Date} d
 * @returns {string}
 */
function fmtDate(d){ return [d.getDate().toString().padStart(2,'0'), (d.getMonth()+1).toString().padStart(2,'0'), d.getFullYear()].join('-'); }

/**
 * Convert `yyyy-mm-dd` to `dd-mm-yyyy`.
 * @param {string} s
 * @returns {string}
 */
function yyyymmdd_to_ddmmyyyy(s){ if (!s) return ''; const [y,m,d] = s.split('-'); return `${d}-${m}-${y}`; }

/**
 * Convert `dd-mm-yyyy` to `yyyy-mm-dd`.
 * @param {string} s
 * @returns {string}
 */
function ddmmyyyy_to_yyyymmdd(s){ if (!s) return ''; const [d,m,y] = s.split('-'); return `${y}-${m}-${d}`; }

/**
 * Add `n` days to a date.
 * @param {Date} date
 * @param {number} n
 * @returns {Date}
 */
function addDays(date, n){ const d=new Date(date); d.setDate(d.getDate()+n); return d; }

/**
 * Check if given date falls on weekend.
 * @param {Date} d
 * @returns {boolean}
 */
function isWeekend(d){ const x=d.getDay(); return x===0||x===6; }

/**
 * Difference in days between two dates.
 * @param {Date} a
 * @param {Date} b
 * @returns {number}
 */
function daysBetween(a,b){ return Math.round((b-a)/86400000); }

/**
 * @typedef {Object} Calendar
 * @property {'calendar'|'workdays'} mode
 * @property {(d:Date)=>boolean} isWorkday
 * @property {(start:Date,n:number)=>Date} add
 * @property {(start:Date,end:Date)=>number} diff
 */

/**
 * Build a calendar helper for adding/diffing business days.
 * @param {'calendar'|'workdays'} mode
 * @param {Set<string>} holidaysSet
 * @returns {Calendar}
 */
function makeCalendar(mode, holidaysSet){
  const isHoliday = d=> holidaysSet.has(fmtDate(d));
  function isWorkday(d){ return mode==='calendar'? true : (!isWeekend(d) && !isHoliday(d)); }
  function addBusinessDays(start, n){ let d=new Date(start); let step=n>=0?1:-1; let count=0; while(count!==n){ d.setDate(d.getDate()+step); if(isWorkday(d)) count+=step; } return d; }
  function diffBusinessDays(start, end){ let d=new Date(start); let n=0; const step=start<end?1:-1; while((step>0? d<end : d>end)){ d.setDate(d.getDate()+step); if(isWorkday(d)) n+=step; } return n; }
  return {
    mode,
    isWorkday,
    add:(start,n)=> mode==='calendar'? addDays(start,n): addBusinessDays(start,n),
    diff:(start,end)=> mode==='calendar'? daysBetween(start,end): diffBusinessDays(start,end)
  };
}

// --- duration.js ---
/**
 * @typedef {Object} DurationParseResult
 * @property {number} [days] - Duration in days when valid.
 * @property {string} [error] - Error message if parsing failed.
 */

/**
 * Parse a duration value expressed either as a number of days or a token like
 * "3w" (3 work weeks).
 *
 * @param {string|number} v - Raw duration value.
 * @returns {DurationParseResult}
 */
function parseDuration(v){
  if (typeof v === 'number') {
    if (!Number.isInteger(v) || v < 0) return { error: 'Duration must be a nonâ€‘negative integer (days).' };
    return { days: v };
  }
  const s = String(v || '').trim();
  if (s === '') return { error: 'Duration is required.' };
  const m = s.match(/^(\d+)\s*([dw])?$/i);
  if (!m) return { error: 'Use number of days or Nd/Nw (e.g., 10 or 3w).' };
  const n = parseInt(m[1], 10); const u = (m[2] || 'd').toLowerCase();
  if (n < 0) return { error: 'Duration cannot be negative.' };
  const days = u === 'w' ? n * 5 : n;
  return { days };
}

// --- deps.js ---
/**
 * @typedef {'FS'|'SS'|'FF'|'SF'} DepType
 *
 * @typedef {Object} ParsedDep
 * @property {DepType} type - Relationship type.
 * @property {string} pred - Predecessor task id.
 * @property {number} lag - Lag in days.
 */

/**
 * Parse a dependency token (e.g., `FS:task+2d`).
 * @param {string} token
 * @returns {ParsedDep|null}
 */
function parseDepToken(token){
  const s=String(token||'').trim(); if(!s) return null;
  let type='FS'; let rest=s; const colon=s.indexOf(':');
  if(colon>0){ const t=s.slice(0,colon).toUpperCase(); if(['FS','SS','FF','SF'].includes(t)){ type=t; rest=s.slice(colon+1); } }
  let pred=rest; let lag=0;
  const m = rest.match(/^(.*?)([+-])(\d+)([dw])?$/i);
  if(m){ pred=m[1]; const sign=m[2]==='-'?-1:1; const n=parseInt(m[3],10); const u=(m[4]||'d').toLowerCase(); lag = sign * (u==='w'? n*5 : n); }
  pred=pred.trim();
  return {type, pred, lag};
}

/**
 * Stringify a dependency edge.
 * @param {ParsedDep} e
 * @returns {string}
 */
function stringifyDep(e){ const lagStr = e.lag? ((e.lag>0?'+':'')+Math.round(e.lag)+'d') : ''; return (e.type==='FS' && !lagStr? e.pred : `${e.type}:${e.pred}${lagStr}`); }

/**
 * Normalize dependencies array from task into ParsedDep[]
 * @param {{deps?: string[]}} task
 * @returns {ParsedDep[]}
 */
function normalizeDeps(task){ const raw=task.deps||[]; const arr=[]; for(const tok of raw){ const p=parseDepToken(tok); if(!p) continue; arr.push(p); } return arr; }

// --- cpm.js ---
// --- CRITICAL PATH METHOD (CPM) ENGINE ---
function computeCPM(project){
  const cal = makeCalendar(project.calendar, new Set(project.holidays||[]));
  const active = project.tasks.filter(t=>t.active!==false);
  const id2 = Object.fromEntries(active.map(t=>[t.id,t]));

  const predMap = new Map(active.map(t=>[t.id, normalizeDeps(t).filter(e=>id2[e.pred]) ]));
  const succMap = new Map(active.map(t=>[t.id, []]));
  for(const [sid,edges] of predMap){
    for(const e of edges){
      if(!succMap.has(e.pred)) succMap.set(e.pred,[]);
      succMap.get(e.pred).push({to:sid, type:e.type, lag:e.lag});
    }
  }

  const indeg = new Map(active.map(t=>[t.id,0]));
  for(const [sid,edges] of predMap){
    for(const e of edges){ indeg.set(sid, (indeg.get(sid)||0)+1); }
  }
  const q=[]; for(const t of active){ if((indeg.get(t.id)||0)===0) q.push(t.id); }
  const order=[]; while(q.length){ const u=q.shift(); order.push(u); for(const arc of (succMap.get(u)||[])){ const v=arc.to; indeg.set(v, (indeg.get(v)||0)-1); if(indeg.get(v)===0) q.push(v); } }

  const usable=active.filter(t=>order.includes(t.id));

  const ES={}, EF={}; const warnings=[];
  for(const id of order){
    const t=id2[id]; if(!t) continue; const dur = parseDuration(t.duration).days||0; let baseES=0;
    for(const e of (predMap.get(id)||[])){
      const p=e.pred; const type=e.type; const lag=e.lag|0; const esP = ES[p]||0; const efP = EF[p]||0;
      if(type==='FS') baseES=Math.max(baseES, efP + lag);
      else if(type==='SS') baseES=Math.max(baseES, esP + lag);
      else if(type==='FF') baseES=Math.max(baseES, efP + lag - dur);
      else if(type==='SF') baseES=Math.max(baseES, esP + lag - dur);
    }
    const sc = t.startConstraint || (t.fixedStart!=null ? {type:'SNET', day:t.fixedStart|0} : null);
    if(sc){
      if(sc.type==='SNET') baseES = Math.max(baseES, sc.day|0);
      else if(sc.type==='MSO'){
        if(baseES > (sc.day|0)) warnings.push({sev:'error', msg:`MSO violated for ${t.name}: deps force start ${baseES} > ${sc.day}`, taskId:t.id});
        baseES = Math.max(baseES, sc.day|0);
      }
    }
    ES[id]=baseES; EF[id]=baseES + dur;
  }
  const projectFinish = Math.max(0, ...order.map(id=>EF[id]||0));

  const LF={}, LS={};
  const orderRev = order.slice().reverse();
  for(const id of orderRev){
    const t=id2[id]; if(!t) continue; const dur=parseDuration(t.duration).days||0; let baseLF = projectFinish; const succs = succMap.get(id)||[]; if(succs.length===0){ baseLF = projectFinish; }
      for(const arc of succs){ const s=arc.to; const type=arc.type; const lag=arc.lag|0; const lsS = LS[s]; const lfS = LF[s]; if(lsS==null || lfS==null) continue;
        if(type==='FS') baseLF = Math.min(baseLF, lsS - lag);
        else if(type==='SS') baseLF = Math.min(baseLF, (LS[id]==null? (lsS - lag) + dur : Math.min(LF[id]||Infinity, (lsS - lag) + dur) ));
        else if(type==='FF') baseLF = Math.min(baseLF, lfS - lag);
        else if(type==='SF') baseLF = Math.min(baseLF, (lfS - lag));
      }
      LF[id] = baseLF; LS[id] = baseLF - dur; }

  const out = usable.map(t=>({ ...t,
    es:ES[t.id]||0, ef:EF[t.id]||parseDuration(t.duration).days||0,
    ls:LS[t.id]||0, lf:LF[t.id]||parseDuration(t.duration).days||0,
    slack: (LS[t.id]??0)-(ES[t.id]??0),
    start: cal.add(parseDate(project.startDate), ES[t.id]||0),
    finish: cal.add(parseDate(project.startDate), EF[t.id]||0),
    critical: (LS[t.id]??0)===(ES[t.id]??0)
  }));

  return {order, tasks: out, finishDays: projectFinish, warnings};
}

// --- Worker message handler ---
self.onmessage = function(e) {
  if (e.data && e.data.type === 'compute') {
    const project = e.data.project;
    const cpmResult = computeCPM(project);
    self.postMessage({ type: 'result', cpm: cpmResult });
  }
};
</script>
<script defer src="assets/js/state/store.js"></script>
<script defer src="assets/js/import.js"></script>
<script defer src="assets/js/app.js"></script>
</body>
</html>
